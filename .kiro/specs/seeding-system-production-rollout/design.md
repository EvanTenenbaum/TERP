# Design Document: Seeding System Production Rollout

## Overview

This document outlines the production rollout plan for the TERP Database Seeding System (DATA-011). The system has been implemented and tested locally with all 7 table seeders working correctly. This rollout plan covers deployment verification, operational procedures, and legacy cleanup.

## Architecture

The seeding system is already deployed as part of the codebase. The rollout focuses on:

1. **Verification** - Confirming the system works in the DigitalOcean production environment
2. **Documentation** - Creating operational runbooks for production use
3. **Legacy Cleanup** - Deprecating old seeding code

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Production Rollout Flow                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
    ┌─────────────────────────────────┼─────────────────────────────────┐
    │                                 │                                 │
    ▼                                 ▼                                 ▼
┌─────────────┐             ┌─────────────────┐             ┌─────────────────┐
│   Phase 1   │             │     Phase 2     │             │     Phase 3     │
│ Verification│             │  Documentation  │             │  Legacy Cleanup │
└─────────────┘             └─────────────────┘             └─────────────────┘
    │                                 │                                 │
    ├── Dry-run test                  ├── Production runbook            ├── Deprecate SKIP_SEEDING
    ├── Small seed test               ├── Troubleshooting guide         ├── Archive old scripts
    └── Data validation               └── Rollback procedures           └── Update references
```

## Components and Interfaces

### Existing Components (Already Implemented)

| Component | Location | Purpose |
|-----------|----------|---------|
| CLI Orchestrator | `scripts/seed/seed-main.ts` | Main entry point with argument parsing |
| Database Locking | `scripts/seed/lib/locking.ts` | MySQL advisory locks for concurrency |
| Schema Validation | `scripts/seed/lib/validation.ts` | Validates data against schema |
| PII Masking | `scripts/seed/lib/data-masking.ts` | Anonymizes sensitive data |
| Structured Logging | `scripts/seed/lib/logging.ts` | JSON logging for operations |
| Table Seeders | `scripts/seed/seeders/*.ts` | Individual table seeding logic |

### New Components (To Be Created)

| Component | Location | Purpose |
|-----------|----------|---------|
| Production Runbook | `docs/deployment/SEEDING_RUNBOOK.md` | Step-by-step production guide |
| Deprecation Warnings | `server/services/seedDefaults.ts` | Warn about SKIP_SEEDING |

## Data Models

No new data models required. The seeding system uses existing schema tables:
- `vendors`, `clients`, `products`, `batches`, `orders`, `invoices`, `payments`

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: PII Masking Completeness
*For any* record with PII fields (email, phone, name, address) in non-production environment, the masker SHALL replace all PII values with fake data generated by Faker.js
**Validates: Requirements 2.2**

### Property 2: Record Count Accuracy
*For any* seeding operation, the reported record count per table SHALL equal the actual number of records inserted into the database
**Validates: Requirements 4.1**

### Property 3: Referential Integrity Preservation
*For any* seeded record with foreign key references, all referenced records SHALL exist in the parent tables
**Validates: Requirements 4.2**

## Error Handling

### Connection Errors
- **Symptom**: "Failed to connect to database after 3 attempts"
- **Cause**: DATABASE_URL not set or database unreachable
- **Resolution**: Verify DigitalOcean environment variables, check database status

### Lock Errors
- **Symptom**: "Another seeding operation is in progress"
- **Cause**: MySQL advisory lock held by another process
- **Resolution**: Wait for other operation to complete, or manually release lock

### Validation Errors
- **Symptom**: "Schema validation failed for [table]"
- **Cause**: Data structure doesn't match database schema
- **Resolution**: Check error details for specific field, verify column names

### FK Constraint Errors
- **Symptom**: "Cannot add or update a child row: a foreign key constraint fails"
- **Cause**: Referenced record doesn't exist
- **Resolution**: Use `--clean` flag to clear and reseed in correct order

## Testing Strategy

### Dual Testing Approach

**Unit Tests**: Verify specific examples and edge cases
- Connection handling
- Argument parsing
- Error message formatting

**Property-Based Tests**: Verify universal properties
- PII masking completeness (Property 1)
- Record count accuracy (Property 2)
- Referential integrity (Property 3)

### Property-Based Testing Library
Use **fast-check** for TypeScript property-based testing.

### Test Annotations
Each property-based test MUST include:
```typescript
// **Feature: seeding-system-production-rollout, Property 1: PII Masking Completeness**
// **Validates: Requirements 2.2**
```

### Production Verification Tests

| Test | Command | Expected Result |
|------|---------|-----------------|
| Dry Run | `pnpm seed:new --dry-run` | Shows preview, no data changes |
| Small Seed | `pnpm seed:new --clean --size=small --force` | 195 records in 7 tables |
| Single Table | `pnpm seed:new --table=clients --clean --force` | 10 client records |
| Data Validation | Query each table | Records exist with valid FK refs |

## Production Rollout Phases

### Phase 1: Verification (30 minutes)

1. **Connect to DigitalOcean Console**
   ```bash
   # Option 1: Via DigitalOcean Console UI
   # Navigate to: Apps → terp-app → Console → Run Command
   
   # Option 2: Via doctl CLI
   doctl apps console <APP_ID>
   ```

2. **Run Dry-Run Test**
   ```bash
   pnpm seed:new --dry-run --size=small
   ```
   Expected: Preview shows 7 tables, no errors

3. **Run Small Seed Test**
   ```bash
   pnpm seed:new --clean --size=small --force
   ```
   Expected: 195 records inserted, 0 errors

4. **Verify Data Quality**
   ```sql
   -- Run via DigitalOcean Database console or MySQL client
   SELECT 'vendors' as tbl, COUNT(*) as cnt FROM vendors
   UNION ALL SELECT 'clients', COUNT(*) FROM clients
   UNION ALL SELECT 'products', COUNT(*) FROM products
   UNION ALL SELECT 'batches', COUNT(*) FROM batches
   UNION ALL SELECT 'orders', COUNT(*) FROM orders
   UNION ALL SELECT 'invoices', COUNT(*) FROM invoices
   UNION ALL SELECT 'payments', COUNT(*) FROM payments;
   -- Expected: vendors=5, clients=10, products=20, batches=30, orders=50, invoices=50, payments=30
   
   -- Verify FK integrity (orders reference valid clients)
   SELECT COUNT(*) as orphaned_orders 
   FROM orders o 
   LEFT JOIN clients c ON o.client_id = c.id 
   WHERE c.id IS NULL;
   -- Expected: 0
   
   -- Verify PII is masked (should see fake data)
   SELECT name, email FROM clients LIMIT 3;
   -- Expected: Faker-generated names/emails
   ```

5. **Test Application**
   - Navigate to https://terp-app-b9s35.ondigitalocean.app
   - Verify clients page loads with seeded data (10 clients)
   - Verify orders page shows seeded orders (50 orders)
   - Verify vendors page shows seeded vendors (5 vendors)
   - Open browser DevTools → Console, verify no errors
   
6. **Health Check**
   ```bash
   curl https://terp-app-b9s35.ondigitalocean.app/health
   # Expected: {"status":"healthy",...}
   ```

### Phase 2: Documentation (1 hour)

1. **Create Production Runbook**
   - Location: `docs/deployment/SEEDING_RUNBOOK.md`
   - Contents: Step-by-step seeding procedures
   - Include: Troubleshooting, rollback, monitoring

2. **Update README**
   - Add production seeding section to `scripts/seed/README.md`
   - Document DigitalOcean-specific considerations

### Phase 3: Legacy Cleanup (30 minutes)

1. **Add Deprecation Warnings**
   - Files: `server/services/seedDefaults.ts`, `server/_core/index.ts`
   - Warning: "SKIP_SEEDING is deprecated. Use pnpm seed:new instead."

2. **Archive Legacy Scripts**
   - Move `scripts/seed-realistic-main.ts` to `scripts/legacy/`
   - Update any references

3. **Update Documentation**
   - Remove references to old seeding system
   - Point all docs to new system

## Rollback Procedures

### If Seeding Fails Mid-Operation

```bash
# Clear all seeded data and start fresh
pnpm seed:new --clean --size=small --force
```

### If Application Breaks After Seeding

```bash
# Connect to DigitalOcean Database console or use MySQL client
# Clear seeded data (reverse FK order)
DELETE FROM payments;
DELETE FROM invoices;
DELETE FROM orders;
DELETE FROM batches;
DELETE FROM products;
DELETE FROM clients;
DELETE FROM vendors;
```

### If Lock Gets Stuck

```sql
-- Check lock status
SELECT IS_USED_LOCK('terp_seeding_global');

-- Release lock manually
SELECT RELEASE_LOCK('terp_seeding_global');
```

## Monitoring

### During Seeding

Watch the console output for:
- Progress indicators (1/7, 2/7, etc.)
- Record counts per table
- Any validation warnings
- Final summary with total records and errors

### After Seeding

1. **Check Application Health**
   ```bash
   curl https://terp-app-b9s35.ondigitalocean.app/health
   ```

2. **Verify Data in UI**
   - Navigate to Clients page
   - Navigate to Orders page
   - Check for any loading errors

3. **Check DigitalOcean Logs**
   ```bash
   # Via doctl CLI
   doctl apps logs <APP_ID> --type run
   
   # Or via DigitalOcean Console: Apps → terp-app → Runtime Logs
   ```
   - Look for any runtime errors
   - Verify no database connection issues

## Success Criteria

- [ ] Dry-run completes without errors
- [ ] Small seed inserts 195 records across 7 tables
- [ ] Application loads correctly with seeded data
- [ ] No FK constraint violations
- [ ] PII masking audit shows masked fields
- [ ] Production runbook created
- [ ] Legacy SKIP_SEEDING deprecated with warnings
- [ ] Old scripts archived
