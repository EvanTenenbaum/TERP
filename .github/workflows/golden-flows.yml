name: Golden Flows E2E

on:
  pull_request:
    branches: [main]
    paths:
      - "tests-e2e/golden-flows/**"
      - "tests-e2e/fixtures/**"
      - "tests-e2e/utils/**"
      - "playwright.config.ts"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/golden-flows.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  golden-flows:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_BASE_URL: https://terp-app-b9s35.ondigitalocean.app
      CI: true

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run Golden Flow E2E tests
        id: golden_flows
        run: |
          set +e
          pnpm playwright test tests-e2e/golden-flows/ 2>&1 | tee golden-flows-output.txt
          EXIT_CODE=$?
          set -e
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          exit $EXIT_CODE

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-flows-playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload Golden Flow logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-flows-output
          path: golden-flows-output.txt
          retention-days: 14

      - name: Post PR summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.golden_flows.outputs.status }}' || 'failed';
            const summary = status === 'passed'
              ? '✅ Golden Flow E2E tests passed.'
              : '❌ Golden Flow E2E tests failed. Please review the Playwright report.';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Golden Flows E2E\n\n${summary}`
            });

      - name: Write step summary
        if: always()
        run: |
          echo "## Golden Flows E2E" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ steps.golden_flows.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "Base URL: $PLAYWRIGHT_BASE_URL" >> $GITHUB_STEP_SUMMARY
