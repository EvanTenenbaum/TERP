name: Add Secrets to GitHub Secrets

# Workflow to add secrets to GitHub Secrets from environment variables
# Can be triggered manually from anywhere, not just local machine
# Secrets can be provided as workflow inputs (they're masked in logs)

on:
  workflow_dispatch:
    inputs:
      # Service secrets
      jwt_secret:
        description: 'JWT_SECRET value'
        required: false
        type: string
      clerk_secret_key:
        description: 'CLERK_SECRET_KEY value'
        required: false
        type: string
      clerk_publishable_key:
        description: 'CLERK_PUBLISHABLE_KEY value'
        required: false
        type: string
      database_url:
        description: 'DATABASE_URL value'
        required: false
        type: string
      github_webhook_secret:
        description: 'GITHUB_WEBHOOK_SECRET value'
        required: false
        type: string
      
      # Monitoring secrets
      solarwinds_token:
        description: 'SOLARWINDS_TOKEN value'
        required: false
        type: string
      sentry_dsn:
        description: 'SENTRY_DSN value'
        required: false
        type: string
      vite_sentry_dsn:
        description: 'VITE_SENTRY_DSN value'
        required: false
        type: string
      
      # Worker secrets
      slack_bot_token:
        description: 'SLACK_BOT_TOKEN value'
        required: false
        type: string
      slack_app_token:
        description: 'SLACK_APP_TOKEN value'
        required: false
        type: string
      github_token:
        description: 'GITHUB_TOKEN value'
        required: false
        type: string
      gemini_api_key:
        description: 'GEMINI_API_KEY value'
        required: false
        type: string
      digitalocean_token:
        description: 'DIGITALOCEAN_TOKEN value'
        required: false
        type: string
      
      # Option to read from existing secrets file in repo (if exists)
      use_existing:
        description: 'Use existing secrets from deployment_details.json (if available)'
        required: false
        type: boolean
        default: false

permissions:
  secrets: write
  contents: read

jobs:
  add-secrets:
    runs-on: ubuntu-latest
    if: github.repository == 'EvanTenenbaum/TERP'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        run: |
          gh --version || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && sudo apt update && sudo apt install gh -y)
      
      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
      
      - name: Add secrets from workflow inputs
        if: inputs.use_existing == false
        run: |
          echo "üìã Adding secrets from workflow inputs..."
          
          # Service secrets
          if [ -n "${{ inputs.jwt_secret }}" ]; then
            echo "${{ inputs.jwt_secret }}" | gh secret set JWT_SECRET --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set JWT_SECRET"
          fi
          
          if [ -n "${{ inputs.clerk_secret_key }}" ]; then
            echo "${{ inputs.clerk_secret_key }}" | gh secret set CLERK_SECRET_KEY --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set CLERK_SECRET_KEY"
          fi
          
          if [ -n "${{ inputs.clerk_publishable_key }}" ]; then
            echo "${{ inputs.clerk_publishable_key }}" | gh secret set CLERK_PUBLISHABLE_KEY --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set CLERK_PUBLISHABLE_KEY"
          fi
          
          if [ -n "${{ inputs.database_url }}" ]; then
            echo "${{ inputs.database_url }}" | gh secret set DATABASE_URL --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set DATABASE_URL"
          fi
          
          if [ -n "${{ inputs.github_webhook_secret }}" ]; then
            echo "${{ inputs.github_webhook_secret }}" | gh secret set GITHUB_WEBHOOK_SECRET --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set GITHUB_WEBHOOK_SECRET"
          fi
          
          # Monitoring secrets
          if [ -n "${{ inputs.solarwinds_token }}" ]; then
            echo "${{ inputs.solarwinds_token }}" | gh secret set SOLARWINDS_TOKEN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set SOLARWINDS_TOKEN"
          fi
          
          if [ -n "${{ inputs.sentry_dsn }}" ]; then
            echo "${{ inputs.sentry_dsn }}" | gh secret set SENTRY_DSN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set SENTRY_DSN"
          fi
          
          if [ -n "${{ inputs.vite_sentry_dsn }}" ]; then
            echo "${{ inputs.vite_sentry_dsn }}" | gh secret set VITE_SENTRY_DSN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set VITE_SENTRY_DSN"
          fi
          
          # Worker secrets
          if [ -n "${{ inputs.slack_bot_token }}" ]; then
            echo "${{ inputs.slack_bot_token }}" | gh secret set SLACK_BOT_TOKEN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set SLACK_BOT_TOKEN"
          fi
          
          if [ -n "${{ inputs.slack_app_token }}" ]; then
            echo "${{ inputs.slack_app_token }}" | gh secret set SLACK_APP_TOKEN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set SLACK_APP_TOKEN"
          fi
          
          if [ -n "${{ inputs.github_token }}" ]; then
            echo "${{ inputs.github_token }}" | gh secret set GITHUB_TOKEN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set GITHUB_TOKEN"
          fi
          
          if [ -n "${{ inputs.gemini_api_key }}" ]; then
            echo "${{ inputs.gemini_api_key }}" | gh secret set GEMINI_API_KEY --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set GEMINI_API_KEY"
          fi
          
          if [ -n "${{ inputs.digitalocean_token }}" ]; then
            echo "${{ inputs.digitalocean_token }}" | gh secret set DIGITALOCEAN_TOKEN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "${{ inputs.digitalocean_token }}" | gh secret set DIGITALOCEAN_ACCESS_TOKEN --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set DIGITALOCEAN_TOKEN and DIGITALOCEAN_ACCESS_TOKEN"
          fi
          
          echo ""
          echo "‚úÖ All secrets added!"
      
      - name: Read secrets from deployment_details.json (if use_existing is true)
        if: inputs.use_existing == true && hashFiles('deployment_details.json') != ''
        run: |
          echo "üìã Reading secrets from deployment_details.json..."
          # This would parse the JSON and add secrets
          # For now, this is a placeholder - you'd need jq installed
          echo "‚ö†Ô∏è  Reading from JSON not yet implemented - use workflow inputs instead"

