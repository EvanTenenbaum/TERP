name: Pre-Merge Quality Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Task ID
        id: extract_task
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ $BRANCH_NAME =~ ^claude/([A-Z]+-([0-9]+|[0-9]{8}-[0-9]{3}))-[0-9]{8}- ]]; then
            echo "task_id=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "task_id=" >> $GITHUB_OUTPUT
          fi

      # =================================================================
      # SECURITY PATTERN ENFORCEMENT
      # =================================================================
      - name: Check for Forbidden Security Patterns
        id: security_check
        run: |
          VIOLATIONS=""

          # Pattern 1: Fallback user ID (BUG-PATTERN: POST-002)
          # Matches: ctx.user?.id || 1, ctx.user?.id ?? 1, etc.
          FALLBACK_MATCHES=$(grep -rn "ctx\.user\?\.\(id\|userId\)\s*\(||\|??\)\s*[0-9]" --include="*.ts" --include="*.tsx" server/ client/src/ 2>/dev/null || true)
          if [ -n "$FALLBACK_MATCHES" ]; then
            VIOLATIONS="${VIOLATIONS}### ❌ Fallback User ID Pattern\n\nFound forbidden pattern \`ctx.user?.id || 1\`. Use \`getAuthenticatedUserId(ctx)\` instead.\n\n\`\`\`\n${FALLBACK_MATCHES}\n\`\`\`\n\n"
          fi

          # Pattern 2: Actor from input (BUG-PATTERN: POST-003)
          # Matches: input.createdBy, input.updatedBy as actor source
          ACTOR_INPUT=$(grep -rn "createdBy:\s*input\.\(createdBy\|userId\)" --include="*.ts" server/routers/ 2>/dev/null || true)
          if [ -n "$ACTOR_INPUT" ]; then
            VIOLATIONS="${VIOLATIONS}### ❌ Actor Attribution from Input\n\nFound \`createdBy: input.createdBy\` - actor must come from \`ctx.user.id\`, not input.\n\n\`\`\`\n${ACTOR_INPUT}\n\`\`\`\n\n"
          fi

          # Pattern 3: Hard deletes (use soft delete with deletedAt)
          HARD_DELETE=$(grep -rn "\.delete(" --include="*.ts" server/routers/ | grep -v "deletedAt" | grep -v "test" | grep -v "\.d\.ts" 2>/dev/null | head -5 || true)
          if [ -n "$HARD_DELETE" ]; then
            VIOLATIONS="${VIOLATIONS}### ⚠️ Potential Hard Delete\n\nFound \`.delete()\` calls. Prefer soft deletes with \`deletedAt\` for data integrity.\n\n\`\`\`\n${HARD_DELETE}\n\`\`\`\n\n"
          fi

          # Save violations for comment
          if [ -n "$VIOLATIONS" ]; then
            echo "has_violations=true" >> $GITHUB_OUTPUT
            # Escape for GitHub Actions
            VIOLATIONS="${VIOLATIONS//'%'/'%25'}"
            VIOLATIONS="${VIOLATIONS//$'\n'/'%0A'}"
            VIOLATIONS="${VIOLATIONS//$'\r'/'%0D'}"
            echo "violations=${VIOLATIONS}" >> $GITHUB_OUTPUT
          else
            echo "has_violations=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for Hotfix Bypass
        id: check_hotfix
        run: |
          if [[ "${{ github.event.pull_request.title }}" == *"[HOTFIX]"* ]]; then
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
          else
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Test Status
        id: check_status
        run: |
          TASK_ID="${{ steps.extract_task.outputs.task_id }}"
          if [ -z "$TASK_ID" ]; then
            echo "status=no_task_id" >> $GITHUB_OUTPUT
            exit 0
          fi

          ROADMAP_FILE=""
          if grep -q "${TASK_ID}" docs/roadmaps/MASTER_ROADMAP.md; then
            ROADMAP_FILE="docs/roadmaps/MASTER_ROADMAP.md"
          elif grep -q "${TASK_ID}" docs/roadmaps/TESTING_ROADMAP.md; then
            echo "status=testing_task" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          TASK_LINE=$(grep "${TASK_ID}" "$ROADMAP_FILE")
          if echo "$TASK_LINE" | grep -q "Test Status: ✅ Fully Tested"; then
            echo "status=fully_tested" >> $GITHUB_OUTPUT
          elif echo "$TASK_LINE" | grep -q "Test Status: ⚪ Untested"; then
            echo "status=untested" >> $GITHUB_OUTPUT
          else
            echo "status=no_status_field" >> $GITHUB_OUTPUT
          fi

      - name: Post Status Comment
        uses: actions/github-script@v7
        with:
          script: |
            const isHotfix = '${{ steps.check_hotfix.outputs.is_hotfix }}' === 'true';
            const status = '${{ steps.check_status.outputs.status }}';
            const taskId = '${{ steps.extract_task.outputs.task_id }}';
            const hasViolations = '${{ steps.security_check.outputs.has_violations }}' === 'true';
            const violations = decodeURIComponent('${{ steps.security_check.outputs.violations }}' || '');

            let sections = [];

            // Security section (BLOCKING if violations found)
            if (hasViolations) {
              sections.push(`## ❌ Security Pattern Violations\n\n${violations}\n\n**This PR will be blocked until these patterns are fixed.**`);
            } else {
              sections.push(`## ✅ Security Patterns\n\nNo forbidden security patterns detected.`);
            }

            // Roadmap section (advisory)
            let roadmapSummary = "";
            if (isHotfix) {
              roadmapSummary = "✅ **Hotfix Bypass:** Roadmap checks bypassed.";
            } else if (status === 'fully_tested' || status === 'testing_task') {
              roadmapSummary = "✅ **PASS:** Feature is fully tested or is a testing task.";
            } else if (status === 'untested') {
              roadmapSummary = "⚠️ **WARNING:** Feature is untested. Consider adding tests.";
            } else if (status === 'no_task_id') {
              roadmapSummary = "⚠️ **INFO:** Could not extract Task ID from branch name.";
            } else if (status === 'not_found') {
              roadmapSummary = `⚠️ **INFO:** Task ${taskId} not found in roadmap.`;
            } else {
              roadmapSummary = `⚠️ **INFO:** Test status unknown. Proceed with review.`;
            }
            sections.push(`## Roadmap Status\n\n${roadmapSummary}`);

            const body = `# Pre-Merge Quality Gate\n\n${sections.join('\n\n---\n\n')}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: body
            });

      # Block merge if security violations found
      - name: Block on Security Violations
        if: steps.security_check.outputs.has_violations == 'true' && steps.check_hotfix.outputs.is_hotfix != 'true'
        run: |
          echo "❌ Security pattern violations detected. PR blocked."
          echo "Fix the patterns listed in the PR comment before merging."
          exit 1
