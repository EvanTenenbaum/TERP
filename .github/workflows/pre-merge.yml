name: Pre-Merge Quality Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ================================================================
  # JOB 1: Fast checks â€” always runs, no DB needed (~2 min)
  # ================================================================
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142  # v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Task ID
        id: extract_task
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ $BRANCH_NAME =~ ^claude/([A-Z]+-([0-9]+|[0-9]{8}-[0-9]{3}))-[0-9]{8}- ]]; then
            echo "task_id=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "task_id=" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------------
      # SECURITY PATTERN ENFORCEMENT (Only checks CHANGED files)
      # ---------------------------------------------------------------
      - name: Get Changed Files
        id: changed_files
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD -- '*.ts' '*.tsx' 2>/dev/null || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Also get ALL changed files (not just TS) for domain mapping
          ALL_CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null || true)
          echo "all_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for Forbidden Security Patterns
        id: security_check
        run: |
          VIOLATIONS=""
          CHANGED_FILES="${{ steps.changed_files.outputs.files }}"

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_violations=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Pattern 1: Fallback user ID (BUG-PATTERN: POST-002)
          FALLBACK_MATCHES=""
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              MATCH=$(grep -n -E "ctx\.user\??\.(id|userId)\s*(\|\||\?\?)\s*[0-9]" "$file" 2>/dev/null || true)
              if [ -n "$MATCH" ]; then
                FALLBACK_MATCHES="${FALLBACK_MATCHES}${file}:${MATCH}\n"
              fi
            fi
          done
          if [ -n "$FALLBACK_MATCHES" ]; then
            MSG="### âŒ Fallback User ID Pattern\n\n"
            MSG+="Found forbidden pattern \`ctx.user?.id || 1\`. "
            MSG+="Use \`getAuthenticatedUserId(ctx)\` instead.\n\n"
            MSG+="\`\`\`\n${FALLBACK_MATCHES}\`\`\`\n\n"
            VIOLATIONS="${VIOLATIONS}${MSG}"
          fi

          # Pattern 2: Actor from input (BUG-PATTERN: POST-003)
          ACTOR_INPUT=""
          for file in $CHANGED_FILES; do
            if [[ "$file" == server/routers/* ]] && [ -f "$file" ]; then
              MATCH=$(grep -n "createdBy: input\." "$file" 2>/dev/null || true)
              if [ -n "$MATCH" ]; then
                ACTOR_INPUT="${ACTOR_INPUT}${file}:${MATCH}\n"
              fi
            fi
          done
          if [ -n "$ACTOR_INPUT" ]; then
            VIOLATIONS="${VIOLATIONS}### âŒ Actor Attribution from Input\n\nFound \`createdBy: input.createdBy\` - actor must come from \`ctx.user.id\`, not input.\n\n\`\`\`\n${ACTOR_INPUT}\`\`\`\n\n"
          fi

          if [ -n "$VIOLATIONS" ]; then
            echo "has_violations=true" >> $GITHUB_OUTPUT
            VIOLATIONS="${VIOLATIONS//'%'/'%25'}"
            VIOLATIONS="${VIOLATIONS//$'\n'/'%0A'}"
            VIOLATIONS="${VIOLATIONS//$'\r'/'%0D'}"
            echo "violations=${VIOLATIONS}" >> $GITHUB_OUTPUT
          else
            echo "has_violations=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for Hotfix Bypass
        id: check_hotfix
        run: |
          if [[ "${{ github.event.pull_request.title }}" == *"[HOTFIX]"* ]]; then
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
          else
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Test Status
        id: check_status
        run: |
          TASK_ID="${{ steps.extract_task.outputs.task_id }}"
          if [ -z "$TASK_ID" ]; then
            echo "status=no_task_id" >> $GITHUB_OUTPUT
            exit 0
          fi

          ROADMAP_FILE=""
          if grep -q "${TASK_ID}" docs/roadmaps/MASTER_ROADMAP.md 2>/dev/null; then
            ROADMAP_FILE="docs/roadmaps/MASTER_ROADMAP.md"
          elif grep -q "${TASK_ID}" docs/roadmaps/TESTING_ROADMAP.md 2>/dev/null; then
            echo "status=testing_task" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "status=not_found" >> $GITHUB_OUTPUT
            exit 0
          fi

          TASK_LINE=$(grep "${TASK_ID}" "$ROADMAP_FILE")
          if echo "$TASK_LINE" | grep -q "Test Status: âœ… Fully Tested"; then
            echo "status=fully_tested" >> $GITHUB_OUTPUT
          elif echo "$TASK_LINE" | grep -q "Test Status: âšª Untested"; then
            echo "status=untested" >> $GITHUB_OUTPUT
          else
            echo "status=no_status_field" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------------
      # DOMAIN-AWARE E2E RESOLUTION
      # ---------------------------------------------------------------
      - name: Resolve Affected E2E Tests
        id: resolve_e2e
        run: |
          ALL_CHANGED="${{ steps.changed_files.outputs.all_files }}"
          echo "$ALL_CHANGED" > /tmp/changed-files.txt

          RESULT=$(bash scripts/ci/resolve-affected-tests.sh /tmp/changed-files.txt)
          echo "e2e_decision=$RESULT" >> $GITHUB_OUTPUT

          if [ "$RESULT" = "SKIP" ]; then
            echo "ðŸŸ¢ No E2E tests needed for this PR (docs/config/test-only changes)"
          elif [ "$RESULT" = "SMOKE" ]; then
            echo "ðŸŸ¡ Shared infrastructure changed â€” smoke E2E subset will run"
          else
            SPEC_COUNT=$(echo "$RESULT" | tr ' ' '\n' | wc -l)
            echo "ðŸ”µ $SPEC_COUNT targeted E2E spec(s) will run:"
            echo "$RESULT" | tr ' ' '\n'
          fi

      - name: Post Status Comment
        uses: actions/github-script@v7
        with:
          script: |
            const isHotfix = '${{ steps.check_hotfix.outputs.is_hotfix }}' === 'true';
            const status = '${{ steps.check_status.outputs.status }}';
            const taskId = '${{ steps.extract_task.outputs.task_id }}';
            const hasViolations = '${{ steps.security_check.outputs.has_violations }}' === 'true';
            const violations = decodeURIComponent('${{ steps.security_check.outputs.violations }}' || '');
            const e2eDecision = '${{ steps.resolve_e2e.outputs.e2e_decision }}';

            let sections = [];

            // Security section (BLOCKING if violations found)
            if (hasViolations) {
              sections.push(`## âŒ Security Pattern Violations\n\n${violations}\n\n**This PR will be blocked until these patterns are fixed.**`);
            } else {
              sections.push(`## âœ… Security Patterns\n\nNo forbidden security patterns detected.`);
            }

            // E2E section
            let e2eSummary = '';
            if (e2eDecision === 'SKIP') {
              e2eSummary = 'â­ï¸ **E2E Tests:** Skipped (no application code changes detected)';
            } else if (e2eDecision === 'SMOKE') {
              e2eSummary = 'ðŸ”¶ **E2E Tests:** Smoke subset (shared infrastructure changes detected)';
            } else {
              const specs = e2eDecision.split(' ').map(s => `\`${s.split('/').pop()}\``).join(', ');
              e2eSummary = `ðŸŽ¯ **E2E Tests:** Targeted â€” ${specs}`;
            }
            sections.push(`## E2E Test Strategy\n\n${e2eSummary}`);

            // Roadmap section (advisory)
            let roadmapSummary = "";
            if (isHotfix) {
              roadmapSummary = "âœ… **Hotfix Bypass:** Roadmap checks bypassed.";
            } else if (status === 'fully_tested' || status === 'testing_task') {
              roadmapSummary = "âœ… **PASS:** Feature is fully tested or is a testing task.";
            } else if (status === 'untested') {
              roadmapSummary = "âš ï¸ **WARNING:** Feature is untested. Consider adding tests.";
            } else if (status === 'no_task_id') {
              roadmapSummary = "âš ï¸ **INFO:** Could not extract Task ID from branch name.";
            } else if (status === 'not_found') {
              roadmapSummary = `âš ï¸ **INFO:** Task ${taskId} not found in roadmap.`;
            } else {
              roadmapSummary = `âš ï¸ **INFO:** Test status unknown. Proceed with review.`;
            }
            sections.push(`## Roadmap Status\n\n${roadmapSummary}`);

            const body = `# Pre-Merge Quality Gate\n\n${sections.join('\n\n---\n\n')}`;

            const [ownerFromEnv, repoFromEnv] = (process.env.GITHUB_REPOSITORY || "").split("/");
            const owner =
              context.repo.owner ||
              context.payload?.repository?.owner?.login ||
              ownerFromEnv;
            const repo =
              context.repo.repo ||
              context.repo.name ||
              context.payload?.repository?.name ||
              repoFromEnv;

            if (!owner || !repo) {
              core.warning("Skipping quality gate comment: unable to resolve owner/repo from workflow context.");
              return;
            }

            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner,
                repo,
                body: body
              });
            } catch (error) {
              core.warning(`Quality gate comment failed: ${error.message}`);
            }

      # Block merge if security violations found
      - name: Block on Security Violations
        if: steps.security_check.outputs.has_violations == 'true' && steps.check_hotfix.outputs.is_hotfix != 'true'
        run: |
          echo "âŒ Security pattern violations detected. PR blocked."
          echo "Fix the patterns listed in the PR comment before merging."
          exit 1

    outputs:
      e2e_decision: ${{ steps.resolve_e2e.outputs.e2e_decision }}

  # ================================================================
  # JOB 2: Static analysis â€” TypeScript + lint (~3 min)
  # ================================================================
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript check
        run: pnpm check

      - name: Lint changed files
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD -- '*.ts' '*.tsx' 2>/dev/null || true)
          if [ -n "$CHANGED" ]; then
            echo "$CHANGED" | xargs pnpm eslint --max-warnings=0 || true
          fi

  # ================================================================
  # JOB 3: Unit tests â€” vitest with DB readiness for data-integrity suite
  # ================================================================
  unit-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: terp_test
          MYSQL_USER: terp_test
          MYSQL_PASSWORD: terp_test_password
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DATABASE_URL: mysql://terp_test:terp_test_password@localhost:3307/terp_test
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for MySQL
        run: |
          MAX_ATTEMPTS=30
          ATTEMPTS=0
          until mysqladmin ping -h 127.0.0.1 -P 3307 --silent 2>/dev/null; do
            ATTEMPTS=$((ATTEMPTS + 1))
            if [ "$ATTEMPTS" -ge "$MAX_ATTEMPTS" ]; then
              echo "MySQL failed to start after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Push schema and seed
        run: |
          pnpm drizzle-kit push --force
          pnpm seed:light
          pnpm seed:qa-accounts

      - name: Unit tests
        run: pnpm test --run

  # ================================================================
  # JOB 4: Targeted E2E â€” only runs specs affected by this PR
  # Skips entirely for docs-only, config-only, or test-only changes
  # ================================================================
  targeted-e2e:
    runs-on: ubuntu-latest
    needs: [quality-gate]
    # Only run if the quality gate determined E2E tests are needed
    if: |
      needs.quality-gate.outputs.e2e_decision != 'SKIP'
    timeout-minutes: 20

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: terp_test
          MYSQL_USER: terp_test
          MYSQL_PASSWORD: terp_test_password
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DATABASE_URL: mysql://terp_test:terp_test_password@localhost:3307/terp_test

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for MySQL
        run: |
          MAX_ATTEMPTS=30
          ATTEMPTS=0
          until mysqladmin ping -h 127.0.0.1 -P 3307 --silent 2>/dev/null; do
            ATTEMPTS=$((ATTEMPTS + 1))
            if [ "$ATTEMPTS" -ge "$MAX_ATTEMPTS" ]; then
              echo "MySQL failed to start after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            sleep 2
          done

      - name: Push schema and seed
        run: pnpm drizzle-kit push --force && pnpm seed:light

      - name: Start app server
        run: |
          JWT_SECRET="${JWT_SECRET:-terp-ci-jwt-secret-2026-000000000000}" \
          DATABASE_URL="$DATABASE_URL" \
          TEST_DATABASE_URL="$DATABASE_URL" \
          PORT=5173 \
          pnpm dev > /tmp/terp-dev.log 2>&1 &
          echo $! > /tmp/terp-dev.pid

      - name: Wait for app readiness
        run: |
          MAX_ATTEMPTS=60
          ATTEMPTS=0
          until curl -fsS http://127.0.0.1:5173/health >/dev/null 2>&1; do
            ATTEMPTS=$((ATTEMPTS + 1))
            if [ "$ATTEMPTS" -ge "$MAX_ATTEMPTS" ]; then
              echo "App failed to start after $MAX_ATTEMPTS attempts"
              echo "---- /tmp/terp-dev.log ----"
              cat /tmp/terp-dev.log || true
              exit 1
            fi
            sleep 2
          done

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: Resolve affected E2E specs
        id: resolve
        run: |
          ALL_CHANGED=$(git diff --name-only origin/main...HEAD 2>/dev/null || true)
          echo "$ALL_CHANGED" > /tmp/changed-files.txt
          RESULT=$(bash scripts/ci/resolve-affected-tests.sh /tmp/changed-files.txt)
          echo "specs=$RESULT" >> $GITHUB_OUTPUT

      - name: Run targeted E2E tests
        id: e2e
        run: |
          SPECS="${{ steps.resolve.outputs.specs }}"

          if [ "$SPECS" = "SMOKE" ]; then
            echo "Running smoke E2E subset (shared infrastructure changed)..."
            pnpm exec playwright test \
              tests-e2e/critical-paths/order-fulfillment-workflow.spec.ts \
              tests-e2e/critical-paths/inventory-intake.spec.ts \
              tests-e2e/critical-paths/accounting-quick-payment.spec.ts \
              tests-e2e/critical-paths/client-credit-workflow.spec.ts \
              --project=chromium \
              --reporter=list
          else
            echo "Running targeted E2E specs: $SPECS"
            # shellcheck disable=SC2086
            pnpm exec playwright test $SPECS --project=chromium --reporter=list
          fi
        env:
          CI: true
          E2E_USE_LIVE_DB: '1'
          PLAYWRIGHT_BASE_URL: http://127.0.0.1:5173

      - name: Upload Playwright report on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: targeted-e2e-report
          path: playwright-report/
          retention-days: 7

      - name: Print app server logs on failure
        if: failure()
        run: |
          echo "---- /tmp/terp-dev.log ----"
          cat /tmp/terp-dev.log || true

      - name: Stop app server
        if: always()
        run: |
          if [ -f /tmp/terp-dev.pid ]; then
            kill "$(cat /tmp/terp-dev.pid)" 2>/dev/null || true
          fi
