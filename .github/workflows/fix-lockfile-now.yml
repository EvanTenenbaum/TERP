name: Fix Lockfile Now (Manual Trigger)

on:
  workflow_dispatch:  # Manual trigger only

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-lockfile:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Update lockfile
        run: |
          echo "üì¶ Updating lockfile..."
          pnpm install --lockfile-only
          echo "‚úÖ Lockfile updated"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet pnpm-lock.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Lockfile is already in sync - no changes needed"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Lockfile has changes:"
            git diff --stat pnpm-lock.yaml
          fi

      - name: Create Pull Request with lockfile update
        if: steps.check-changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: Sync pnpm-lock.yaml with package.json

          Resolves ERR_PNPM_OUTDATED_LOCKFILE deployment error.
          Heroku buildpack requires lockfile to be in sync with package.json.
          
          Auto-generated by GitHub Actions workflow."
          title: "fix: Sync pnpm-lock.yaml with package.json"
          body: |
            **üî¥ CRITICAL FIX - Auto-generated by GitHub Actions**

            This PR fixes the TERP deployment blocker by syncing the lockfile.

            **Problem:**
            - `pnpm-lock.yaml` is out of sync with `package.json`
            - Heroku buildpack runs `pnpm install --frozen-lockfile` before our build command
            - This causes `ERR_PNPM_OUTDATED_LOCKFILE` deployment failures

            **Solution:**
            - Updated `pnpm-lock.yaml` to match current `package.json`
            - Generated using: `pnpm install --lockfile-only`
            - This will allow TERP app to deploy successfully

            **Next Steps:**
            1. Review this PR (should be safe - just lockfile sync)
            2. Merge to main
            3. Monitor TERP deployment until ACTIVE

            **Verification:**
            - Lockfile generated in GitHub Actions (no local dependencies)
            - Should resolve deployment errors immediately after merge
          branch: fix-lockfile-sync
          delete-branch: true
          labels: |
            deployment
            critical
            automated

      - name: Success message
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          echo "‚úÖ Lockfile updated successfully!"
          echo "üöÄ Pull request created - merge to fix deployment"

      - name: No changes message
        if: steps.check-changes.outputs.changed == 'false'
        run: |
          echo "‚úÖ Lockfile is already in sync"
          echo "No action needed"

