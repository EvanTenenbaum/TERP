name: AI Browser QA Agent

on:
  schedule:
    # Run daily at 3:00 AM UTC (after regular QA at 2:00 AM)
    - cron: "0 3 * * *"

  workflow_dispatch:
    inputs:
      scenario:
        description: "Scenario to run"
        type: choice
        default: "dashboardExplore"
        options:
          - dashboardExplore
          - navigationSmokeTest
          - clientsCRUD
          - inventoryExplore
          - orderWorkflow
          - accountingOverview
          - formValidation
          - all
      custom_task:
        description: "Custom task (overrides scenario)"
        type: string
        required: false

permissions:
  contents: read
  issues: write

env:
  NODE_VERSION: "20"
  PLAYWRIGHT_BASE_URL: https://terp-app-b9s35.ondigitalocean.app

jobs:
  ai-qa-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run AI QA Agent
        id: ai_qa
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          E2E_ADMIN_USERNAME: ${{ secrets.E2E_ADMIN_USERNAME }}
          E2E_ADMIN_PASSWORD: ${{ secrets.E2E_ADMIN_PASSWORD }}
          SKIP_E2E_SETUP: "1"
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          SCENARIO: ${{ inputs.scenario || 'dashboardExplore' }}
          AI_TASK: ${{ inputs.custom_task }}
        run: |
          if [ "${{ inputs.scenario }}" = "all" ]; then
            # Run all AI tests
            pnpm test:e2e:ai:run --project=chromium || true
          else
            # Run specific scenario
            pnpm test:e2e:ai:scenario --project=chromium || true
          fi
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-qa-results-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 14

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ¤– AI Browser QA Agent Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ env.PLAYWRIGHT_BASE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scenario:** ${{ inputs.scenario || 'dashboardExplore' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.json ]; then
            PASSED=$(jq '.stats.expected // 0' test-results.json)
            FAILED=$(jq '.stats.unexpected // 0' test-results.json)
            echo "**Results:** âœ… $PASSED passed, âŒ $FAILED failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Results:** See artifacts for details" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const scenario = '${{ inputs.scenario || 'dashboardExplore' }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– AI QA Agent: Failures detected in ${scenario}`,
              labels: ['automated-qa', 'ai-agent', 'needs-review'],
              body: `## AI Browser QA Agent Found Issues

**Scenario:** ${scenario}
**Target:** ${{ env.PLAYWRIGHT_BASE_URL }}
**Run:** [View Details](${runUrl})

The AI QA agent detected issues during automated testing. Please review the test results and screenshots in the workflow artifacts.

---
*This issue was automatically created by the AI Browser QA Agent.*`
            });
