name: Swarm Manual Start

# INFRA-007: Updated Swarm Manager Configuration

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        type: choice
        options:
          - 'auto'
          - 'batch'
          - 'until-phase'
          - 'until-task'
        default: 'auto'
      target_phase:
        description: 'Work until this phase (e.g., "Phase 2.5", "Phase 3") - Required if mode is until-phase'
        required: false
        type: string
      target_task:
        description: 'Work until this task (e.g., "BUG-007", "WF-004") - Required if mode is until-task'
        required: false
        type: string
      batch_tasks:
        description: 'Comma-separated task IDs (e.g., "BUG-002,BUG-003") - Required if mode is batch'
        required: false
        type: string
      max_concurrent:
        description: 'Maximum concurrent agents (default: 3)'
        required: false
        type: number
        default: 3

jobs:
  swarm-execution:
    name: Auto-Start Swarm Agents
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check swarm status
        id: status
        run: |
          STATUS=$(pnpm swarm status 2>&1 || echo '{"pending":[],"recommended":[]}')
          echo "status<<EOF" >> $GITHUB_OUTPUT
          echo "$STATUS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse status
        id: parse
        run: |
          STATUS='${{ steps.status.outputs.status }}'
          if echo "$STATUS" | jq -e '.recommended | length > 0' > /dev/null 2>&1; then
            RECOMMENDED=$(echo "$STATUS" | jq -r '.recommended[]' | tr '\n' ',' | sed 's/,$//')
            echo "has_tasks=true" >> $GITHUB_OUTPUT
            echo "tasks=$RECOMMENDED" >> $GITHUB_OUTPUT
          else
            echo "has_tasks=false" >> $GITHUB_OUTPUT
            echo "tasks=" >> $GITHUB_OUTPUT
          fi

      - name: Execute swarm agents
        env:
          GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
        run: |
          MODE="${{ github.event.inputs.mode }}"
          
          if [ "$MODE" == "until-phase" ]; then
            if [ -z "${{ github.event.inputs.target_phase }}" ]; then
              echo "âŒ Error: target_phase is required when mode is until-phase"
              exit 1
            fi
            echo "ðŸš€ Working until phase: ${{ github.event.inputs.target_phase }}"
            pnpm swarm execute --until-phase="${{ github.event.inputs.target_phase }}" || true
            
          elif [ "$MODE" == "until-task" ]; then
            if [ -z "${{ github.event.inputs.target_task }}" ]; then
              echo "âŒ Error: target_task is required when mode is until-task"
              exit 1
            fi
            echo "ðŸš€ Working until task: ${{ github.event.inputs.target_task }}"
            pnpm swarm execute --until-task="${{ github.event.inputs.target_task }}" || true
            
          elif [ "$MODE" == "batch" ]; then
            if [ -z "${{ github.event.inputs.batch_tasks }}" ]; then
              echo "âŒ Error: batch_tasks is required when mode is batch"
              exit 1
            fi
            echo "ðŸš€ Executing batch: ${{ github.event.inputs.batch_tasks }}"
            pnpm swarm execute --batch="${{ github.event.inputs.batch_tasks }}" || true
            
          else
            # Auto mode - use recommended tasks
            if [ "${{ steps.parse.outputs.has_tasks }}" == "true" ]; then
              echo "ðŸš€ Auto-executing: ${{ steps.parse.outputs.tasks }}"
              pnpm swarm execute --batch="${{ steps.parse.outputs.tasks }}" || true
            else
              echo "â„¹ï¸  No recommended tasks found"
            fi
          fi

      - name: Generate status report
        id: report
        run: |
          cat > swarm-status-report.md << 'EOF'
          # Swarm Status Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow Run:** ${{ github.run_id }}
          
          ## Status
          
          EOF
          
          if [ "${{ steps.parse.outputs.has_tasks }}" == "true" ]; then
            echo "âœ… Swarm executed with tasks: ${{ steps.parse.outputs.tasks }}" >> swarm-status-report.md
          else
            echo "â„¹ï¸  No recommended tasks found. All caught up!" >> swarm-status-report.md
          fi
          
          echo "" >> swarm-status-report.md
          echo "## Active Sessions" >> swarm-status-report.md
          echo "" >> swarm-status-report.md
          if [ -f "docs/ACTIVE_SESSIONS.md" ]; then
            cat docs/ACTIVE_SESSIONS.md >> swarm-status-report.md
          else
            echo "No active sessions found." >> swarm-status-report.md
          fi
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat swarm-status-report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create status summary
        run: |
          echo "## ðŸ¤– Swarm Auto-Start Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.parse.outputs.has_tasks }}" == "true" ]; then
            echo "âœ… **Executed tasks:** ${{ steps.parse.outputs.tasks }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **No tasks to execute** - All caught up!" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Full Report:** See workflow logs" >> $GITHUB_STEP_SUMMARY

