name: Deploy Watchdog

on:
  push:
    branches: [ main ]

jobs:
  monitor-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Wait for Deployment to Start
        run: sleep 30  # Give DO a moment to register the git push

      - name: Watch Deployment Status
        id: watch
        env:
          APP_NAME: ${{ secrets.DO_APP_NAME }}
        run: |
          # Check if APP_NAME is set
          if [ -z "$APP_NAME" ]; then
            echo "⚠️  DO_APP_NAME secret not set - skipping deployment monitoring"
            echo "result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 1. Get App ID
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "$APP_NAME" | awk '{print $1}')
          echo "App ID: $APP_ID"
          
          if [ -z "$APP_ID" ]; then
            echo "⚠️  Could not find app with name: $APP_NAME"
            echo "result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 2. Get the latest Deployment ID
          DEPLOY_ID=$(doctl apps list-deployments $APP_ID --format ID --no-header | head -n 1)
          echo "Tracking Deployment: $DEPLOY_ID"
          
          if [ -z "$DEPLOY_ID" ]; then
            echo "⚠️  No deployments found for app: $APP_NAME"
            echo "result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 3. Loop until finish
          while true; do
            STATUS=$(doctl apps get-deployment $APP_ID $DEPLOY_ID --format Phase --no-header)
            echo "Current Status: $STATUS"
            
            if [ "$STATUS" == "ACTIVE" ]; then
              echo "result=success" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "CANCELED" ]; then
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
            sleep 30
          done

      - name: Install pnpm
        if: steps.watch.outputs.result == 'success'
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        if: steps.watch.outputs.result == 'success'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Checkout code
        if: steps.watch.outputs.result == 'success'
        uses: actions/checkout@v4

      - name: Install dependencies
        if: steps.watch.outputs.result == 'success'
        run: pnpm install --frozen-lockfile

      - name: INFRA-004 Post-Deployment Health Check
        id: health
        if: steps.watch.outputs.result == 'success'
        env:
          APP_URL: ${{ secrets.APP_URL }}
        run: |
          echo "Running post-deployment health check..."
          pnpm tsx scripts/deployment-enforcement.ts health || echo "HEALTH_FAILED=true" >> $GITHUB_OUTPUT

      - name: Notify Slack (Success)
        if: success() && steps.watch.outputs.result == 'success' && steps.health.outputs.HEALTH_FAILED != 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "✅ **Deployment Successful**\nApp: ${{ secrets.DO_APP_NAME }}\nVersion: ${{ github.sha }} is now live.\nHealth Check: PASSED",
              "attachments": [{ "color": "#36a64f" }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack (Health Check Failed)
        if: steps.watch.outputs.result == 'success' && steps.health.outputs.HEALTH_FAILED == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "⚠️ **Deployment Health Check FAILED**\nApp: ${{ secrets.DO_APP_NAME }}\nVersion: ${{ github.sha }} deployed but health check failed.",
              "attachments": [{ "color": "#ff9800" }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack (Failure)
        if: failure() && steps.watch.outputs.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "❌ **Deployment FAILED**\nApp: ${{ secrets.DO_APP_NAME }}\nCommit: ${{ github.event.head_commit.message }}",
              "attachments": [{ "color": "#ff0000", "text": "Check DigitalOcean console for build logs." }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
