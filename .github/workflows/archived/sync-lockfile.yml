name: Sync pnpm-lock.yaml

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - 'package.json'
    branches:
      - main
  schedule:
    # Run daily at 2 AM UTC to catch any drift
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-lockfile:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Update lockfile
        run: |
          echo "üì¶ Updating lockfile..."
          pnpm install --lockfile-only
          echo "‚úÖ Lockfile updated"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet pnpm-lock.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Lockfile is already in sync"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Lockfile has changes:"
            git diff --stat pnpm-lock.yaml
          fi

      - name: Try direct push to main
        if: steps.check-changes.outputs.changed == 'true'
        id: try-push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pnpm-lock.yaml
          git commit -m "chore: Sync pnpm-lock.yaml with package.json

          Auto-generated by GitHub Actions workflow.
          This ensures the lockfile is always in sync with package.json."
          
          echo "üöÄ Attempting direct push to main..."
          if git push origin HEAD:main 2>&1; then
            echo "pushed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Successfully pushed to main"
          else
            echo "pushed=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Direct push failed (likely branch protection)"
          fi
        continue-on-error: true

      - name: Create Pull Request (if push failed)
        if: steps.check-changes.outputs.changed == 'true' && steps.try-push.outputs.pushed != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: Sync pnpm-lock.yaml with package.json"
          title: "chore: Sync pnpm-lock.yaml with package.json"
          body: |
            **Auto-generated by GitHub Actions**

            This PR updates the lockfile to match package.json changes.

            **Why this PR exists:**
            - The lockfile was out of sync with package.json
            - This causes deployment failures with Heroku buildpack's frozen-lockfile check
            - Auto-generated by GitHub Actions workflow

            **What changed:**
            - Updated pnpm-lock.yaml to match current package.json

            **Verification:**
            - Lockfile generated with: `pnpm install --lockfile-only`
            - Should resolve ERR_PNPM_OUTDATED_LOCKFILE deployment errors

            **Next Steps:**
            1. Review this PR (should be safe - just lockfile sync)
            2. Merge to main
            3. Monitor TERP deployment until ACTIVE
          branch: sync-lockfile-auto
          delete-branch: true

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
            if [ "${{ steps.try-push.outputs.pushed }}" == "true" ]; then
              echo "‚úÖ Lockfile updated and pushed to main"
              echo "üöÄ Deployment should succeed on next build"
            else
              echo "‚úÖ Lockfile updated and PR created"
              echo "üìù Merge the PR to fix deployment"
            fi
          else
            echo "‚úÖ Lockfile is already in sync"
            echo "No changes needed"
          fi

