name: Set Secrets to DigitalOcean

# Workflow to sync secrets from GitHub Secrets to DigitalOcean App Platform
# This allows agents to programmatically manage secrets across platforms

on:
  workflow_dispatch:
    inputs:
      secret_name:
        description: 'Name of secret to set (optional - set all if empty)'
        required: false
        type: string
  schedule:
    # Run daily to ensure secrets are synced
    - cron: '0 2 * * *'

permissions:
  contents: read
  secrets: read

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    if: github.repository == 'EvanTenenbaum/TERP'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}
      
      - name: Set secrets from GitHub Secrets
        env:
          DO_APP_ID: ${{ secrets.DIGITALOCEAN_APP_ID }}
        run: |
          echo "üîê Syncing secrets from GitHub Secrets to DigitalOcean..."
          
          # List of secrets to sync
          # Add your secret names here - they'll be fetched from GitHub Secrets
          SECRETS=(
            "JWT_SECRET"
            "CLERK_SECRET_KEY"
            "CLERK_PUBLISHABLE_KEY"
            "SOLARWINDS_TOKEN"
            "SENTRY_DSN"
            "VITE_SENTRY_DSN"
            "GITHUB_WEBHOOK_SECRET"
          )
          
          for secret_name in "${SECRETS[@]}"; do
            # Skip if specific secret requested and doesn't match
            if [ -n "${{ github.event.inputs.secret_name }}" ] && [ "${{ github.event.inputs.secret_name }}" != "$secret_name" ]; then
              continue
            fi
            
            # Get secret from GitHub Secrets
            # Note: GitHub Secrets are automatically available as environment variables
            # Format: secrets.SECRET_NAME
            secret_value="${{ secrets[$secret_name] }}"
            
            if [ -z "$secret_value" ]; then
              echo "‚ö†Ô∏è  Secret $secret_name not found in GitHub Secrets"
              continue
            fi
            
            echo "üìã Setting $secret_name..."
            
            # Set in DigitalOcean App Platform
            doctl apps spec set-env "$DO_APP_ID" "$secret_name" "$secret_value" --scope RUN_AND_BUILD_TIME || {
              echo "‚ùå Failed to set $secret_name"
              exit 1
            }
            
            echo "‚úÖ Set $secret_name"
          done
          
          echo "‚úÖ All secrets synced successfully"

