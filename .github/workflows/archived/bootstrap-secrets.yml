name: Bootstrap GitHub Secrets (One-Time Setup)

# One-time workflow to bootstrap all secrets to GitHub Secrets
# Run this ONCE, and all secrets will be permanently stored in GitHub Secrets
# After this, secrets are permanent and accessible to all agents/workflows

on:
  workflow_dispatch:
    inputs:
      confirm_bootstrap:
        description: 'Type "BOOTSTRAP" to confirm you want to add all secrets'
        required: true
        type: string

permissions:
  secrets: write
  contents: read

jobs:
  bootstrap-secrets:
    runs-on: ubuntu-latest
    if: github.repository == 'EvanTenenbaum/TERP' && inputs.confirm_bootstrap == 'BOOTSTRAP'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        run: |
          gh --version || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null && sudo apt update && sudo apt install gh -y)
      
      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
      
      - name: Read secrets from deployment_details.json (if available)
        id: read_secrets
        continue-on-error: true
        run: |
          if [ -f "deployment_details.json" ]; then
            echo "üìã Reading secrets from deployment_details.json..."
            
            # Extract secrets from JSON using jq (if available) or python
            if command -v jq &> /dev/null; then
              echo "jwt_secret=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="JWT_SECRET") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "clerk_secret=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="CLERK_SECRET_KEY") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "clerk_pub=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="CLERK_PUBLISHABLE_KEY") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "db_url=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="DATABASE_URL") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "webhook_secret=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="GITHUB_WEBHOOK_SECRET") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "solarwinds=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="SOLARWINDS_TOKEN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "sentry=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="SENTRY_DSN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "vite_sentry=$(jq -r '.[0].spec.services[0].envs[]? | select(.key=="VITE_SENTRY_DSN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "slack_bot=$(jq -r '.[0].spec.workers[0].envs[]? | select(.key=="SLACK_BOT_TOKEN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "slack_app=$(jq -r '.[0].spec.workers[0].envs[]? | select(.key=="SLACK_APP_TOKEN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "gh_token=$(jq -r '.[0].spec.workers[0].envs[]? | select(.key=="GITHUB_TOKEN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "gemini=$(jq -r '.[0].spec.workers[0].envs[]? | select(.key=="GEMINI_API_KEY") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "do_token=$(jq -r '.[0].spec.workers[0].envs[]? | select(.key=="DIGITALOCEAN_ACCESS_TOKEN") | .value' deployment_details.json)" >> $GITHUB_OUTPUT
              echo "has_secrets=true" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è  jq not available, skipping JSON parsing"
              echo "has_secrets=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è  deployment_details.json not found"
            echo "has_secrets=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install jq if not available
        if: steps.read_secrets.outputs.has_secrets != 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y jq || echo "jq installation failed, will use manual input"
      
      - name: Bootstrap secrets to GitHub Secrets
        run: |
          echo "üîê Bootstrapping secrets to GitHub Secrets (permanent storage)..."
          echo ""
          
          # Function to set secret if value is provided
          set_secret() {
            local name=$1
            local value=$2
            if [ -n "$value" ] && [ "$value" != "null" ]; then
              echo "$value" | gh secret set "$name" --body-file /dev/stdin --repo ${{ github.repository }}
              echo "‚úÖ Set $name"
            else
              echo "‚è≠Ô∏è  Skipping $name (not provided)"
            fi
          }
          
          # Service secrets (from JSON or will be skipped)
          set_secret "JWT_SECRET" "${{ steps.read_secrets.outputs.jwt_secret }}"
          set_secret "CLERK_SECRET_KEY" "${{ steps.read_secrets.outputs.clerk_secret }}"
          set_secret "CLERK_PUBLISHABLE_KEY" "${{ steps.read_secrets.outputs.clerk_pub }}"
          set_secret "DATABASE_URL" "${{ steps.read_secrets.outputs.db_url }}"
          set_secret "GITHUB_WEBHOOK_SECRET" "${{ steps.read_secrets.outputs.webhook_secret }}"
          
          # Monitoring secrets
          set_secret "SOLARWINDS_TOKEN" "${{ steps.read_secrets.outputs.solarwinds }}"
          set_secret "SENTRY_DSN" "${{ steps.read_secrets.outputs.sentry }}"
          set_secret "VITE_SENTRY_DSN" "${{ steps.read_secrets.outputs.vite_sentry }}"
          
          # Worker secrets
          set_secret "SLACK_BOT_TOKEN" "${{ steps.read_secrets.outputs.slack_bot }}"
          set_secret "SLACK_APP_TOKEN" "${{ steps.read_secrets.outputs.slack_app }}"
          set_secret "GITHUB_TOKEN" "${{ steps.read_secrets.outputs.gh_token }}"
          set_secret "GEMINI_API_KEY" "${{ steps.read_secrets.outputs.gemini }}"
          
          do_token="${{ steps.read_secrets.outputs.do_token }}"
          if [ -n "$do_token" ] && [ "$do_token" != "null" ]; then
            echo "$do_token" | gh secret set "DIGITALOCEAN_TOKEN" --body-file /dev/stdin --repo ${{ github.repository }}
            echo "$do_token" | gh secret set "DIGITALOCEAN_ACCESS_TOKEN" --body-file /dev/stdin --repo ${{ github.repository }}
            echo "‚úÖ Set DIGITALOCEAN_TOKEN and DIGITALOCEAN_ACCESS_TOKEN"
          fi
          
          echo ""
          echo "=================================================="
          echo "‚úÖ Bootstrap complete!"
          echo "=================================================="
          echo ""
          echo "üìã All secrets are now permanently stored in GitHub Secrets"
          echo "üí° They're available to all workflows and agents"
          echo "üí° You can verify them at:"
          echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo ""
          echo "‚ö†Ô∏è  Note: If deployment_details.json wasn't available, you'll need"
          echo "   to add secrets manually using the 'Add Secrets to GitHub Secrets' workflow"

