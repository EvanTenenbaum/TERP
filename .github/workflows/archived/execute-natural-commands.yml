name: Execute Natural Language Commands

on:
  push:
    paths:
      - '.github/AGENT_COMMANDS.md'
  workflow_dispatch: # Manual trigger
  schedule:
    # Check every 5 minutes for new commands
    - cron: '*/5 * * * *'

jobs:
  parse-and-execute:
    name: Parse and Execute Commands
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Parse natural language commands
        id: parse
        run: |
          PARSED=$(pnpm tsx scripts/parse-natural-commands.ts 2>&1 || echo '{"commands":[]}')
          echo "parsed<<EOF" >> $GITHUB_OUTPUT
          echo "$PARSED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Execute commands
        id: execute
        env:
          GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
        run: |
          PARSED='${{ steps.parse.outputs.parsed }}'
          
          # Check if there are commands
          COMMAND_COUNT=$(echo "$PARSED" | jq '.commands | length' 2>/dev/null || echo "0")
          
          if [ "$COMMAND_COUNT" == "0" ]; then
            echo "â„¹ï¸  No pending commands found"
            echo "result=no_commands" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“‹ Found $COMMAND_COUNT command(s) to execute"
          
          # Process each command using Node.js script
          pnpm tsx scripts/execute-natural-commands.ts "$PARSED"
          
          echo "result=executed" >> $GITHUB_OUTPUT

      - name: Commit command updates
        if: steps.execute.outputs.result == 'executed'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/AGENT_COMMANDS.md
          git commit -m "Execute natural language commands [skip ci]" || true
          git push origin main || true

      - name: Create summary
        run: |
          echo "## ðŸ¤– Natural Language Command Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.execute.outputs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See workflow logs for details." >> $GITHUB_STEP_SUMMARY

