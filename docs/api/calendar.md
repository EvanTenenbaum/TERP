# Calendar API

Scheduling and calendar utilities for events, recurrence, history, and attachments. Router: `calendar`.

## Endpoints

### calendar.getEvents

- **Method & Path:** `GET /api/trpc/calendar.getEvents`
- **Type:** Query
- **Permissions:** Public (results filtered by permission service)
- **Input Schema:**
  ```json
  {
    "startDate": "ISO string",
    "endDate": "ISO string",
    "modules"?: ["string"],
    "eventTypes"?: ["string"],
    "statuses"?: ["string"],
    "priorities"?: ["string"],
    "assignedTo"?: number,
    "includeAutoGenerated"?: boolean,
    "timezone"?: "string",
    "limit"?: number,
    "offset"?: number,
    "includeTotalCount"?: boolean
  }
  ```
- **Output Schema:** Either array of events/instances or `{ data: Event[], pagination: { total, limit, offset, hasMore } }` when `includeTotalCount` is true.

### calendar.getEventById

- **Method & Path:** `GET /api/trpc/calendar.getEventById`
- **Type:** Query
- **Permissions:** Requires `VIEW` permission via `PermissionService`
- **Input:** `{ "id": number, "timezone"?: string }`
- **Output:** Event with participants, reminders, attachments, permissions, history, optional recurrenceRule, and display time info.

### calendar.createEvent

- **Method & Path:** `POST /api/trpc/calendar.createEvent`
- **Type:** Mutation
- **Permissions:** Public procedure but enforces authentication through `getAuthenticatedUserId`
- **Input Schema:**
  ```json
  {
    "title": "string",
    "description"?: "string",
    "location"?: "string",
    "startDate": "ISO string",
    "endDate": "ISO string",
    "startTime"?: "HH:mm",
    "endTime"?: "HH:mm",
    "timezone": "string",
    "isFloatingTime"?: boolean,
    "module": "INVENTORY" | "ACCOUNTING" | "CLIENTS" | "VENDORS" | "ORDERS" | "SAMPLES" | "COMPLIANCE" | "GENERAL",
    "eventType": "MEETING" | "TASK" | "DELIVERY" | "PAYMENT_DUE" | "FOLLOW_UP" | "AUDIT" | "INTAKE" | "PHOTOGRAPHY" | "BATCH_EXPIRATION" | "RECURRING_ORDER" | "SAMPLE_REQUEST" | "OTHER",
    "status"?: "SCHEDULED" | "IN_PROGRESS" | "COMPLETED" | "CANCELLED",
    "priority"?: "LOW" | "MEDIUM" | "HIGH" | "URGENT",
    "visibility"?: "PRIVATE" | "TEAM" | "COMPANY" | "PUBLIC",
    "assignedTo"?: number,
    "entityType"?: "string",
    "entityId"?: number,
    "clientId"?: number,
    "isRecurring"?: boolean,
    "recurrenceRule"?: { "frequency": "DAILY" | "WEEKLY" | "MONTHLY" | "YEARLY", "interval"?: number, "byDay"?: number[], "byMonthDay"?: number[], "byWeekOfMonth"?: number[], "byDayOfWeekInMonth"?: {"week": number, "day": number}[], "byMonth"?: number[], "startDate": "ISO", "endDate"?: "ISO", "count"?: number, "exceptionDates"?: string[] },
    "participants"?: number[],
    "reminders"?: [{ "relativeMinutes": number, "method": "IN_APP" | "EMAIL" | "BOTH" }]
  }
  ```
- **Output Schema:** Newly created event record (with recurrence generation if applicable).

### calendar.updateEvent

- **Method & Path:** `POST /api/trpc/calendar.updateEvent`
- **Type:** Mutation
- **Permissions:** Requires `EDIT` permission via `PermissionService`
- **Input:** `{ "id": number, "updates": { title?, description?, location?, startDate?, endDate?, startTime?, endTime?, status?, priority?, assignedTo?, clientId? }, "updateScope"?: "THIS_INSTANCE" | "THIS_AND_FUTURE" | "ALL_INSTANCES" }`
- **Output:** `{ success: true }` with history entries for changed fields.

### calendar.deleteEvent

- **Method & Path:** `POST /api/trpc/calendar.deleteEvent`
- **Type:** Mutation
- **Permissions:** Requires `DELETE` permission via `PermissionService`
- **Input:** `{ "id": number, "deleteScope"?: "THIS_INSTANCE" | "THIS_AND_FUTURE" | "ALL_INSTANCES" }`
- **Output:** `{ success: true }` after soft delete and history entry.

### calendar.getEventsByEntity

- **Method & Path:** `GET /api/trpc/calendar.getEventsByEntity`
- **Type:** Query
- **Permissions:** Public
- **Input:** `{ "entityType": string, "entityId": number }`
- **Output:** Events linked to the entity.

### calendar.getMyEvents

- **Method & Path:** `GET /api/trpc/calendar.getMyEvents`
- **Type:** Query
- **Permissions:** Authenticated user required
- **Input:** _None_
- **Output:** Events assigned to the current user.

### calendar.getEventHistory

- **Method & Path:** `GET /api/trpc/calendar.getEventHistory`
- **Type:** Query
- **Permissions:** Public
- **Input:** `{ "eventId": number }`
- **Output:** History entries.

### calendar.getEventAttachments

- **Method & Path:** `GET /api/trpc/calendar.getEventAttachments`
- **Type:** Query
- **Permissions:** Public
- **Input:** `{ "eventId": number }`
- **Output:** Attachment metadata list.

### calendar.getEventsByClient

- **Method & Path:** `GET /api/trpc/calendar.getEventsByClient`
- **Type:** Query
- **Permissions:** Public
- **Input:** `{ "clientId": number }`
- **Output:** Events linked to the client.

## Example

```bash
curl -X POST "<base-url>/api/trpc/calendar.createEvent" \
  -H "Content-Type: application/json" \
  -H "Cookie: terp_session=<session>" \
  -d '{"json":{"title":"Delivery","startDate":"2026-01-05","endDate":"2026-01-05","timezone":"America/Los_Angeles","module":"ORDERS","eventType":"DELIVERY","priority":"HIGH","visibility":"TEAM"}}'
```
