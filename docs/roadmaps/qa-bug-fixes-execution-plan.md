# QA Bug Fixes - Execution Plan

**Version:** 1.0
**Created:** January 11, 2026
**Roadmap:** [qa-bug-fixes-january-2026.md](./qa-bug-fixes-january-2026.md)

---

## Execution Overview

This document provides step-by-step implementation instructions for each task in the QA Bug Fixes roadmap. Tasks are organized by priority and can be executed by multiple developers in parallel where dependencies allow.

---

## Parallel Execution Strategy

```
┌─────────────────────────────────────────────────────────────────────┐
│                         DAY 1-2                                      │
├─────────────────┬─────────────────┬─────────────────────────────────┤
│   Developer A   │   Developer B   │         Developer C             │
├─────────────────┼─────────────────┼─────────────────────────────────┤
│   QA-001        │   QA-002        │   QA-004                        │
│   Calendar DB   │   Batches Route │   Client TS Errors              │
│   (4-8h)        │   (2h)          │   (4-8h)                        │
│                 │                 │                                 │
│                 │   QA-003        │   QA-005                        │
│                 │   Invoice Redir │   Server TS Errors              │
│                 │   (1h)          │   (2h)                          │
└─────────────────┴─────────────────┴─────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         DAY 3                                        │
├─────────────────────────────────────────────────────────────────────┤
│                    All Developers                                    │
├─────────────────────────────────────────────────────────────────────┤
│   QA-006: Navigation Improvements (8h)                              │
│   - Can be split across team                                        │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         DAY 4-5                                      │
├─────────────────────────────────────────────────────────────────────┤
│                    Developer A + B                                   │
├─────────────────────────────────────────────────────────────────────┤
│   QA-007: Test Data Seeding (8h)                                    │
│   QA-008: Safe Test Mode (8h)                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Task QA-001: Fix Calendar Database Layer

### Pre-requisites

- Access to `server/calendarDb.ts`
- Understanding of Drizzle ORM query building

### Implementation Steps

#### Step 1: Remove Duplicate Database Checks (30 min)

1. Open `server/calendarDb.ts`
2. Search for pattern: `if (!db) throw new Error("Database not available");`
3. For each function, keep only ONE check at the beginning
4. Remove all duplicate checks (found on ~30+ locations)

**Example fix:**

```typescript
// BEFORE (lines 62-63)
if (!db) throw new Error("Database not available");
if (!db) throw new Error("Database not available"); // REMOVE THIS

// AFTER
if (!db) throw new Error("Database not available");
```

#### Step 2: Implement Filter Logic (2-3h)

1. Locate `getEventsByDateRange()` function (line ~49)
2. Replace the incomplete filter implementation:

```typescript
// BEFORE (lines 76-78)
// Apply filters
// Note: This is a simplified version. In production, you'd build the query dynamically

// AFTER
export async function getEventsByDateRange(
  startDate: string,
  endDate: string,
  filters?: {
    modules?: string[];
    eventTypes?: string[];
    statuses?: string[];
    priorities?: string[];
    assignedTo?: number;
    includeAutoGenerated?: boolean;
  }
) {
  const db = await getDb();
  if (!db) throw new Error("Database not available");

  // Build dynamic conditions array
  const conditions: SQL[] = [
    gte(calendarEvents.startDate, new Date(startDate)),
    lte(calendarEvents.endDate, new Date(endDate)),
    isNull(calendarEvents.deletedAt),
  ];

  // Apply optional filters
  if (filters?.modules && filters.modules.length > 0) {
    conditions.push(inArray(calendarEvents.module, filters.modules as any));
  }
  if (filters?.eventTypes && filters.eventTypes.length > 0) {
    conditions.push(
      inArray(calendarEvents.eventType, filters.eventTypes as any)
    );
  }
  if (filters?.statuses && filters.statuses.length > 0) {
    conditions.push(inArray(calendarEvents.status, filters.statuses as any));
  }
  if (filters?.priorities && filters.priorities.length > 0) {
    conditions.push(
      inArray(calendarEvents.priority, filters.priorities as any)
    );
  }
  if (filters?.assignedTo) {
    conditions.push(eq(calendarEvents.assignedTo, filters.assignedTo));
  }
  if (filters?.includeAutoGenerated === false) {
    conditions.push(eq(calendarEvents.isAutoGenerated, false));
  }

  return await db
    .select()
    .from(calendarEvents)
    .where(and(...conditions));
}
```

#### Step 3: Add Unit Tests (1-2h)

Create `server/calendarDb.test.ts`:

```typescript
import { describe, it, expect, vi } from "vitest";
import * as calendarDb from "./calendarDb";

describe("calendarDb", () => {
  describe("getEventsByDateRange", () => {
    it("should apply module filter", async () => {
      // Test implementation
    });

    it("should apply multiple filters", async () => {
      // Test implementation
    });

    it("should handle empty filters", async () => {
      // Test implementation
    });
  });
});
```

#### Step 4: Verify Fixes

```bash
# Run type check
pnpm tsc --noEmit

# Run calendar-related tests
pnpm vitest run server/calendarDb.test.ts

# Start dev server and test manually
pnpm dev
# Navigate to /calendar and verify events load
```

### Verification Checklist

- [ ] No duplicate db checks in calendarDb.ts
- [ ] Filters applied correctly in getEventsByDateRange
- [ ] Calendar page loads without errors
- [ ] Events filtered correctly by module
- [ ] Events filtered correctly by status

---

## Task QA-002: Add Batches Route

### Pre-requisites

- Access to `client/src/App.tsx`

### Implementation Steps

#### Step 1: Add Route (15 min)

Open `client/src/App.tsx` and add batches route:

```typescript
// Add after inventory routes (around line 130)
<Route
  path="/batches"
  component={withErrorBoundary(Inventory)}
/>
<Route
  path="/batches/:id"
  component={withErrorBoundary(Inventory)}
/>
```

#### Step 2: Alternative - Add Redirect (10 min)

If you prefer redirect instead of duplicate route:

```typescript
// Add a redirect component
const BatchesRedirect = () => {
  const [, setLocation] = useLocation();
  useEffect(() => {
    setLocation('/inventory');
  }, [setLocation]);
  return null;
};

// Then add route
<Route path="/batches" component={BatchesRedirect} />
```

#### Step 3: Verify

```bash
# Start dev server
pnpm dev

# Test in browser
# Navigate to localhost:5173/batches
# Should show inventory page or redirect to /inventory
```

### Verification Checklist

- [ ] `/batches` no longer returns 404
- [ ] Inventory functionality accessible via `/batches`
- [ ] Navigation doesn't break existing `/inventory` route

---

## Task QA-003: Add Invoice Route Redirect

### Implementation Steps

#### Step 1: Add Redirect Route (10 min)

Open `client/src/App.tsx` and add redirect:

```typescript
// Add redirect component
import { Redirect } from 'wouter';

// Or use effect-based redirect
const InvoicesRedirect = () => {
  const [, setLocation] = useLocation();
  useEffect(() => {
    setLocation('/accounting/invoices');
  }, [setLocation]);
  return null;
};

// Add route before accounting routes
<Route path="/invoices" component={InvoicesRedirect} />
```

### Verification Checklist

- [ ] `/invoices` redirects to `/accounting/invoices`
- [ ] No circular redirect
- [ ] Existing `/accounting/invoices` still works

---

## Task QA-004: Fix Client-Side TypeScript Errors

### Implementation Steps

#### Fix 1: SalesSheetPreview.tsx:286

```typescript
// Add missing priceMarkup property to items
const itemsWithMarkup = items.map(item => ({
  ...item,
  priceMarkup: item.priceMarkup ?? 0,
  finalPrice: item.finalPrice ?? item.retailPrice,
}));
```

#### Fix 2: LiveShoppingSession.tsx:636

```typescript
// Either define priceChange or remove reference
// Option A: Define it
const priceChange = calculatePriceChange(/* params */);

// Option B: Remove undefined reference
// Find and remove the line using priceChange
```

#### Fix 3: OrderCreatorPage.tsx:188

```typescript
// Add version to mutation call
const { mutate: confirmOrder } = trpc.orders.confirm.useMutation();

// When calling
confirmOrder({ orderId: order.id, version: order.version ?? 1 });
```

#### Fix 4: SalesSheetCreatorPage.tsx:323

```typescript
// Fix type compatibility
const handleReorder = (items: SalesSheetItem[]) => {
  const pricedItems: PricedInventoryItem[] = items.map(item => ({
    ...item,
    priceMarkup: item.priceMarkup ?? 0,
    appliedRules: item.appliedRules ?? [],
  }));
  onReorder(pricedItems);
};
```

#### Fix 5: SearchResultsPage.tsx (4 errors)

```typescript
// Add proper type assertions
{
  result.description as ReactNode;
}

// Or with null check
{
  result.description ? String(result.description) : null;
}
```

#### Fix 6: LiveShoppingPage.tsx:67

```typescript
// Handle null case
const sessionId: string = params.sessionId ?? "";
// Or throw if required
if (!params.sessionId) throw new Error("Session ID required");
```

### Verification

```bash
pnpm tsc --noEmit
# Should show 0 errors in client/src
```

---

## Task QA-005: Fix Server-Side TypeScript Errors

### Implementation Steps

#### Fix 1: orders.ts:349

```typescript
// Check if productCategory exists on the type
// Option A: Use optional chaining
const category = batch?.productCategory ?? "Unknown";

// Option B: Add to select
const batchWithCategory = await db
  .select({
    ...batches,
    productCategory: products.category,
  })
  .from(batches)
  .leftJoin(products, eq(batches.productId, products.id));
```

#### Fix 2: vipPortalLiveShopping.ts:485

```typescript
// Fix SQL type comparison
// BEFORE - comparing varchar to number
gte(batches.onHandQty, minQuantity);

// AFTER - cast or use correct type
gte(sql`CAST(${batches.onHandQty} AS UNSIGNED)`, minQuantity);

// Or if onHandQty should be number in schema, fix the schema
```

### Verification

```bash
pnpm tsc --noEmit
# Should show 0 errors in server/
```

---

## Task QA-006: Add Navigation for Blocked Features

### Implementation Steps

#### Step 1: Update Navigation Config

Edit `client/src/config/navigation.ts`:

```typescript
// Add Todo Lists to navigation
{
  name: "Todo Lists",
  path: "/todos",
  icon: CheckSquare,
  group: "admin",
},

// Add Analytics (rename from Reports if needed)
{
  name: "Analytics",
  path: "/analytics",
  icon: BarChart3,
  group: "finance",
},
```

#### Step 2: Add Client Sub-navigation

The client detail page needs tabs for Activity, Tags, Notes, Communications. These likely exist but need to be visible. Check `ClientProfilePage.tsx` for tab configuration.

#### Step 3: Add Auth/Account Link

Add account settings to user menu in sidebar:

```typescript
// In Sidebar.tsx, add to user section
<Link href="/account">
  <a>Account Settings</a>
</Link>
```

### Verification Checklist

- [ ] Todo Lists visible in sidebar
- [ ] Analytics visible in sidebar
- [ ] Client Activity tab accessible
- [ ] Client Tags tab accessible
- [ ] Account settings accessible

---

## Task QA-007: Create Test Data Seeding

### Implementation Steps

#### Step 1: Create Seeding Script

Create `scripts/seed-test-data.ts`:

```typescript
import { getDb } from "../server/db";
import { orders, invoices, clients } from "../drizzle/schema";

async function seedTestData() {
  const db = await getDb();

  // Create test client
  const [testClient] = await db
    .insert(clients)
    .values({
      name: "QA Test Client",
      teriCode: "QA001",
      // ... other required fields
    })
    .$returningId();

  // Create draft order
  await db.insert(orders).values({
    clientId: testClient.id,
    status: "DRAFT",
    // ...
  });

  // Create confirmed order
  await db.insert(orders).values({
    clientId: testClient.id,
    status: "CONFIRMED",
    // ...
  });

  // Create completed order (for invoice generation)
  await db.insert(orders).values({
    clientId: testClient.id,
    status: "COMPLETED",
    // ...
  });

  console.log("Test data seeded successfully");
}

seedTestData().catch(console.error);
```

#### Step 2: Add npm Script

In `package.json`:

```json
{
  "scripts": {
    "seed:test-data": "tsx scripts/seed-test-data.ts"
  }
}
```

---

## Task QA-008: Add Safe Test Mode

### Implementation Steps

#### Step 1: Add Environment Variable

In `.env.example`:

```
TEST_MODE=false
```

#### Step 2: Create Test Guard

Create `server/_core/testMode.ts`:

```typescript
export const isTestMode = process.env.TEST_MODE === "true";

export function requireTestMode(operation: string) {
  if (!isTestMode) {
    throw new Error(`${operation} requires TEST_MODE=true`);
  }
}

export function markAsTestData<T extends { id: number }>(
  record: T
): T & { _isTestData: true } {
  return { ...record, _isTestData: true as const };
}
```

#### Step 3: Use in Destructive Operations

```typescript
// In delete endpoints
if (!isTestMode && !record._isTestData) {
  throw new Error("Cannot delete non-test data outside test mode");
}
```

---

## Rollback Plan

If any fix causes regression:

1. **Immediate:** Revert the specific commit
2. **Short-term:** Deploy previous known-good version
3. **Investigation:** Create isolated branch for debugging

### Git Commands for Rollback

```bash
# Identify problematic commit
git log --oneline -20

# Revert specific commit
git revert <commit-hash>

# Or reset to previous state (use with caution)
git reset --hard <known-good-commit>
```

---

## Post-Implementation Testing

### Regression Test Suite

```bash
# Full test suite
pnpm test

# Type checking
pnpm tsc --noEmit

# E2E smoke tests
pnpm test:smoke

# Manual verification
# 1. Navigate to /calendar - should load events
# 2. Navigate to /batches - should show inventory
# 3. Navigate to /invoices - should redirect
# 4. Create calendar event - should save
# 5. View calendar events - should display
```

### QA Re-test Checklist

After all fixes deployed, re-run the 274 test cases:

- [ ] Row 81-87 (Batches): Should PASS
- [ ] Row 171-175, 179, 187-189 (Calendar): Should PASS
- [ ] Navigation blockers: Should be reduced
- [ ] No new regressions in previously passing tests

---

## Sign-off Requirements

| Phase   | Implemented By | Reviewed By | QA Verified | Date |
| ------- | -------------- | ----------- | ----------- | ---- |
| Phase 1 |                |             |             |      |
| Phase 2 |                |             |             |      |
| Phase 3 |                |             |             |      |
| Phase 4 |                |             |             |      |
| Phase 5 |                |             |             |      |

---

**Document Owner:** Development Team Lead
**Last Updated:** January 11, 2026
