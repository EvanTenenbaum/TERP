# BUG-037: VIP Portal createdBy FK Constraint Violation

## Problem Statement

VIP Portal mutations (`createSupply` and `createNeed`) set `createdBy: clientId` but the database schema defines `createdBy` as a foreign key to `users.id`. This causes runtime FK constraint violations because `clientId` comes from the `clients` table, which has a completely different ID space than `users`.

## Affected Code

### VIP Portal Router (`server/routers/vipPortal.ts`)

**Line ~591 - createNeed mutation:**

```typescript
createdBy: clientId, // Use clientId for actor attribution
```

**Line ~705 - createSupply mutation:**

```typescript
createdBy: clientId, // Use clientId for actor attribution in VIP portal context
```

### Schema Definitions (`drizzle/schema.ts`)

**clientNeeds table (line ~3310):**

```typescript
createdBy: int("created_by")
  .notNull()
  .references(() => users.id, { onDelete: "restrict" }),
```

**vendorSupply table (line ~3372):**

```typescript
createdBy: int("created_by")
  .notNull()
  .references(() => users.id, { onDelete: "restrict" }),
```

## Root Cause Analysis

The VIP Portal authentication system (`vipPortalProcedure` in `server/_core/trpc.ts`) provides:

- `ctx.clientId` - The authenticated client's ID from the `clients` table
- `ctx.vipSession` - The VIP portal session object
- `ctx.actorId` - A string like `"vip:${clientId}"` for audit purposes

However, the `createdBy` columns in both `vendor_supply` and `client_needs` tables reference `users.id`, not `clients.id`. These are completely different tables:

- `users` table: Internal TERP users (employees, admins)
- `clients` table: External business entities (customers, suppliers)

## Impact

- **Severity:** ðŸ”´ CRITICAL
- **Runtime Behavior:** FK constraint violation error when VIP portal users try to create supply listings or needs
- **Feature Status:** VIP Portal supply/needs creation is completely broken
- **Data Risk:** Low (FK constraint prevents bad data from being inserted)

## Proposed Solutions

### Option 1: Add `createdByClientId` Column (RECOMMENDED)

Add a new nullable column for VIP portal actor attribution while keeping the existing `createdBy` for internal users.

**Schema Migration:**

```sql
-- Add new column for client attribution
ALTER TABLE vendor_supply ADD COLUMN created_by_client_id INT NULL;
ALTER TABLE client_needs ADD COLUMN created_by_client_id INT NULL;

-- Add FK constraints
ALTER TABLE vendor_supply ADD CONSTRAINT fk_vs_created_by_client
  FOREIGN KEY (created_by_client_id) REFERENCES clients(id);
ALTER TABLE client_needs ADD CONSTRAINT fk_cn_created_by_client
  FOREIGN KEY (created_by_client_id) REFERENCES clients(id);

-- Make createdBy nullable (for VIP portal actions)
ALTER TABLE vendor_supply MODIFY created_by INT NULL;
ALTER TABLE client_needs MODIFY created_by INT NULL;
```

**Code Changes:**

```typescript
// VIP Portal mutations
await db.insert(vendorSupply).values({
  ...input,
  createdByClientId: clientId, // VIP portal attribution
  // createdBy is null for VIP portal actions
});

// Internal user mutations (unchanged)
await db.insert(vendorSupply).values({
  ...input,
  createdBy: userId, // Internal user attribution
  // createdByClientId is null for internal actions
});
```

**Pros:**

- Preserves full audit trail
- Distinguishes VIP portal vs internal user actions
- No data loss
- Backward compatible

**Cons:**

- Requires schema migration
- Dual-column complexity

### Option 2: Create System User for VIP Actions

Create a dedicated "VIP Portal System" user in the `users` table and use that ID for all VIP portal mutations.

**Implementation:**

```typescript
// Create system user (one-time setup)
const VIP_SYSTEM_USER_ID = 999999; // Or fetch from config

// VIP Portal mutations
await db.insert(vendorSupply).values({
  ...input,
  createdBy: VIP_SYSTEM_USER_ID,
});
```

**Pros:**

- No schema changes
- Quick to implement

**Cons:**

- Loses granular client attribution
- All VIP actions attributed to one user
- Audit trail shows "VIP System" not "Client ABC"

### Option 3: Make `createdBy` Nullable

Simply make the `createdBy` column nullable and leave it null for VIP portal actions.

**Pros:**

- Simple schema change

**Cons:**

- Loses actor attribution entirely for VIP actions
- Bad for audit compliance

## Recommendation

**Option 1 (Add `createdByClientId`)** is recommended because:

1. Preserves complete audit trail
2. Clearly distinguishes VIP portal vs internal user actions
3. Follows the existing pattern of having separate columns for different entity types
4. Enables future reporting on VIP portal activity by client

## Acceptance Criteria

- [ ] VIP portal users can create supply listings without FK errors
- [ ] VIP portal users can create needs without FK errors
- [ ] Actor attribution is preserved for audit purposes
- [ ] Internal user mutations continue to work unchanged
- [ ] All existing data remains intact
- [ ] Tests cover both VIP portal and internal user creation paths
- [ ] Zero TypeScript errors
- [ ] All tests passing

## Testing Requirements

1. **Unit Tests:**
   - Test `createSupply` mutation with VIP portal context
   - Test `createNeed` mutation with VIP portal context
   - Verify FK constraints are satisfied

2. **Integration Tests:**
   - End-to-end VIP portal supply creation flow
   - End-to-end VIP portal needs creation flow

3. **Regression Tests:**
   - Verify internal user supply/needs creation still works
   - Verify existing data queries work correctly

## Files to Modify

1. `drizzle/schema.ts` - Add `createdByClientId` columns
2. `server/routers/vipPortal.ts` - Update mutations to use correct column
3. New migration file in `drizzle/` directory
4. Test files for VIP portal mutations

## Related Issues

- This issue was discovered during QUAL-003-W3 (Wave 3 TypeScript error resolution)
- The `createdBy: clientId` pattern was added as part of Task 21.2 (VIP Portal session verification)
