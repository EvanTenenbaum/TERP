# DI-005: Fix Startup Seeding Schema Drift

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-005 -->
<!-- TASK_TITLE: Fix Startup Seeding Schema Drift -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-005
**Estimated Time:** 4h
**Module:** `server/_core/index.ts`

## Context

**Background:**
Startup seeding at `server/_core/index.ts:161-183` is disabled due to schema drift. This means:
- No initial data on first run
- Manual setup required
- Inconsistent environments

**Goal:**
Fix schema drift and re-enable startup seeding.

**Success Criteria:**
- Seeding works on fresh database
- No schema drift errors
- Idempotent seeding (safe to run multiple times)

## Implementation Guide

### Step 1: Identify Schema Drift

Check what columns/tables are causing drift:
```bash
pnpm drizzle-kit push:sqlite --dry-run
```

Common issues:
- Seed data references non-existent columns
- Column types don't match
- Missing required fields

### Step 2: Update Seed Data

**File:** `server/_core/seedData.ts` (or similar)

Update seed data to match current schema:
```typescript
// Ensure all required fields are present
const defaultRoles = [
  { id: 1, name: "Super Admin", permissions: ["*"] },
  { id: 2, name: "Sales Manager", permissions: [...] },
  // ...
];
```

### Step 3: Make Seeding Idempotent

Use upsert pattern:
```typescript
async function seedRoles(db: Database) {
  for (const role of defaultRoles) {
    await db.insert(roles)
      .values(role)
      .onConflictDoUpdate({
        target: roles.id,
        set: { name: role.name, permissions: role.permissions }
      });
  }
}
```

### Step 4: Re-enable Startup Seeding

**File:** `server/_core/index.ts:161-183`

```typescript
// Remove the disabled flag
if (process.env.SEED_ON_STARTUP === "true") {
  await seedDatabase(db);
}
```

### Step 5: Add Validation

Validate seed data against schema before inserting:
```typescript
import { z } from "zod";

const roleSchema = z.object({
  id: z.number(),
  name: z.string(),
  permissions: z.array(z.string())
});

// Validate before insert
roleSchema.parse(role);
```

## Deliverables

- [ ] Identify all schema drift issues
- [ ] Update seed data to match current schema
- [ ] Implement idempotent seeding with upserts
- [ ] Re-enable startup seeding
- [ ] Add seed data validation
- [ ] Test on fresh database

## Quick Reference

**File to modify:** `server/_core/index.ts:161-183`

**Check schema status:**
```bash
pnpm drizzle-kit push:sqlite --dry-run
```

**Test fresh database:**
```bash
rm -f terp.db && pnpm dev
```
