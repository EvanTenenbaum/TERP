# DI-003: Add Transaction to Cascading Delete Operations

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-003 -->
<!-- TASK_TITLE: Add Transaction to Cascading Delete Operations -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-003
**Estimated Time:** 4h
**Module:** `server/routers/intakeReceipts.ts`

## Context

**Background:**
The intake receipts router at `server/routers/intakeReceipts.ts:1079-1087` performs cascading deletes without transaction wrapping. If the second delete fails, items become orphaned.

**Goal:**
Wrap cascading deletes in transactions to ensure atomicity.

**Success Criteria:**
- All cascading deletes are atomic
- No orphaned records on partial failure
- Proper error handling with rollback

## Implementation Guide

### Step 1: Identify Cascading Delete Pattern

Current code likely:
```typescript
// BAD: Not transactional
await db.delete(receiptItems).where(eq(receiptItems.receiptId, id));
await db.delete(receipts).where(eq(receipts.id, id));
// If second delete fails, items are already gone!
```

### Step 2: Wrap in Transaction

```typescript
import { withTransaction } from "../dbTransaction";

export async function deleteReceipt(receiptId: number) {
  return withTransaction(async (tx) => {
    // Delete child records first
    await tx.delete(receiptItems)
      .where(eq(receiptItems.receiptId, receiptId));

    // Then delete parent
    await tx.delete(receipts)
      .where(eq(receipts.id, receiptId));
  });
}
```

### Step 3: Find Other Cascading Deletes

Search for similar patterns:
```bash
grep -rn "delete.*where" server/ --include="*.ts" -A 2
```

Common locations:
- Orders and order items
- Invoices and line items
- Clients and related data
- Batches and movements

### Step 4: Update All Cascading Deletes

Apply the transaction pattern to all cascading deletes found.

### Step 5: Add Tests

Test that:
- Successful delete removes all related records
- Failed delete leaves all records intact (rollback)

## Deliverables

- [ ] Wrap `intakeReceipts.ts` cascading delete in transaction
- [ ] Find and fix other cascading delete operations
- [ ] Add error handling for delete failures
- [ ] Add tests for atomic delete behavior
- [ ] Document cascading delete patterns

## Quick Reference

**Primary file:** `server/routers/intakeReceipts.ts:1079-1087`

**Find other cascading deletes:**
```bash
grep -rn "\.delete(" server/routers/ --include="*.ts" | grep -v "\.d\.ts"
```
