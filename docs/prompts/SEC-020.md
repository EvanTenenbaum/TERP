# SEC-020: Protect 5 calendarRecurrence Public Mutations

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-020 -->
<!-- TASK_TITLE: Protect 5 calendarRecurrence Public Mutations -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** SEC-020
**Estimated Time:** 2h
**Module:** `server/routers/calendarRecurrence.ts`

## Context

**Background:**
The calendar recurrence router exposes 5 mutation endpoints using `publicProcedure`. These allow unauthenticated users to modify calendar data.

**Affected Mutations:**
1. `modifyInstance` - Modify a recurring event instance
2. `cancelInstance` - Cancel a recurring event instance
3. `regenerateInstances` - Regenerate recurring instances
4. `updateRecurrenceRule` - Update recurrence rules
5. `deleteRecurrenceRule` - Delete recurrence rules

**Goal:**
Change all 5 mutations from `publicProcedure` to `protectedProcedure`.

**Success Criteria:**
- All mutations require authentication
- Calendar functionality preserved for authenticated users
- Appropriate audit logging maintained

## Implementation Guide

### Step 1: Locate Public Mutations

Find all mutation definitions using `publicProcedure`.

### Step 2: Update Each Mutation

Change from:
```typescript
modifyInstance: publicProcedure
  .input(...)
  .mutation(...)
```

To:
```typescript
modifyInstance: protectedProcedure
  .input(...)
  .mutation(...)
```

### Step 3: Add Permission Checks

Add calendar-specific permissions:
```typescript
modifyInstance: protectedProcedure
  .use(requirePermission('calendar:write'))
  .input(...)
  .mutation(...)
```

### Step 4: Update Tests

Ensure test suite includes authenticated requests.

## Deliverables

- [ ] Change all 5 mutations from `publicProcedure` to `protectedProcedure`
- [ ] Add `calendar:write` permission middleware
- [ ] Update test files for calendar recurrence
- [ ] Verify frontend calendar integrations
- [ ] Add audit logging for mutations

## Quick Reference

**File to modify:** `server/routers/calendarRecurrence.ts`

**Validation command:**
```bash
grep "publicProcedure" server/routers/calendarRecurrence.ts | grep -c "mutation"
# Should return 0 after fix
```
