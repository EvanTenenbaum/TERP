# SEC-001: Fix Permission System Bypass

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-001 -->
<!-- TASK_TITLE: Fix Permission System Bypass -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-01-27 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** SEC-001  
**Estimated Time:** 2 days (16 hours)  
**Module:** `server/_core/permissionMiddleware.ts`, `server/_core/trpc.ts`

‚ö†Ô∏è **SECURITY WARNING**

- This is a CRITICAL P0 security fix
- Removing public access bypasses will require authentication for all protected endpoints
- Ensure Super Admin bypass still works (intentional feature)
- Test thoroughly before deploying to production

---

## üìã Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Development](#phase-3-development)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## üéØ Context

**Background:**

The permission middleware has public access bypass logic that allows unauthorized access to protected procedures when no user is present. This was temporarily added for production site verification but is a critical security vulnerability.

**Current Security Issues:**

1. **`server/_core/permissionMiddleware.ts`** - 3 bypass locations:
   - Line 32-41: `requirePermission()` bypasses when `!ctx.user`
   - Line 95-104: `requireAllPermissions()` bypasses when `!ctx.user`
   - Line 158-167: `requireAnyPermission()` bypasses when `!ctx.user`

2. **`server/_core/trpc.ts`** - 1 bypass location:
   - Line 77-82: `requireUser()` middleware has authentication check commented out

**Goal:**

Remove all public access bypasses while maintaining Super Admin bypass functionality. Require authentication for all protected procedures.

**Success Criteria:**

- [ ] All permission middleware functions require authentication (no public bypass)
- [ ] All protected procedures require user authentication
- [ ] Super Admin bypass still works correctly (intentional feature)
- [ ] Comprehensive tests verify permission enforcement
- [ ] All existing tests still pass
- [ ] No TypeScript errors
- [ ] Security audit confirms no unauthorized access possible

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-SEC-001-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Register Session (Atomic) ‚ö†Ô∏è CRITICAL

**This step prevents race conditions. Follow it exactly.**

1. `git pull origin main` (to get the latest `ACTIVE_SESSIONS.md`)
2. Read `docs/ACTIVE_SESSIONS.md` and check for module conflicts.
   - Check for any sessions working on: `server/_core/permissionMiddleware.ts`, `server/_core/trpc.ts`
3. If clear, add your session to the file.
4. Commit and push **immediately**:
   ```bash
   git add docs/ACTIVE_SESSIONS.md
   git commit -m "Register session for SEC-001"
   git push origin main
   ```
5. **If the push fails due to a conflict, another agent registered first.** STOP, pull again, and re-evaluate. Do not proceed until your session is successfully pushed to `main`.

### Step 1.3: Verify Environment

Run these commands:

```bash
node --version
git status
git log --oneline -5
```

### Step 1.4: Verify Permissions

Test your push access before starting work:
```bash
git push --dry-run origin main
```
If this command fails, you do not have the required permissions. STOP and ask the user for write access to the repository.

### Step 1.5: Review Current Code

Read and understand the current bypass implementation:

```bash
# Review permission middleware
cat server/_core/permissionMiddleware.ts

# Review tRPC setup
cat server/_core/trpc.ts

# Review existing tests
cat server/services/permissionService.test.ts
cat server/routers/rbac-permissions.test.ts
```

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b SEC-001-fix-permission-bypass
```

### Step 2.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Change the status of SEC-001 from `üìã PLANNED` to `‚è≥ IN PROGRESS`.

### Step 2.3: Update Session File Progress

Update your session file with your progress.

---

## Phase 3: Development

**Objective:** Remove all public access bypasses while maintaining Super Admin functionality.

### Step 3.1: Remove Bypass from `requirePermission()`

**File:** `server/_core/permissionMiddleware.ts`

**Current Code (Lines 32-41):**
```typescript
// PUBLIC ACCESS MODE: Allow all permissions when no user is present
// User explicitly requested public access for production site verification
// TODO: Re-enable permission checks when ready for secure access
if (!ctx.user) {
  logger.debug({ 
    msg: "Permission check bypassed: public access mode (no user)", 
    permission: permissionName 
  });
  return next({ ctx });
}
```

**Action:** Remove this entire block. The function should immediately check for user and throw UNAUTHORIZED if missing.

**Updated Code Should Be:**
```typescript
export function requirePermission(permissionName: string) {
  return middleware(async ({ ctx, next }) => {
    // Require authentication - no public access
    if (!ctx.user) {
      logger.warn({ 
        msg: "Permission check failed: no user", 
        permission: permissionName 
      });
      throw new TRPCError({
        code: "UNAUTHORIZED",
        message: "Authentication required to perform this action",
      });
    }

    const userId = ctx.user.openId; // Use Clerk user ID

    // Super Admins bypass all permission checks (intentional feature)
    const isSA = await isSuperAdmin(userId);
    if (isSA) {
      logger.debug({ 
        msg: "Permission check bypassed for Super Admin", 
        userId, 
        permission: permissionName 
      });
      return next({ ctx });
    }

    // Check if user has the required permission
    const hasIt = await hasPermission(userId, permissionName);

    if (!hasIt) {
      logger.warn({ 
        msg: "Permission denied", 
        userId, 
        permission: permissionName 
      });
      throw new TRPCError({
        code: "FORBIDDEN",
        message: `You do not have permission to perform this action. Required permission: ${permissionName}`,
      });
    }

    logger.debug({ 
      msg: "Permission check passed", 
      userId, 
      permission: permissionName 
    });

    return next({ ctx });
  });
}
```

### Step 3.2: Remove Bypass from `requireAllPermissions()`

**File:** `server/_core/permissionMiddleware.ts`

**Current Code (Lines 95-104):** Same bypass pattern as Step 3.1

**Action:** Remove the bypass block (lines 95-104). Add authentication check at the start:

```typescript
// Require authentication - no public access
if (!ctx.user) {
  logger.warn({ 
    msg: "Permission check failed: no user", 
    permissions: permissionNames 
  });
  throw new TRPCError({
    code: "UNAUTHORIZED",
    message: "Authentication required to perform this action",
  });
}
```

### Step 3.3: Remove Bypass from `requireAnyPermission()`

**File:** `server/_core/permissionMiddleware.ts`

**Current Code (Lines 158-167):** Same bypass pattern as Step 3.1

**Action:** Remove the bypass block (lines 158-167). Add authentication check at the start (same pattern as Step 3.2).

### Step 3.4: Fix Authentication in `protectedProcedure`

**File:** `server/_core/trpc.ts`

**Current Code (Lines 77-82):**
```typescript
// PUBLIC ACCESS MODE: Allow null users (authentication optional)
// User explicitly requested public access for production site verification
// TODO: Re-enable authentication when ready for secure access
// if (!ctx.user) {
//   throw new TRPCError({ code: "UNAUTHORIZED", message: UNAUTHED_ERR_MSG });
// }
```

**Action:** Uncomment the authentication check:

```typescript
const requireUser = t.middleware(async opts => {
  const { ctx, next } = opts;

  // Require authentication - no public access
  if (!ctx.user) {
    throw new TRPCError({ code: "UNAUTHORIZED", message: UNAUTHED_ERR_MSG });
  }

  return next({
    ctx: {
      ...ctx,
      user: ctx.user,
    },
  });
});
```

### Step 3.5: Fix Authentication in `adminProcedure`

**File:** `server/_core/trpc.ts`

**Current Code (Lines 104-109):** Admin check is commented out

**Action:** Uncomment the admin check:

```typescript
export const adminProcedure = t.procedure
  .use(errorHandlingMiddleware)
  .use(sanitizationMiddleware)
  .use(
    t.middleware(async opts => {
      const { ctx, next } = opts;

      // Require authentication and admin role
      if (!ctx.user) {
        throw new TRPCError({ code: "UNAUTHORIZED", message: UNAUTHED_ERR_MSG });
      }
      if (ctx.user.role !== 'admin') {
        throw new TRPCError({ code: "FORBIDDEN", message: NOT_ADMIN_ERR_MSG });
      }

      return next({
        ctx: {
          ...ctx,
          user: ctx.user,
        },
      });
    }),
  );
```

**Note:** Check if `ctx.user.role` is the correct property. Review `TrpcContext` type to verify.

### Step 3.6: Write Comprehensive Tests

**File:** `server/_core/permissionMiddleware.test.ts` (create if doesn't exist)

**Test Cases Required:**

1. **`requirePermission()` tests:**
   - ‚úÖ Should throw UNAUTHORIZED when no user
   - ‚úÖ Should throw FORBIDDEN when user lacks permission
   - ‚úÖ Should pass when user has permission
   - ‚úÖ Should bypass for Super Admin

2. **`requireAllPermissions()` tests:**
   - ‚úÖ Should throw UNAUTHORIZED when no user
   - ‚úÖ Should throw FORBIDDEN when user lacks any permission
   - ‚úÖ Should pass when user has all permissions
   - ‚úÖ Should bypass for Super Admin

3. **`requireAnyPermission()` tests:**
   - ‚úÖ Should throw UNAUTHORIZED when no user
   - ‚úÖ Should throw FORBIDDEN when user lacks all permissions
   - ‚úÖ Should pass when user has any permission
   - ‚úÖ Should bypass for Super Admin

4. **Integration tests:**
   - ‚úÖ Test protectedProcedure requires authentication
   - ‚úÖ Test adminProcedure requires admin role
   - ‚úÖ Test actual endpoint protection

**Test Template:**

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";
import { TRPCError } from "@trpc/server";
import { requirePermission } from "./permissionMiddleware";
import { setupDbMock } from "../test-utils/testDb";
import { setupPermissionMock } from "../test-utils/testPermissions";

// Mock the database
vi.mock("../db", () => setupDbMock());
// Mock permission service
vi.mock("../services/permissionService", () => setupPermissionMock());

describe("requirePermission", () => {
  it("should throw UNAUTHORIZED when no user", async () => {
    const middleware = requirePermission("orders:create");
    const ctx = { user: null }; // No user
    
    await expect(
      middleware({ ctx, next: async () => ({ ctx }) })
    ).rejects.toThrow(TRPCError);
    // Verify error code is UNAUTHORIZED
  });

  it("should bypass for Super Admin", async () => {
    // Test Super Admin bypass still works
  });

  // Add more test cases...
});
```

### Step 3.7: Run Tests After Each Change

After each file modification:

```bash
# Run TypeScript check
npm run check  # or pnpm check if available

# Run tests
npm test  # or pnpm test if available

# Run specific test file
npm test permissionMiddleware.test.ts
```

**Fix any failing tests immediately.**

---

## Phase 4: Completion

**Objective:** Finalize your work and submit it for review.

### Step 4.1: Verify All Deliverables

Ensure all deliverables listed in the roadmap have been completed:

- [x] Remove bypass logic from `requirePermission()`, `requireAllPermissions()`, `requireAnyPermission()`
- [x] Remove bypass logic from `protectedProcedure` in `trpc.ts`
- [x] Remove bypass logic from `adminProcedure` in `trpc.ts`
- [x] Add unit and integration tests for permission enforcement
- [ ] Security audit verification (manual review)
- [x] All tests passing
- [x] Zero TypeScript errors
- [ ] Session archived

### Step 4.2: Final Test Run

```bash
# TypeScript compilation
npm run check

# All tests
npm test

# Run permission-related tests specifically
npm test permissionMiddleware
npm test rbac-permissions
npm test auth.integration
```

**All tests MUST pass before proceeding.**

### Step 4.3: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Change SEC-001 status from `‚è≥ IN PROGRESS` to `‚úÖ COMPLETE` and add:

- Completion date
- Key commits
- Actual time spent
- Test results summary

### Step 4.4: Create Completion Report

**File:** `docs/completion-reports/SEC-001-COMPLETION.md`

Use template: `docs/templates/COMPLETION_REPORT_TEMPLATE.md`

Include:
- Summary of changes
- Files modified
- Tests added
- Security impact
- Verification steps

### Step 4.5: Update ACTIVE_SESSIONS.md

Mark your session as complete.

### Step 4.6: Commit and Push

```bash
git add .
git commit -m "SEC-001: Fix permission system bypass - require authentication for all protected procedures

- Remove public access bypass from requirePermission()
- Remove public access bypass from requireAllPermissions()
- Remove public access bypass from requireAnyPermission()
- Require authentication in protectedProcedure
- Require admin role in adminProcedure
- Add comprehensive permission enforcement tests
- Super Admin bypass still works (intentional feature)

All tests passing. Security vulnerability resolved."

git push origin SEC-001-fix-permission-bypass
```

### Step 4.7: Merge to Main

```bash
git checkout main
git pull origin main
git merge SEC-001-fix-permission-bypass --no-ff -m "Merge SEC-001: Fix permission system bypass"
git push origin main
```

### Step 4.8: Verify Deployment

After push, monitor deployment:

```bash
# Check deployment status (if script available)
bash scripts/check-deployment-status.sh
```

Or manually verify:
- No TypeScript errors in deployment logs
- Application starts successfully
- Authentication required for protected endpoints

---

## ‚ö° Quick Reference

### Files to Modify

1. `server/_core/permissionMiddleware.ts` - Remove 3 bypass blocks
2. `server/_core/trpc.ts` - Uncomment authentication checks (2 locations)
3. `server/_core/permissionMiddleware.test.ts` - Add comprehensive tests

### Key Functions

- `requirePermission(permissionName: string)` - Lines 30-79
- `requireAllPermissions(permissionNames: string[])` - Lines 93-142
- `requireAnyPermission(permissionNames: string[])` - Lines 156-205
- `requireUser` middleware - Lines 74-90 in trpc.ts
- `adminProcedure` middleware - Lines 97-118 in trpc.ts

### Test Files

- `server/services/permissionService.test.ts` - Permission service tests
- `server/routers/rbac-permissions.test.ts` - RBAC router tests
- `server/auth.integration.test.ts` - Auth integration tests
- `server/_core/permissionMiddleware.test.ts` - **Create this**

### Constants

- `UNAUTHED_ERR_MSG` - From `@shared/const`
- `NOT_ADMIN_ERR_MSG` - From `@shared/const`

---

## üÜò Troubleshooting

### Issue: Tests fail after removing bypass

**Solution:** 
- Update test mocks to provide user context
- Use `setupPermissionMock()` from test utilities
- Ensure all test cases include user in context

### Issue: Super Admin bypass not working

**Solution:**
- Verify `isSuperAdmin()` function works correctly
- Check user ID format matches expected format
- Review permission service implementation

### Issue: TypeScript errors about missing user property

**Solution:**
- Check `TrpcContext` type definition
- Verify user property is properly typed
- May need to update type definitions

### Issue: Deployment fails after merge

**Solution:**
- Verify all tests pass locally
- Check TypeScript compilation succeeds
- Review deployment logs for specific errors
- May need to rollback and fix issues

### Issue: Some endpoints break after authentication required

**Solution:**
- This is expected - endpoints that relied on public access will now require auth
- Review which endpoints are affected
- May need to create public versions or update frontend to handle auth
- Document breaking changes in completion report

---

**Last Updated:** 2025-01-27  
**Prompt Version:** 1.0  
**Status:** Ready for Execution

