# WF-004: Add Workflow Automation - Auto-Create Tasks on Status Change

## Implementation Guide

### Problem

When batch status changes (via Kanban drag):

| Step | What Happens                          | What's Missing |
| ---- | ------------------------------------- | -------------- |
| 1    | `updateBatchStatus()` called          | ✅             |
| 2    | `batch_status_history` record created | ✅             |
| 3    | Task created for next action          | ❌ **MISSING** |
| 4    | Notification sent to responsible role | ❌ **MISSING** |

**Current workflow_statuses table** (`drizzle/schema.ts:5842`):

```typescript
{
  (id, name, slug, color, order, isActive, createdAt, updatedAt);
}
// Note: NO responsibleRoleId, NO autoCreateTask, NO taskTemplate
```

**Current batch_status_history table** (`drizzle/schema.ts:5868`):

```typescript
{
  (id, batchId, fromStatusId, toStatusId, changedBy, notes, createdAt);
}
// Note: NO slaDeadline, NO isEscalated
```

### Solution

**Step 1: Extend workflow_statuses table**

```typescript
// drizzle/schema.ts - Add to workflowStatuses
responsibleRoleId: int("responsibleRoleId").references(() => roles.id, { onDelete: "set null" }),
autoCreateTask: int("autoCreateTask").notNull().default(0),  // 0 = false, 1 = true
taskTemplate: varchar("taskTemplate", { length: 255 }),  // e.g., "Review batch {batchCode}"
slaMinutes: int("slaMinutes"),  // Time allowed in this status
escalationRoleId: int("escalationRoleId").references(() => roles.id, { onDelete: "set null" }),
```

**Step 2: Create WorkflowOrchestrationService**

```typescript
// server/services/workflowOrchestrationService.ts (NEW FILE)
import { sendNotification } from "./notificationService";
import { createTodoTask } from "../routers/todoTasks";
import { getUsersByRoleId } from "../db/queries/users";

export async function onStatusChange(
  batchId: number,
  fromStatusId: number | null,
  toStatusId: number,
  changedBy: number
): Promise<void> {
  const db = await getDb();

  // Get the new status configuration
  const [newStatus] = await db
    .select()
    .from(workflowStatuses)
    .where(eq(workflowStatuses.id, toStatusId));

  if (!newStatus?.autoCreateTask) return;

  // Get batch info for task template
  const [batch] = await db
    .select()
    .from(batches)
    .where(eq(batches.id, batchId));
  if (!batch) return;

  // Interpolate task template
  const taskTitle =
    newStatus.taskTemplate
      ?.replace("{batchCode}", batch.batchCode || "")
      ?.replace("{batchId}", String(batchId)) ||
    `Process batch ${batch.batchCode}`;

  // Create task
  const dueDate = newStatus.slaMinutes
    ? new Date(Date.now() + newStatus.slaMinutes * 60 * 1000)
    : undefined;

  const task = await createTask({
    title: taskTitle,
    assignedToRoleId: newStatus.responsibleRoleId,
    dueDate,
    linkedBatchId: batchId,
    createdBy: changedBy,
  });

  // Notify users in responsible role
  if (newStatus.responsibleRoleId) {
    const usersInRole = await getUsersByRoleId(newStatus.responsibleRoleId);

    for (const user of usersInRole) {
      await sendNotification({
        recipientType: "user",
        userId: user.id,
        type: "info",
        title: `New Task: ${taskTitle}`,
        message: `Batch ${batch.batchCode} needs attention`,
        link: `/todos?taskId=${task.id}`,
        channel: "in_app",
      });
    }
  }
}
```

**Step 3: Wire into workflow-queue.ts**

```typescript
// server/routers/workflow-queue.ts - In updateBatchStatus mutation
import { onStatusChange } from "../services/workflowOrchestrationService";

// After updating batch status:
await onStatusChange(
  input.batchId,
  previousStatusId,
  input.statusId,
  ctx.user.id
);
```

### Files to Modify

| File                                              | Changes                       |
| ------------------------------------------------- | ----------------------------- |
| `drizzle/schema.ts:5842`                          | Add workflow metadata columns |
| `drizzle/migrations/XXXX.sql`                     | ALTER TABLE statements        |
| `server/services/workflowOrchestrationService.ts` | **NEW FILE**                  |
| `server/routers/workflow-queue.ts`                | Call onStatusChange           |
| `client/src/pages/WorkflowQueuePage.tsx`          | Status config UI (optional)   |

### Verification

```bash
# 1. Verify new columns exist
grep -A15 "workflowStatuses" drizzle/schema.ts | grep -E "responsibleRoleId|autoCreateTask|taskTemplate"

# 2. Verify orchestration service exists
ls -la server/services/workflowOrchestrationService.ts

# 3. Verify wiring in workflow-queue
grep -n "onStatusChange" server/routers/workflow-queue.ts

# 4. Test manually
# - Configure a status with autoCreateTask = 1
# - Drag batch to that status
# - Verify task created and notification sent
```

### Acceptance Criteria

- [ ] `workflow_statuses` table has new columns
- [ ] `workflowOrchestrationService.ts` created
- [ ] Status change triggers task creation (when configured)
- [ ] Task assigned to configured role
- [ ] Notification sent to users in role
- [ ] SLA deadline set on task

### Estimate

2 days
