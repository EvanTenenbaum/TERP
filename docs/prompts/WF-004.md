# WF-004: Add Workflow Automation - Auto-Create Tasks on Status Change

## Implementation Guide

### Problem

When batch status changes (via Kanban drag):

1. `updateBatchStatus()` is called
2. `batchStatusHistory` record is created
3. **That's it!** No task creation, no notification

**What SHOULD happen:**

1. Status change creates automatic task for next action
2. Task assigned to role responsible for that status
3. Notification sent to that role
4. When task completed, status can advance

### Solution

**Step 1: Add workflow metadata to statuses**

```sql
ALTER TABLE workflow_statuses ADD COLUMN responsibleRoleId INT REFERENCES roles(id);
ALTER TABLE workflow_statuses ADD COLUMN autoCreateTask BOOLEAN DEFAULT false;
ALTER TABLE workflow_statuses ADD COLUMN taskTemplate VARCHAR(255);
ALTER TABLE workflow_statuses ADD COLUMN slaMinutes INT;
ALTER TABLE workflow_statuses ADD COLUMN escalationRoleId INT REFERENCES roles(id);
```

**Step 2: Create WorkflowOrchestrationService**

```typescript
// server/services/workflowOrchestrationService.ts
export async function onStatusChange(
  batchId: number,
  fromStatusId: number,
  toStatusId: number,
  changedBy: number
) {
  const newStatus = await getStatusById(toStatusId);

  if (newStatus.autoCreateTask) {
    const task = await createTask({
      title: interpolate(newStatus.taskTemplate, { batchId, batchCode }),
      assignedToRole: newStatus.responsibleRoleId,
      dueDate: addMinutes(new Date(), newStatus.slaMinutes),
      linkedBatchId: batchId,
    });

    // Notify responsible role
    const usersInRole = await getUsersByRole(newStatus.responsibleRoleId);
    await sendBulkNotification(usersInRole, {
      title: `New Task: ${task.title}`,
      link: `/tasks/${task.id}`,
    });
  }
}
```

**Step 3: Wire into workflow-queue.ts**

```typescript
// In updateBatchStatus mutation:
await workflowOrchestrationService.onStatusChange(
  batchId,
  fromStatusId,
  toStatusId,
  userId
);
```

### Files to Modify

- `drizzle/schema.ts` - Add columns to workflow_statuses
- `server/services/workflowOrchestrationService.ts` (NEW)
- `server/db/queries/workflow-queue.ts` - Call orchestration
- `server/routers/workflow-queue.ts` - Expose status config
- `client/src/pages/WorkflowQueuePage.tsx` - Status settings UI

### Acceptance Criteria

- Status change triggers task creation (if configured)
- Task assigned to configured role
- Notification sent to responsible users
- SLA tracking works (optional for MVP)

### Estimate

2 days
