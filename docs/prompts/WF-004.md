# WF-004: Data Integrity Verification

<!-- METADATA (for validation) -->
<!-- TASK_ID: WF-004 -->
<!-- TASK_TITLE: Data Integrity Verification -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-11-22 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** WF-004  
**Priority:** P1 (HIGH - DATA QUALITY)  
**Estimated Time:** 6-8 hours  
**Module:** Testing, Verification  
**Dependencies:** ST-019 âœ…, WF-001, WF-002, WF-003 (all must complete first)

---

## ðŸ“‹ Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Verification](#phase-3-verification)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## ðŸŽ¯ Context

**Background:**
ST-019 (Happy Path Testing) has been completed, fixing division by zero and floating-point comparison issues. WF-001, WF-002, and WF-003 have verified individual workflows. This task creates comprehensive data integrity tests across all workflows to ensure referential integrity, financial accuracy, and data consistency.

**Goal:**
Create a comprehensive test suite that verifies data integrity across all workflows, including foreign key relationships, financial calculations, audit trails, and soft deletes.

**Success Criteria:**

- [ ] Test suite created for data integrity
- [ ] Foreign key relationships verified
- [ ] Financial calculations validated (no floating-point errors)
- [ ] Audit trails verified
- [ ] Soft deletes verified
- [ ] All tests passing
- [ ] Verification report created

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-WF-004-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Register Session (Atomic) âš ï¸ CRITICAL

**This step prevents race conditions. Follow it exactly.**

1. `git pull origin main` (to get the latest `ACTIVE_SESSIONS.md`)
2. Read `docs/ACTIVE_SESSIONS.md` and check for module conflicts.
3. If clear, add your session to the file.
4. Commit and push **immediately**:
   ```bash
   git add docs/ACTIVE_SESSIONS.md
   git commit -m "Register session for WF-004"
   git push origin main
   ```
5. **If the push fails due to a conflict, another agent registered first.** STOP, pull again, and re-evaluate.

### Step 1.3: Verify Dependencies

**CRITICAL:** Verify all dependencies are complete:
- [ ] ST-019 âœ… Complete
- [ ] WF-001 âœ… Complete
- [ ] WF-002 âœ… Complete
- [ ] WF-003 âœ… Complete

If any dependency is not complete, STOP and wait.

### Step 1.4: Verify Environment

```bash
node --version
pnpm --version
git status
```

### Step 1.5: Verify Permissions

Test your push access: `git push --dry-run origin main`

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b wf-004-data-integrity-verification
```

### Step 2.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Find the WF-004 task and update status to `â³ IN PROGRESS`.

### Step 2.3: Update Session File Progress

Update your session file with your progress.

---

## Phase 3: Verification

**Objective:** Create comprehensive data integrity test suite.

### Step 3.1: Create Test Suite Structure

**File:** `tests/integration/data-integrity.test.ts`

**Structure:**
```typescript
describe('Data Integrity Tests', () => {
  describe('Foreign Key Relationships', () => {
    // Tests for all foreign key relationships
  });
  
  describe('Financial Calculations', () => {
    // Tests for financial accuracy
  });
  
  describe('Audit Trails', () => {
    // Tests for audit log completeness
  });
  
  describe('Soft Deletes', () => {
    // Tests for soft delete functionality
  });
  
  describe('Workflow Data Integrity', () => {
    // Tests for each workflow
  });
});
```

### Step 3.2: Test Foreign Key Relationships

**Test Cases:**
1. Orders â†’ Clients (clientId)
2. Order Line Items â†’ Orders (orderId)
3. Order Line Items â†’ Batches (batchId)
4. Batches â†’ Products (productId)
5. Batches â†’ Lots (lotId)
6. Lots â†’ Products (productId)
7. Products â†’ Brands (brandId)
8. Brands â†’ Vendors (vendorId)
9. Returns â†’ Orders (orderId)
10. Returns â†’ Batches (batchId in items)
11. Inventory Movements â†’ Batches (batchId)
12. Workflow Queue â†’ Batches (batchId)
13. Audit Logs â†’ Users (userId)
14. All other foreign key relationships

**Expected Results:**
- All foreign keys reference existing records
- No orphaned records
- Cascade deletes work correctly (where applicable)
- Foreign key constraints enforced

**Implementation:**
- Query database for orphaned records
- Verify foreign key constraints exist
- Test cascade delete behavior

**Document:** Record results in verification report

### Step 3.3: Test Financial Calculations

**Test Cases:**
1. Order totals calculation
   - Subtotal = sum of line items
   - Tax calculation (if applicable)
   - Total = subtotal + tax
   - Margin calculations
   - COGS calculations
2. Payment application
   - AR balance reduction
   - Ledger entry balancing (debits = credits)
3. Invoice calculations
   - Line item totals
   - Invoice total
   - Tax calculations
4. Floating-point precision
   - Use epsilon comparisons (from ST-019)
   - No division by zero errors
   - Accurate decimal handling

**Expected Results:**
- All calculations accurate
- No floating-point errors
- No division by zero
- Financial balances reconcile

**Implementation:**
- Test calculation functions
- Verify epsilon comparisons used
- Test edge cases (zero values, very large numbers)

**Document:** Record results in verification report

### Step 3.4: Test Audit Trails

**Test Cases:**
1. Order creation creates audit log
2. Order update creates audit log
3. Return processing creates audit log
4. Inventory intake creates audit log
5. Status changes create audit logs
6. User context preserved in all audit logs
7. Timestamps are set correctly
8. Action types are correct

**Expected Results:**
- All critical actions create audit logs
- User ID is always set (not null or default)
- Timestamps are accurate
- Action types are descriptive
- Entity references are correct

**Implementation:**
- Query audit logs for recent actions
- Verify user IDs are set
- Verify timestamps are reasonable
- Verify action types match operations

**Document:** Record results in verification report

### Step 3.5: Test Soft Deletes

**Test Cases:**
1. Soft delete a client
   - Verify deletedAt is set
   - Verify record not returned in normal queries
   - Verify record still exists in database
2. Soft delete an order
   - Verify deletedAt is set
   - Verify related records handled correctly
3. Soft delete a batch
   - Verify deletedAt is set
   - Verify inventory calculations exclude deleted
4. Restore soft-deleted record
   - Verify deletedAt cleared
   - Verify record returned in queries

**Expected Results:**
- Soft deletes set deletedAt timestamp
- Soft-deleted records excluded from queries
- Records still exist in database
- Restore functionality works

**Implementation:**
- Test soft delete operations
- Verify query filters exclude soft-deleted
- Test restore functionality

**Document:** Record results in verification report

### Step 3.6: Test Workflow Data Integrity

**Test Cases:**

**Order Creation Workflow (WF-001):**
1. Create order â†’ verify all related records created
2. Verify order line items linked correctly
3. Verify inventory reduced (for SALE orders)
4. Verify audit logs created

**Inventory Intake Workflow (WF-002):**
1. Create purchase â†’ verify batch created
2. Verify vendor/brand/product relationships
3. Verify location assigned
4. Verify workflow queue entry created

**Returns Workflow (WF-003):**
1. Process return â†’ verify return record created
2. Verify inventory restocked
3. Verify batch status updated
4. Verify audit logs created

**Expected Results:**
- All workflows create complete data sets
- No orphaned records
- All relationships maintained
- Audit trails complete

**Implementation:**
- Test each workflow end-to-end
- Verify all related records created
- Check for orphaned records

**Document:** Record results in verification report

### Step 3.7: Create Validation Scripts

**File:** `scripts/validate-data-integrity.ts`

**Include checks for:**
- Foreign key integrity
- Financial calculation accuracy
- Audit trail completeness
- Soft delete functionality
- Workflow data completeness

**Usage:**
```bash
tsx scripts/validate-data-integrity.ts
```

### Step 3.8: Run All Tests

**Commands:**
```bash
# Run integration tests
pnpm test:integration

# Run data integrity validation
tsx scripts/validate-data-integrity.ts

# Verify all tests pass
```

**Expected Results:**
- All tests pass
- No errors or warnings
- Validation script reports success

**Document:** Record results in verification report

---

## Phase 4: Completion

**Objective:** Finalize verification and create report.

### Step 4.1: Create Verification Report

**File:** `docs/WF-004-VERIFICATION-REPORT.md`

**Include:**
- Summary of data integrity verification
- Results for each test category
- Test coverage statistics
- Any issues found
- Recommendations for improvements
- Test suite documentation

### Step 4.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Update WF-004:
- Change status to `âœ… COMPLETE`
- Add completion date: `(Completed: YYYY-MM-DD)`
- Add actual time spent
- Link to verification report

### Step 4.3: Archive Session File

Move session file from `docs/sessions/active/` to `docs/sessions/completed/`.

### Step 4.4: Commit and Push

```bash
git add .
git commit -m "Complete WF-004: Data Integrity Verification"
git push origin wf-004-data-integrity-verification:main
```

**Note:** Push directly to main (no PR needed per protocol).

### Step 4.5: Verify Deployment

Wait for deployment to complete and verify in production.

---

## âš¡ Quick Reference

**Key Files:**
- `tests/integration/data-integrity.test.ts` - Test suite
- `scripts/validate-data-integrity.ts` - Validation script
- `drizzle/schema.ts` - Database schema (for foreign keys)

**Key Database Tables:**
- All tables with foreign key relationships
- `auditLogs` - Audit trail
- Tables with soft deletes (deletedAt column)

**Key Test Areas:**
- Foreign key relationships
- Financial calculations
- Audit trails
- Soft deletes
- Workflow data integrity

---

## ðŸ†˜ Troubleshooting

**Issue:** Foreign key violations
- **Solution:** Check cascade delete settings, verify data cleanup

**Issue:** Financial calculation errors
- **Solution:** Check ST-019 fixes, verify epsilon comparisons

**Issue:** Missing audit logs
- **Solution:** Check audit log creation logic, verify user context

---

**Last Updated:** November 22, 2025

