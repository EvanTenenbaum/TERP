# BUG-010: Global Search Bar Returns 404 Error

<!-- METADATA (for validation) -->
<!-- TASK_ID: BUG-010 -->
<!-- TASK_TITLE: Global Search Bar Returns 404 Error -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-11-22 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** BUG-010  
**Priority:** P1 (HIGH - BROKEN FEATURE)  
**Estimated Time:** 2-4 hours  
**Module:** Navigation, Search

---

## üìã Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Development](#phase-3-development)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## üéØ Context

**Background:**
The global search bar in the application header navigates to `/search?q=<query>` when the user presses Enter, but this route does not exist in the application routing, resulting in a 404 error. The search bar is present on all pages and indicates it should search "quotes, customers, products" but the functionality is incomplete.

**Goal:**
Implement the search route and functionality to make the global search bar functional. The search should work across quotes, customers, and products as indicated by the placeholder text.

**Success Criteria:**

- [ ] `/search` route implemented in client routing
- [ ] Search results page displays results for quotes, customers, and products
- [ ] Search functionality queries backend for matching records
- [ ] Results are displayed in a user-friendly format
- [ ] Search query parameter is properly handled
- [ ] All tests passing
- [ ] Zero TypeScript errors

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-BUG-010-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Register Session (Atomic) ‚ö†Ô∏è CRITICAL

**This step prevents race conditions. Follow it exactly.**

1. `git pull origin main` (to get the latest `ACTIVE_SESSIONS.md`)
2. Read `docs/ACTIVE_SESSIONS.md` and check for module conflicts.
3. If clear, add your session to the file.
4. Commit and push **immediately**:
   ```bash
   git add docs/ACTIVE_SESSIONS.md
   git commit -m "Register session for BUG-010"
   git push origin main
   ```
5. **If the push fails due to a conflict, another agent registered first.** STOP, pull again, and re-evaluate.

### Step 1.3: Verify Environment

```bash
node --version
pnpm --version
git status
```

### Step 1.4: Verify Permissions

Test your push access: `git push --dry-run origin main`

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b bug-010-global-search-fix
```

### Step 2.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Find the BUG-010 task and update status to `‚è≥ IN PROGRESS`.

### Step 2.3: Update Session File Progress

Update your session file with your progress.

---

## Phase 3: Development

**Objective:** Implement search route and functionality.

### Step 3.1: Investigate Current State

**Files to check:**
- `client/src/components/layout/AppHeader.tsx` - Search bar implementation (line ~52-59)
- `client/src/App.tsx` - Routing configuration
- Check if backend search endpoints exist

**Current behavior:**
- Search bar navigates to `/search?q=<query>` (line 57 in AppHeader.tsx)
- Route `/search` does not exist in App.tsx
- Returns 404 error

### Step 3.2: Check Backend Search Endpoints

Search for existing search functionality:

```bash
grep -r "search" server/routers --include="*.ts" | grep -i "search"
```

**Expected endpoints:**
- Search quotes
- Search customers/clients
- Search products/batches

**If endpoints don't exist:**
- Create search router or add search procedures to existing routers
- Implement search logic for quotes, customers, products

### Step 3.3: Create Search Results Page

**File:** `client/src/pages/SearchResultsPage.tsx`

**Requirements:**
- Accept query parameter from URL (`/search?q=<query>`)
- Display search results in organized sections:
  - Quotes
  - Customers
  - Products
- Show "No results" message if nothing found
- Link to individual results

**Example structure:**
```tsx
import { useLocation } from "wouter";
import { trpc } from "@/lib/trpc";

export default function SearchResultsPage() {
  const [location, setLocation] = useLocation();
  const params = new URLSearchParams(location.split('?')[1] || '');
  const query = params.get('q') || '';

  // Fetch search results
  const { data: results, isLoading } = trpc.search.global.useQuery({ query });

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-2xl font-bold mb-4">Search Results</h1>
      {/* Display results */}
    </div>
  );
}
```

### Step 3.4: Add Route to App.tsx

**File:** `client/src/App.tsx`

Add the search route:
```tsx
import SearchResultsPage from "@/pages/SearchResultsPage";

// In Router component, add:
<Route path="/search" component={SearchResultsPage} />
```

### Step 3.5: Implement Backend Search (If Needed)

**If search endpoints don't exist:**

**File:** `server/routers/search.ts` (or add to existing router)

**Implement:**
- `global` procedure that searches across:
  - Quotes (from quotes/salesSheets router)
  - Customers (from clients router)
  - Products/Batches (from inventory router)
- Use Drizzle queries with `LIKE` or full-text search
- Return results grouped by type

**Example:**
```typescript
global: protectedProcedure
  .input(z.object({ query: z.string() }))
  .query(async ({ input, ctx }) => {
    const { query } = input;
    const searchTerm = `%${query}%`;
    
    // Search quotes
    const quotes = await db.select()
      .from(quotes)
      .where(like(quotes.name, searchTerm))
      .limit(10);
    
    // Search customers
    const customers = await db.select()
      .from(clients)
      .where(or(
        like(clients.name, searchTerm),
        like(clients.email, searchTerm)
      ))
      .limit(10);
    
    // Search products
    const products = await db.select()
      .from(batches)
      .where(like(batches.name, searchTerm))
      .limit(10);
    
    return { quotes, customers, products };
  });
```

### Step 3.6: Style Search Results Page

- Use consistent styling with rest of application
- Group results by type (Quotes, Customers, Products)
- Show relevant information for each result
- Make results clickable to navigate to detail pages
- Show loading state while searching
- Show empty state when no results

### Step 3.7: Test Search Functionality

1. Test search from header on different pages
2. Test with various query terms
3. Test with no results
4. Test navigation to result detail pages
5. Test URL parameter handling

---

## Phase 4: Completion

**Objective:** Finalize your work and push to main.

### Step 4.1: Verify All Deliverables

- [ ] Search route implemented
- [ ] Search results page created
- [ ] Backend search endpoints functional
- [ ] Results display correctly
- [ ] Navigation works
- [ ] No TypeScript errors
- [ ] All tests passing

### Step 4.2: Create Completion Report

Use template: `docs/templates/COMPLETION_REPORT_TEMPLATE.md`

**Include:**
- Files created/modified
- Search functionality implemented
- Testing results
- Any limitations or future improvements

### Step 4.3: Update Roadmap

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Update BUG-010:
- Change status to `‚úÖ COMPLETE`
- Add completion date: `(Completed: YYYY-MM-DD)`
- Add actual time spent
- Add key commits
- Link to completion report

### Step 4.4: Update ACTIVE_SESSIONS.md

Mark your session as complete.

### Step 4.5: Commit and Push

```bash
git add .
git commit -m "Fix BUG-010: Implement global search functionality"
git push origin bug-010-global-search-fix:main
```

**Note:** Push directly to main (no PR needed per protocol).

### Step 4.6: Archive Session

Move session file from `docs/sessions/active/` to `docs/sessions/completed/`.

---

## ‚ö° Quick Reference

**Key Files:**
- `client/src/components/layout/AppHeader.tsx` - Search bar (line ~52-59)
- `client/src/App.tsx` - Routing configuration
- `client/src/pages/SearchResultsPage.tsx` - New search results page
- `server/routers/search.ts` - Backend search endpoints (may need creation)

**Key Commands:**
```bash
# Check current routing
grep -r "/search" client/src

# Check backend search
grep -r "search" server/routers
```

---

## üÜò Troubleshooting

**Issue:** Route still returns 404
- **Solution:** Verify route is added to App.tsx, check route path matches exactly

**Issue:** Search returns no results
- **Solution:** Check backend search logic, verify database queries, test with known data

**Issue:** Query parameter not read correctly
- **Solution:** Verify URL parsing logic, check URLSearchParams usage

---

**Last Updated:** November 22, 2025


