# REL-002: Migrate Inventory Quantities to DECIMAL (Dual-Write + Backfill + Cutover)

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-002 -->
<!-- TASK_TITLE: Migrate Inventory Quantities to DECIMAL -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-002  
**Estimated Time:** 2d  
**Module:** `drizzle/`, `server/inventory*.ts`

## Implementation Guide

### Problem
At least one inventory quantity is currently string-backed (migration shows `batches.onHandQty varchar(20)`), which increases correctness risk and limits constraints.

### Required Approach (No Downtime Pattern)
1) Audit all quantity-like fields (schema + migrations).
2) Add DECIMAL columns alongside existing fields.
3) Implement dual-write for all mutation paths that touch quantities.
4) Backfill DECIMAL from existing values (with safe parsing + logging).
5) Add a feature flag to switch reads to DECIMAL.
6) Run reconciliation comparing old-parsed vs DECIMAL to ensure parity.
7) Cutover reads, stop writing old fields, then remove old fields after soak.

### Files to Modify
- Schema/migrations: `drizzle/schema*.ts`, `drizzle/*.sql`, `migrations/*`
- Inventory writes: `server/inventoryDb.ts`, `server/inventoryMovementsDb.ts`, `server/inventoryIntakeService.ts`
- Flags: `server/_core/features.ts`, `server/_core/featureFlagMiddleware.ts`

### Tests
- Extend `server/inventory.integration.test.ts` to assert:
  - same outcome under string vs decimal modes
  - no negative qty after operations
  - sum(movements) equals projection

### Acceptance Criteria
- Dual-write + backfill completed with mismatch logging.
- Read cutover controlled by feature flag.
- Reconciliation report shows 0 drift on seeded dataset.
