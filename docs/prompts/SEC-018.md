# SEC-018: Remove Hardcoded Admin Setup Key Fallback

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-018 -->
<!-- TASK_TITLE: Remove Hardcoded Admin Setup Key Fallback -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** SEC-018
**Estimated Time:** 2h
**Module:** `server/routers/adminSetup.ts`

## Context

**Background:**
The admin setup endpoint at `server/routers/adminSetup.ts:76` contains a hardcoded fallback key:
```typescript
const ADMIN_SETUP_KEY = process.env.ADMIN_SETUP_KEY || "terp-admin-setup-2024";
```

This means anyone knowing the default key can promote users to admin without proper authorization.

**Goal:**
Remove the hardcoded fallback and require the environment variable to be set.

**Success Criteria:**
- No hardcoded admin setup key in the codebase
- Application fails safely if ADMIN_SETUP_KEY is not set
- Clear error message when env var is missing

## Implementation Guide

### Step 1: Update Admin Setup Router

**File:** `server/routers/adminSetup.ts`

Remove the fallback value:

```typescript
// BEFORE
const ADMIN_SETUP_KEY = process.env.ADMIN_SETUP_KEY || "terp-admin-setup-2024";

// AFTER
const ADMIN_SETUP_KEY = process.env.ADMIN_SETUP_KEY;

if (!ADMIN_SETUP_KEY) {
  throw new Error("ADMIN_SETUP_KEY environment variable must be set");
}
```

### Step 2: Update Environment Templates

Add to `.env.example`:
```
ADMIN_SETUP_KEY=your-secure-random-key-here
```

### Step 3: Add Documentation

Document the required environment variable in deployment docs.

### Step 4: Test

1. Start server without ADMIN_SETUP_KEY - should fail with clear error
2. Start server with ADMIN_SETUP_KEY set - should work normally
3. Test admin setup endpoint with correct key
4. Test admin setup endpoint with wrong key - should reject

## Deliverables

- [ ] Remove hardcoded fallback from `server/routers/adminSetup.ts`
- [ ] Add startup validation for ADMIN_SETUP_KEY
- [ ] Update `.env.example` with placeholder
- [ ] Add to deployment documentation
- [ ] Verify existing tests still pass

## Quick Reference

**File to modify:** `server/routers/adminSetup.ts:76`

**Validation command:**
```bash
grep -r "terp-admin-setup" server/
# Should return no results after fix
```
