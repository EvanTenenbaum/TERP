# REL-001: Define Truth Model + Invariants for Inventory and Money

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-001 -->
<!-- TASK_TITLE: Define Truth Model + Invariants for Inventory and Money -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-001  
**Estimated Time:** 8h  
**Module:** `docs/reliability/`, `drizzle/`, `server/`

## Implementation Guide

### Problem
Inventory + money correctness requirements are implicit across services. Without explicit truth sources and invariant checks, drift and partial/legacy paths are hard to detect and prevent.

### Goals
- Define canonical "journals vs projections" truth model for inventory and money.
- Define invariant checks that detect drift/impossible states.
- Provide a reusable foundation for reconciliation tooling and CI gating.

### Code/Schema Discovery (Mandatory)
- Inventory: `server/inventoryMovementsDb.ts`, `server/inventoryDb.ts`, `server/inventoryUtils.ts`
- Accounting: `server/accountingDb.ts`, `server/services/orderAccountingService.ts`, `server/_core/fiscalPeriod.ts`
- Schema: `drizzle/schema*.ts`, `drizzle/*.sql`, `migrations/*`

### Deliverables (Concrete)
1) `docs/reliability/TRUTH_MODEL.md`
- Inventory:
  - Movements table(s) are canonical journal
  - Batch/location qty fields are projections
- Money:
  - Ledger table(s) are canonical journal for accounting
  - Invoice/payment/credit tables are operational views; define mapping

2) `docs/reliability/INVARIANTS.md`
- Inventory invariants (examples; replace with correct table/fields discovered):
  - No negative on-hand unless explicitly allowed by business rule
  - Sum(movement deltas) == projection qty per batch/location
  - No orphan movement references
- Money invariants:
  - Invoice amountDue == total - applied payments - applied credits
  - Payments applied do not exceed payment amount unless explicitly marked unallocated
  - Ledger journals are balanced (debits == credits)
  - No postings into locked periods

### Acceptance Criteria
- Docs committed and referenced from inventory/accounting core modules.
- At least 10 invariant queries defined (inventory + money + ledger).
- Each invariant has: purpose, query, "what to do if violated".
