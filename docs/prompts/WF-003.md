# WF-003: End-to-End Returns Workflow Verification

<!-- METADATA (for validation) -->
<!-- TASK_ID: WF-003 -->
<!-- TASK_TITLE: End-to-End Returns Workflow Verification -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-11-22 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** WF-003  
**Priority:** P1 (HIGH - WORKFLOW COMPLETION)  
**Estimated Time:** 4-6 hours  
**Module:** Returns, Workflow Verification  
**Dependencies:** BUG-005 ‚úÖ

---

## üìã Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Verification](#phase-3-verification)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## üéØ Context

**Background:**
BUG-005 (Returns Workflow Logic Gap) has been completed, fixing user context and inventory restocking. This task verifies that the entire returns workflow works end-to-end from order lookup through inventory restocking, ensuring all components work together correctly.

**Goal:**
Verify the complete returns workflow functions correctly, including order lookup, item selection, return record creation, inventory restocking, batch status transitions, and audit trail.

**Success Criteria:**

- [ ] Order lookup works correctly (after BUG-005)
- [ ] Item selection from order works
- [ ] Return record creation with correct user context
- [ ] Inventory restocking logic works correctly
- [ ] Batch status transitions (Sold ‚Üí In Stock) work
- [ ] Audit trail records correct user
- [ ] All data flows correctly through the system
- [ ] Verification report created

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-WF-003-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Register Session (Atomic) ‚ö†Ô∏è CRITICAL

**This step prevents race conditions. Follow it exactly.**

1. `git pull origin main` (to get the latest `ACTIVE_SESSIONS.md`)
2. Read `docs/ACTIVE_SESSIONS.md` and check for module conflicts.
3. If clear, add your session to the file.
4. Commit and push **immediately**:
   ```bash
   git add docs/ACTIVE_SESSIONS.md
   git commit -m "Register session for WF-003"
   git push origin main
   ```
5. **If the push fails due to a conflict, another agent registered first.** STOP, pull again, and re-evaluate.

### Step 1.3: Verify Environment

```bash
node --version
pnpm --version
git status
```

### Step 1.4: Verify Permissions

Test your push access: `git push --dry-run origin main`

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b wf-003-returns-workflow-verification
```

### Step 2.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Find the WF-003 task and update status to `‚è≥ IN PROGRESS`.

### Step 2.3: Update Session File Progress

Update your session file with your progress.

---

## Phase 3: Verification

**Objective:** Systematically verify each step of the returns workflow.

### Step 3.1: Verify Order Lookup

**Test:**
1. Navigate to Returns page
2. Enter an order ID
3. Verify order details load
4. Verify order line items display
5. Verify items are selectable

**Expected Results:**
- Order lookup works correctly
- Order details display correctly
- Line items show with quantities
- Items can be selected for return

**Files to Check:**
- `client/src/pages/ReturnsPage.tsx` - Returns page component
- `server/routers/orders.ts` - getOrderWithLineItems endpoint
- `server/routers/returns.ts` - Returns endpoints

**Document:** Record results in verification report

### Step 3.2: Verify Item Selection

**Test:**
1. Look up an order
2. Select items to return
3. Enter return quantities
4. Select return reason
5. Add notes (optional)
6. Verify form validation

**Expected Results:**
- Items can be selected
- Quantities can be entered
- Return reasons available
- Form validates correctly
- Cannot return more than ordered

**Files to Check:**
- `client/src/pages/ReturnsPage.tsx` - Item selection logic
- Form validation

**Document:** Record results in verification report

### Step 3.3: Verify Return Record Creation

**Test:**
1. Create a return with items
2. Verify return record created in database
3. Verify return has correct:
   - Order ID
   - Items array
   - Return reason
   - Notes
   - User ID (created by)
   - Timestamp

**Expected Results:**
- Return record created in returns table
- All fields populated correctly
- User ID is correct (not null or default)
- Timestamp set correctly

**Files to Check:**
- `server/routers/returns.ts` - create endpoint
- `server/ordersDb.ts` - processReturn function
- Database: returns table

**Document:** Record results in verification report

### Step 3.4: Verify Inventory Restocking

**Test:**
1. Create a return with restockInventory = true
2. Verify inventory quantities increase
3. Verify batch quantities updated
4. Verify inventory movements created
5. Test with restockInventory = false (should not restock)

**Expected Results:**
- Inventory quantities increase when restocking enabled
- Batch quantities updated correctly
- Inventory movement records created
- No restocking when flag is false

**Files to Check:**
- `server/routers/returns.ts` - create endpoint
- `server/ordersDb.ts` - processReturn function
- Database: batches table (quantityAvailable)
- Database: inventoryMovements table

**Document:** Record results in verification report

### Step 3.5: Verify Batch Status Transitions

**Test:**
1. Create a return for items from sold batches
2. Verify batch status transitions from SOLD_OUT to appropriate status
3. Verify status history created
4. Verify status change reflected in UI

**Expected Results:**
- Batch status transitions correctly
- Status history records created
- Status changes visible in inventory UI
- Invalid transitions prevented

**Files to Check:**
- `server/ordersDb.ts` - processReturn function
- Batch status update logic
- Database: batchStatusHistory table

**Document:** Record results in verification report

### Step 3.6: Verify Audit Trail

**Test:**
1. Create a return
2. Verify audit log entry created
3. Verify audit log has correct:
   - User ID (not null or default)
   - Action type
   - Entity type and ID
   - Timestamp
   - Details

**Expected Results:**
- Audit log entry created
- User ID is correct (from authenticated user)
- All audit fields populated
- Audit trail complete

**Files to Check:**
- `server/ordersDb.ts` - processReturn function
- Audit log creation logic
- Database: auditLogs table

**Document:** Record results in verification report

### Step 3.7: Verify Data Integrity

**Test:**
1. Create a return and verify all records
2. Query database directly to verify:
   - Return record exists with correct data
   - Order relationship maintained
   - Inventory quantities updated
   - Batch status updated
   - Inventory movements created
   - Audit logs created
   - User context correct

**Expected Results:**
- All database records created correctly
- Foreign key relationships maintained
- Data matches form values
- Audit trail complete
- User context preserved

**Files to Check:**
- Database queries
- Schema relationships
- Foreign key constraints

**Document:** Record results in verification report

---

## Phase 4: Completion

**Objective:** Finalize verification and create report.

### Step 4.1: Create Verification Report

**File:** `docs/WF-003-VERIFICATION-REPORT.md`

**Include:**
- Summary of workflow verification
- Results for each verification step
- Any issues found
- Recommendations for improvements
- Screenshots or evidence of testing

### Step 4.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Update WF-003:
- Change status to `‚úÖ COMPLETE`
- Add completion date: `(Completed: YYYY-MM-DD)`
- Add actual time spent
- Link to verification report

### Step 4.3: Archive Session File

Move session file from `docs/sessions/active/` to `docs/sessions/completed/`.

### Step 4.4: Commit and Push

```bash
git add .
git commit -m "Complete WF-003: End-to-End Returns Workflow Verification"
git push origin wf-003-returns-workflow-verification:main
```

**Note:** Push directly to main (no PR needed per protocol).

### Step 4.5: Verify Deployment

Wait for deployment to complete and verify in production.

---

## ‚ö° Quick Reference

**Key Files:**
- `client/src/pages/ReturnsPage.tsx` - Returns page
- `server/routers/returns.ts` - Returns endpoints
- `server/ordersDb.ts` - processReturn function
- `client/src/components/orders/ProcessReturnModal.tsx` - Return modal (if exists)

**Key Database Tables:**
- `returns` - Return records
- `batches` - Batch records (quantity updates)
- `inventoryMovements` - Movement tracking
- `batchStatusHistory` - Status transitions
- `auditLogs` - Audit trail

---

## üÜò Troubleshooting

**Issue:** Order lookup fails
- **Solution:** Check order endpoint, verify order exists, check permissions

**Issue:** Inventory not restocking
- **Solution:** Check restockInventory flag, verify inventory update logic

**Issue:** User context missing
- **Solution:** Check BUG-005 fix, verify authentication middleware

---

**Last Updated:** November 22, 2025

