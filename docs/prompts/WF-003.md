# WF-003: Merge Notifications and Inbox Systems

## Implementation Guide

### Problem

Two parallel, unconnected notification systems exist:

| System            | Table           | Schema Location          | Fields                                                                               |
| ----------------- | --------------- | ------------------------ | ------------------------------------------------------------------------------------ |
| **Notifications** | `notifications` | `drizzle/schema.ts:4631` | recipientType, userId, clientId, type, title, message, link, channel, isRead, readAt |
| **Inbox**         | `inbox_items`   | `drizzle/schema.ts:4723` | userId, sourceType, sourceId, referenceType, referenceId, title, description, status |

**notifications table columns:**

```typescript
recipientType: "user" | "client";
channel: "in_app" | "email" | "sms";
type: "info" | "warning" | "success" | "error";
```

**inbox_items table columns:**

```typescript
sourceType: "mention" | "task_assignment" | "task_update";
status: "unread" | "seen" | "completed";
```

**Why This Is a Problem:**

| Event           | Creates Notification? | Creates Inbox Item? | User Must Check |
| --------------- | --------------------- | ------------------- | --------------- |
| Order created   | ✅ Yes                | ❌ No               | Bell icon       |
| Task assigned   | ❌ No                 | ✅ Yes              | /inbox URL      |
| @mention        | ❌ No                 | ✅ Yes              | /inbox URL      |
| Invoice overdue | ✅ Yes                | ❌ No               | Bell icon       |

User must check TWO different places for action items.

### Backend Service Files

| Service                  | Location                                 | Creates                 |
| ------------------------ | ---------------------------------------- | ----------------------- |
| `notificationService.ts` | `server/services/notificationService.ts` | `notifications` records |
| `inboxDb.ts`             | `server/inboxDb.ts`                      | `inbox_items` records   |

### Solution Options

| Option              | Approach                   | Pros                  | Cons                   |
| ------------------- | -------------------------- | --------------------- | ---------------------- |
| **A (Recommended)** | Merge into `notifications` | Single table, cleaner | Migration needed       |
| B                   | Create unified view        | No migration          | Two tables persist     |
| C                   | API aggregation only       | Quick fix             | Technical debt remains |

### Implementation (Option A)

**Step 1: Extend notifications table**

```typescript
// drizzle/schema.ts - Add to notifications table
sourceType: mysqlEnum("source_type", [
  "system",      // Existing notifications
  "mention",     // From inbox_items
  "task_assignment",
  "task_update",
]).default("system"),
sourceId: int("source_id"),       // e.g., task ID
referenceType: varchar("reference_type", { length: 50 }),  // e.g., "task", "comment"
referenceId: int("reference_id"),  // e.g., specific task ID
actionStatus: mysqlEnum("action_status", ["pending", "seen", "completed"]).default("pending"),
```

**Step 2: Migrate inbox_items data**

```sql
-- Migration script
INSERT INTO notifications (
  recipientType, userId, type, title, message, channel,
  sourceType, sourceId, referenceType, referenceId, actionStatus, createdAt
)
SELECT
  'user', user_id, 'info', title, description, 'in_app',
  source_type, source_id, reference_type, reference_id,
  CASE status WHEN 'unread' THEN 'pending' WHEN 'seen' THEN 'seen' ELSE 'completed' END,
  created_at
FROM inbox_items;
```

**Step 3: Update inboxDb.ts to use notificationService**

```typescript
// server/inboxDb.ts - BEFORE
export async function createInboxItem(item: InsertInboxItem) {
  const db = await getDb();
  await db.insert(inboxItems).values(item);
}

// AFTER - Redirect to notificationService
export async function createInboxItem(item: InsertInboxItem) {
  await sendNotification({
    recipientType: "user",
    userId: item.userId,
    type: "info",
    title: item.title,
    message: item.description,
    channel: "in_app",
    sourceType: item.sourceType,
    sourceId: item.sourceId,
    referenceType: item.referenceType,
    referenceId: item.referenceId,
  });
}
```

### Files to Modify

| File                                     | Changes                                                            |
| ---------------------------------------- | ------------------------------------------------------------------ |
| `drizzle/schema.ts:4631`                 | Add sourceType, sourceId, referenceType, referenceId, actionStatus |
| `drizzle/migrations/XXXX.sql`            | Migration script                                                   |
| `server/inboxDb.ts`                      | Redirect to notificationService                                    |
| `server/services/notificationService.ts` | Handle new source types                                            |
| `server/routers/inbox.ts`                | Query unified notifications                                        |
| `client/src/pages/InboxPage.tsx`         | Query notifications table                                          |

### Verification

```bash
# 1. Verify schema changes
grep -A10 "sourceType" drizzle/schema.ts | grep -A5 "notifications"

# 2. Verify inboxDb redirects
grep -n "sendNotification" server/inboxDb.ts

# 3. Test both entry points create same record type
pnpm test notification inbox
```

### Acceptance Criteria

- [ ] `notifications` table extended with inbox fields
- [ ] `inbox_items` data migrated to `notifications`
- [ ] `inboxDb.ts` creates `notifications` records
- [ ] Single `/inbox` page shows all action items
- [ ] Bell icon and /inbox show same data
- [ ] Email/SMS channels still work

### Estimate

2 days
