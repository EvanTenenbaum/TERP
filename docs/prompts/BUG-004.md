# BUG-004: Purchase/Intake Modal Data Loss

<!-- METADATA (for validation) -->
<!-- TASK_ID: BUG-004 -->
<!-- TASK_TITLE: Purchase/Intake Modal Data Loss -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-11-22 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** BUG-004  
**Priority:** P0 (CRITICAL - DATA LOSS)  
**Estimated Time:** 6-8 hours  
**Module:** `client/src/components/inventory/PurchaseModal.tsx`, `server/routers/inventory.ts`

---

## ðŸ“‹ Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Development](#phase-3-development)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## ðŸŽ¯ Context

**Background:**
The PurchaseModal and EditBatchModal components allow users to upload media files (photos, COAs) but these files are never saved to the server. Files are stored in component state (`mediaFiles`) but are not included in the mutation payload when creating/updating purchases or batches. This causes critical data loss and breaks audit trail and compliance requirements.

**Goal:**
Implement file upload functionality to save media files to the server and link them to purchases/batches. Files should be stored securely and accessible for compliance audits.

**Success Criteria:**

- [ ] Media files uploaded to server when purchase/batch is created/updated
- [ ] Files stored in appropriate storage location (S3, local storage, or database)
- [ ] File metadata (name, type, size) saved to database
- [ ] Files linked to purchase/batch records
- [ ] Files accessible for viewing/downloading
- [ ] EditBatchModal also saves media files
- [ ] All tests passing
- [ ] Zero TypeScript errors

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-BUG-004-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Register Session (Atomic) âš ï¸ CRITICAL

**This step prevents race conditions. Follow it exactly.**

1. `git pull origin main` (to get the latest `ACTIVE_SESSIONS.md`)
2. Read `docs/ACTIVE_SESSIONS.md` and check for module conflicts.
3. If clear, add your session to the file.
4. Commit and push **immediately**:
   ```bash
   git add docs/ACTIVE_SESSIONS.md
   git commit -m "Register session for BUG-004"
   git push origin main
   ```
5. **If the push fails due to a conflict, another agent registered first.** STOP, pull again, and re-evaluate.

### Step 1.3: Verify Environment

```bash
node --version
pnpm --version
git status
```

### Step 1.4: Verify Permissions

Test your push access: `git push --dry-run origin main`

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b bug-004-media-file-upload
```

### Step 2.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Find BUG-004 task and update status from `ðŸ“‹ PLANNED` to `â³ IN PROGRESS`.

---

## Phase 3: Development

**Objective:** Implement file upload functionality for media files.

### Step 3.1: Investigate Current Implementation

1. **Examine PurchaseModal:**
   ```bash
   cat client/src/components/inventory/PurchaseModal.tsx
   ```
   - Note: `mediaFiles` state is populated but never sent to server
   - Check `handleMediaUpload` function
   - Check `createPurchaseMutation` payload

2. **Examine EditBatchModal:**
   ```bash
   cat client/src/components/inventory/EditBatchModal.tsx
   ```
   - Same issue: files uploaded but not saved

3. **Check Server Endpoints:**
   ```bash
   grep -r "intake\|createPurchase" server/routers/inventory.ts
   ```
   - Verify if endpoint accepts file uploads
   - Check if file storage is configured

4. **Check File Storage Configuration:**
   ```bash
   grep -r "upload\|file\|media\|storage" server/
   ```
   - Look for existing file upload infrastructure
   - Check for S3 or local storage setup

### Step 3.2: Design File Upload Solution

**Options:**
1. **Direct Upload to Server:** Use FormData to send files with purchase/batch data
2. **Separate Upload Endpoint:** Upload files first, get URLs, then link to purchase/batch
3. **Base64 Encoding:** Encode files and send as JSON (not recommended for large files)

**Recommended Approach:**
- Use FormData for file uploads
- Create file upload endpoint if needed
- Store files in configured storage (S3 or local)
- Save file metadata to database
- Link files to purchase/batch records

### Step 3.3: Implement File Upload Endpoint (if needed)

1. **Check if endpoint exists:**
   ```bash
   grep -r "upload.*media\|upload.*file" server/routers/
   ```

2. **If missing, create endpoint:**
   - Add to `server/routers/inventory.ts` or create `server/routers/media.ts`
   - Use multipart/form-data handling
   - Save files to storage
   - Return file URLs or IDs

3. **File Storage Options:**
   - **S3:** Use AWS SDK if configured
   - **Local:** Save to `uploads/` directory
   - **Database:** Store as BLOB (not recommended)

### Step 3.4: Update PurchaseModal

1. **Modify handleSubmit:**
   - Create FormData object
   - Append all form fields
   - Append media files
   - Send to server

2. **Update createPurchaseMutation:**
   - Change to use FormData
   - Handle file uploads in mutation

3. **Example Implementation:**
   ```typescript
   const handleSubmit = async (e: React.FormEvent) => {
     e.preventDefault();
     
     const formData = new FormData();
     // Append all form fields
     Object.entries(formData).forEach(([key, value]) => {
       formData.append(key, value);
     });
     
     // Append media files
     mediaFiles.forEach((file, index) => {
       formData.append(`media_${index}`, file);
     });
     
     createPurchaseMutation.mutate(formData);
   };
   ```

### Step 3.5: Update EditBatchModal

1. Apply same changes as PurchaseModal
2. Ensure update mutation handles file uploads
3. Handle file deletion if needed

### Step 3.6: Update Server Endpoint

1. **Modify inventory.intake endpoint:**
   - Accept FormData instead of JSON
   - Extract files from FormData
   - Save files to storage
   - Save file metadata to database
   - Link files to purchase record

2. **Database Schema:**
   - Check if `purchase_media` or `batch_media` table exists
   - Create if missing with fields: id, purchase_id/batch_id, file_url, file_name, file_type, file_size, uploaded_at

### Step 3.7: Test File Upload

1. **Test PurchaseModal:**
   - Upload photos
   - Upload COAs
   - Verify files saved to server
   - Verify files linked to purchase

2. **Test EditBatchModal:**
   - Upload media files
   - Verify files saved
   - Verify files linked to batch

3. **Test File Access:**
   - Verify files can be viewed/downloaded
   - Check file URLs are correct

### Step 3.8: Run Tests

```bash
pnpm check
pnpm test
```

---

## Phase 4: Completion

**Objective:** Finalize your work and submit it for review.

### Step 4.1: Verify All Deliverables

- [ ] Media files uploaded to server
- [ ] Files stored securely
- [ ] File metadata saved to database
- [ ] Files linked to purchases/batches
- [ ] Files accessible for viewing
- [ ] All tests passing
- [ ] Manual testing complete

### Step 4.2: Create Completion Report

Use template at `docs/templates/COMPLETION_REPORT_TEMPLATE.md`.

### Step 4.3: Update Roadmap

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Update BUG-004:
- Change `- [ ]` to `- [x]`
- Change status to `âœ… COMPLETE`
- Add completion date
- Add key commits
- Add actual time spent

### Step 4.4: Archive Session

1. Move session file to `docs/sessions/completed/`
2. Remove from `docs/ACTIVE_SESSIONS.md`

### Step 4.5: Push to Main

```bash
git add .
git commit -m "Fix BUG-004: Implement media file upload for PurchaseModal and EditBatchModal"
git push origin bug-004-media-file-upload:main
```

**DO NOT create a pull request** - push directly to main.

---

## âš¡ Quick Reference

**Key Files:**
- `client/src/components/inventory/PurchaseModal.tsx`
- `client/src/components/inventory/EditBatchModal.tsx`
- `server/routers/inventory.ts`
- `server/services/fileStorage.ts` (may need to create)

**Related Tasks:**
- None

**Commands:**
```bash
# Check file upload infrastructure
grep -r "FormData\|multipart\|file.*upload" server/

# Check database schema for media
grep -r "media\|file.*url" drizzle/schema.ts
```

---

## ðŸ†˜ Troubleshooting

**Issue: Files not uploading**
- Check FormData is being created correctly
- Verify endpoint accepts multipart/form-data
- Check file size limits
- Verify storage permissions

**Issue: Files uploaded but not linked**
- Check database foreign key relationships
- Verify file metadata is saved
- Check file URLs are correct

**Issue: Files not accessible**
- Verify file storage path is correct
- Check file permissions
- Verify URL generation logic

---

**Last Updated:** November 22, 2025

