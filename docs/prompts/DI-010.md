# DI-010: Fix Credit Number Generation Race Condition

## Problem

Classic TOCTOU (time-of-check-time-of-use) race condition in `generateCreditNumber` at `server/creditsDb.ts:546-574`. Two concurrent requests can both read the same latest credit number and increment to the same value, causing duplicate credit numbers.

## Implementation Guide

### Step 1: Use Database Sequence

```typescript
export async function generateCreditNumber(
  prefix: string = "CR"
): Promise<string> {
  const db = await getDb();

  // Use sequences table for atomic number generation
  const result = await db.execute(sql`
    INSERT INTO sequences (name, current_value)
    VALUES (${`credit_${prefix}`}, 1)
    ON DUPLICATE KEY UPDATE current_value = current_value + 1
  `);

  const [seq] = await db
    .select({ value: sequences.currentValue })
    .from(sequences)
    .where(eq(sequences.name, `credit_${prefix}`));

  const paddedNumber = String(seq.value).padStart(5, "0");
  return `${prefix}-${paddedNumber}`;
}
```

### Step 2: Add Transaction Wrapper

```typescript
export async function generateCreditNumber(
  prefix: string = "CR"
): Promise<string> {
  return await withTransaction(async tx => {
    // Lock the sequence row
    const [seq] = await tx
      .select()
      .from(sequences)
      .where(eq(sequences.name, `credit_${prefix}`))
      .for("update");

    const nextValue = (seq?.currentValue || 0) + 1;

    await tx
      .update(sequences)
      .set({ currentValue: nextValue })
      .where(eq(sequences.name, `credit_${prefix}`));

    return `${prefix}-${String(nextValue).padStart(5, "0")}`;
  });
}
```

## Acceptance Criteria

- [ ] Credit numbers generated atomically
- [ ] No duplicate credit numbers under concurrent load
- [ ] Existing credit number format maintained
- [ ] Integration test for concurrent generation passes
- [ ] Performance acceptable (<100ms per generation)

## Files to Modify

- `server/creditsDb.ts`
