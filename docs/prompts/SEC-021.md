# SEC-021: Fix Token Exposure in URL Query Parameter

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-021 -->
<!-- TASK_TITLE: Fix Token Exposure in URL Query Parameter -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** SEC-021
**Estimated Time:** 4h
**Module:** `src/hooks/useLiveSessionClient.ts`

## Context

**Background:**
The live session client at `src/hooks/useLiveSessionClient.ts:40` passes the session token as a URL query parameter:
```typescript
const url = `...?token=${encodeURIComponent(sessionToken)}`;
```

This exposes the token in:
- Server access logs
- Browser history
- Referrer headers
- Proxy logs

**Goal:**
Move token transmission to HTTP headers or WebSocket subprotocol.

**Success Criteria:**
- Token no longer visible in URL
- Live shopping sessions still work
- Token transmitted securely via headers

## Implementation Guide

### Step 1: Update Client-Side Connection

**File:** `src/hooks/useLiveSessionClient.ts`

Change from URL parameter to header or subprotocol:

```typescript
// Option A: Use authorization header (for fetch-based SSE)
const eventSource = new EventSource(url, {
  headers: {
    'Authorization': `Bearer ${sessionToken}`
  }
});

// Option B: For WebSocket, use subprotocol
const ws = new WebSocket(url, [`token.${sessionToken}`]);
```

### Step 2: Update Server-Side Handler

Update the SSE/WebSocket handler to extract token from headers:

```typescript
// Extract from Authorization header
const token = req.headers.authorization?.replace('Bearer ', '');

// Or from subprotocol
const token = ws.protocol.replace('token.', '');
```

### Step 3: Update Related Files

Check and update:
- `useLiveSessionSSE.ts`
- Server-side SSE handlers
- Any other files passing tokens in URLs

### Step 4: Test

1. Verify live shopping still works
2. Check server logs don't contain tokens
3. Verify browser history doesn't show tokens

## Deliverables

- [ ] Remove token from URL query parameters
- [ ] Implement header-based token transmission
- [ ] Update server-side token extraction
- [ ] Update `useLiveSessionSSE.ts` if needed
- [ ] Add security tests for token handling

## Quick Reference

**Files to modify:**
- `src/hooks/useLiveSessionClient.ts:40`
- `src/hooks/useLiveSessionSSE.ts`
- Server-side SSE handlers

**Validation command:**
```bash
grep -r "token=" src/hooks/useLive*
# Should return no URL query parameter usages
```
