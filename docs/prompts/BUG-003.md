# BUG-003: Order Creator Connectivity

<!-- METADATA (for validation) -->
<!-- TASK_ID: BUG-003 -->
<!-- TASK_TITLE: Order Creator Connectivity -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-11-21 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** BUG-003  
**Priority:** P0 (CRITICAL BLOCKER)  
**Estimated Time:** 4-6 hours  
**Module:** `client/src/pages/OrderCreatorPage.tsx`, `client/src/components/sales/InventoryBrowser.tsx`

---

## ðŸ“‹ Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Development](#phase-3-development)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## ðŸŽ¯ Context

**Background:**
The Order Creator is the heart of the revenue workflow, but it is currently disconnected from Inventory. The `handleAddItem` function is a stub that only shows a toast message. The page functions as a "Customer Selector" and nothing else. Additionally, the CreditLimitBanner component is missing, allowing sales to proceed regardless of credit standing.

**Goal:**
Integrate InventoryBrowser component into OrderCreatorPage and add CreditLimitBanner to prevent orders when credit limits are exceeded.

**Success Criteria:**

- [ ] InventoryBrowser component imported and integrated into OrderCreatorPage
- [ ] handleAddItem function implemented with actual inventory selection logic
- [ ] CreditLimitBanner component imported and rendered in OrderTotalsPanel area
- [ ] Credit limit validation prevents order finalization when exceeded
- [ ] Order creation workflow tested end-to-end
- [ ] All tests passing
- [ ] Zero TypeScript errors

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-BUG-003-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Register Session (Atomic) âš ï¸ CRITICAL

**This step prevents race conditions. Follow it exactly.**

1. `git pull origin main` (to get the latest `ACTIVE_SESSIONS.md`)
2. Read `docs/ACTIVE_SESSIONS.md` and check for module conflicts.
3. If clear, add your session to the file.
4. Commit and push **immediately**:
   ```bash
   git add docs/ACTIVE_SESSIONS.md
   git commit -m "Register session for BUG-003"
   git push origin main
   ```
5. **If the push fails due to a conflict, another agent registered first.** STOP, pull again, and re-evaluate.

### Step 1.3: Verify Environment

```bash
node --version
pnpm --version
git status
```

### Step 1.4: Verify Permissions

Test your push access: `git push --dry-run origin main`

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b bug-003-order-creator-connectivity
```

### Step 2.2: Update Roadmap Status

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Find BUG-003 task and update status from `ðŸ“‹ PLANNED` to `â³ IN PROGRESS`.

---

## Phase 3: Development

**Objective:** Integrate InventoryBrowser and CreditLimitBanner into OrderCreatorPage.

### Step 3.1: Examine Current Implementation

1. **Read OrderCreatorPage:**
   ```bash
   cat client/src/pages/OrderCreatorPage.tsx
   ```

2. **Read InventoryBrowser component:**
   ```bash
   cat client/src/components/sales/InventoryBrowser.tsx
   ```

3. **Find CreditLimitBanner component:**
   ```bash
   find client/src -name "*CreditLimit*" -o -name "*CreditLimit*"
   grep -r "CreditLimit" client/src
   ```

4. **Check how SalesSheetCreatorPage uses InventoryBrowser:**
   ```bash
   grep -A 20 "InventoryBrowser" client/src/pages/SalesSheetCreatorPage.tsx
   ```

### Step 3.2: Understand InventoryBrowser Interface

**InventoryBrowser Props:**
- `inventory: any[]` - Array of inventory items
- `isLoading: boolean` - Loading state
- `onAddItems: (items: any[]) => void` - Callback when items are selected
- `selectedItems: any[]` - Currently selected items

**Key Functions:**
- `onAddItems` - Called when user selects items to add
- Items should be added to the `items` state in OrderCreatorPage

### Step 3.3: Integrate InventoryBrowser

1. **Import InventoryBrowser:**
   ```typescript
   import { InventoryBrowser } from "@/components/sales/InventoryBrowser";
   ```

2. **Fetch inventory data:**
   - Check if there's a tRPC endpoint for inventory with pricing
   - Look at `trpc.salesSheets.getInventory` as reference
   - May need to create similar endpoint for order creation

3. **Replace handleAddItem stub:**
   ```typescript
   const handleAddItem = (selectedItems: any[]) => {
     // Convert inventory items to LineItem format
     const lineItems: LineItem[] = selectedItems.map(item => ({
       batchId: item.batchId,
       productId: item.productId,
       productName: item.name,
       quantity: 1, // Default quantity
       unitPrice: item.retailPrice || item.price,
       cogsPerUnit: item.cogs || 0,
       // ... other required fields
     }));
     setItems([...items, ...lineItems]);
   };
   ```

4. **Add InventoryBrowser to UI:**
   - Add a section or modal for inventory browsing
   - Consider using a Dialog/Modal for better UX
   - Or add as a collapsible section in the page

### Step 3.4: Add CreditLimitBanner

1. **Find or Create CreditLimitBanner:**
   - Search for existing component
   - If missing, create based on PROJECT_CONTEXT.md requirements
   - Should show 5 alert states as documented

2. **Import and render in OrderTotalsPanel area:**
   ```typescript
   import { CreditLimitBanner } from "@/components/orders/CreditLimitBanner";
   
   // In render, near OrderTotalsPanel:
   {clientDetails && (
     <CreditLimitBanner 
       clientId={clientId}
       orderTotal={totals.total}
       creditLimit={clientDetails.creditLimit}
       currentBalance={clientDetails.balance}
     />
   )}
   ```

3. **Add credit limit validation:**
   - Check if order total exceeds available credit
   - Prevent finalization if credit limit exceeded
   - Show appropriate error message

### Step 3.5: Update handlePreviewAndFinalize

1. **Add credit limit check:**
   ```typescript
   const handlePreviewAndFinalize = () => {
     if (!isValid) {
       toast.error("Please fix validation errors before finalizing");
       return;
     }
     
     // Check credit limit
     if (clientDetails && totals.total > (clientDetails.creditLimit - clientDetails.balance)) {
       toast.error("Order total exceeds available credit limit");
       return;
     }
     
     // ... rest of function
   };
   ```

2. **Replace window.confirm with AlertDialog:**
   - Import AlertDialog from shadcn/ui
   - Replace window.confirm with proper dialog component
   - This also addresses BUG-007 partially

### Step 3.6: Test Integration

1. **Test inventory selection:**
   - Select client
   - Open inventory browser
   - Select items
   - Verify items appear in line items table

2. **Test credit limit:**
   - Select client with credit limit
   - Add items that exceed credit
   - Verify CreditLimitBanner shows warning
   - Verify finalization is blocked

3. **Test order creation:**
   - Complete full order creation flow
   - Verify order is created with correct line items
   - Verify order totals are correct

### Step 3.7: Run Tests

```bash
pnpm check
pnpm test
```

---

## Phase 4: Completion

**Objective:** Finalize your work and submit it for review.

### Step 4.1: Verify All Deliverables

- [ ] InventoryBrowser integrated
- [ ] handleAddItem implemented
- [ ] CreditLimitBanner added
- [ ] Credit limit validation working
- [ ] All tests passing
- [ ] Manual testing complete

### Step 4.2: Create Completion Report

Use template at `docs/templates/COMPLETION_REPORT_TEMPLATE.md`.

### Step 4.3: Update Roadmap

**File:** `docs/roadmaps/MASTER_ROADMAP.md`

Update BUG-003:
- Change `- [ ]` to `- [x]`
- Change status to `âœ… COMPLETE`
- Add completion date
- Add key commits
- Add actual time spent

### Step 4.4: Archive Session

1. Move session file to `docs/sessions/completed/`
2. Remove from `docs/ACTIVE_SESSIONS.md`

### Step 4.5: Push to Main

```bash
git add .
git commit -m "Fix BUG-003: Integrate InventoryBrowser and CreditLimitBanner into OrderCreatorPage"
git push origin bug-003-order-creator-connectivity:main
```

**DO NOT create a pull request** - push directly to main.

---

## âš¡ Quick Reference

**Key Files:**
- `client/src/pages/OrderCreatorPage.tsx`
- `client/src/components/sales/InventoryBrowser.tsx`
- `client/src/components/orders/CreditLimitBanner.tsx` (may need to create)
- `client/src/components/orders/OrderTotalsPanel.tsx`

**Related Tasks:**
- BUG-007: Missing Permissions & Safety Checks (window.confirm replacement)

**Commands:**
```bash
# Find credit limit related code
grep -r "creditLimit\|credit_limit" client/src server/

# Check inventory endpoints
grep -r "getInventory\|inventory.*list" server/routers/
```

---

## ðŸ†˜ Troubleshooting

**Issue: InventoryBrowser not showing inventory**
- Check if tRPC endpoint exists for fetching inventory
- Verify endpoint returns correct data format
- Check if clientId is required for inventory query

**Issue: CreditLimitBanner not found**
- Component may need to be created
- Check PROJECT_CONTEXT.md for requirements
- Look for similar banner components as reference

**Issue: Credit limit check not working**
- Verify clientDetails includes creditLimit and balance
- Check if values are numbers, not strings
- Verify calculation logic is correct

---

**Last Updated:** November 21, 2025

