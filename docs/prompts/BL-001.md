# BL-001: Enforce Credit Limit at Order Creation

## Problem

Orders can be created that exceed client credit limits. Credit check exists in `server/routers/credit.ts` but is NOT integrated into order creation flow at `server/ordersDb.ts:110-401`.

## Implementation Guide

### Step 1: Import Credit Check Function

```typescript
import { checkOrderCredit } from "./credit";
```

### Step 2: Add Credit Check to createOrder

```typescript
export async function createOrder(input: CreateOrderInput): Promise<Order> {
  const db = await getDb();

  // Check credit limit before creating order
  const creditCheck = await checkOrderCredit(input.clientId, input.total);
  if (!creditCheck.allowed) {
    throw new Error(
      `Order exceeds credit limit. Current balance: ${creditCheck.currentBalance}, ` +
        `Credit limit: ${creditCheck.creditLimit}, Order total: ${input.total}`
    );
  }

  // ... rest of order creation
}
```

### Step 3: Add Credit Check to confirmDraftOrder

```typescript
export async function confirmDraftOrder(orderId: number): Promise<Order> {
  const order = await getOrderById(orderId);

  // Re-check credit at confirmation time
  const creditCheck = await checkOrderCredit(order.clientId, order.total);
  if (!creditCheck.allowed) {
    throw new Error(`Order confirmation blocked: ${creditCheck.reason}`);
  }

  // ... rest of confirmation
}
```

### Step 4: Handle Zero Credit Limit

```typescript
// In credit check function
if (creditLimit === 0) {
  // Zero means NO credit allowed, not unlimited
  return { allowed: false, reason: "No credit limit set for client" };
}
```

## Acceptance Criteria

- [ ] Credit check runs before order creation
- [ ] Credit check runs at order confirmation
- [ ] Error message shows balance vs limit
- [ ] Zero credit limit = no credit allowed
- [ ] Unit tests for credit limit enforcement

## Files to Modify

- `server/ordersDb.ts`
- `server/routers/credit.ts`
