# SEC-036: Implement Token Invalidation on Logout

## Problem

Logout at `server/_core/simpleAuth.ts:213-216` only clears the cookie but doesn't invalidate the JWT token server-side. Stolen tokens remain valid for 30 days after logout.

## Implementation Guide

### Step 1: Create Token Blacklist Storage

Option A: Database table

```sql
CREATE TABLE token_blacklist (
  token_hash VARCHAR(64) PRIMARY KEY,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Option B: In-memory with Map

```typescript
const tokenBlacklist = new Map<string, number>(); // hash -> expiry timestamp
```

### Step 2: Update Logout Handler

```typescript
app.post("/api/auth/logout", (req: Request, res: Response) => {
  const token = req.cookies[COOKIE_NAME];

  if (token) {
    // Extract expiry from token
    const decoded = jwt.decode(token) as { exp: number };
    const tokenHash = crypto.createHash("sha256").update(token).digest("hex");

    // Add to blacklist
    tokenBlacklist.set(tokenHash, decoded.exp * 1000);

    // Or for DB storage:
    // await db.insert(tokenBlacklistTable).values({ tokenHash, expiresAt: new Date(decoded.exp * 1000) });
  }

  res.clearCookie(COOKIE_NAME);
  res.json({ success: true });
});
```

### Step 3: Check Blacklist in Auth Middleware

```typescript
function isTokenBlacklisted(token: string): boolean {
  const tokenHash = crypto.createHash("sha256").update(token).digest("hex");
  return tokenBlacklist.has(tokenHash);
}

// In auth middleware:
if (isTokenBlacklisted(token)) {
  throw new Error("Token has been invalidated");
}
```

### Step 4: Cleanup Expired Entries

```typescript
// Run periodically (e.g., every hour)
function cleanupBlacklist() {
  const now = Date.now();
  for (const [hash, expiry] of tokenBlacklist.entries()) {
    if (expiry < now) {
      tokenBlacklist.delete(hash);
    }
  }
}
```

## Acceptance Criteria

- [ ] Tokens added to blacklist on logout
- [ ] Blacklisted tokens rejected by auth middleware
- [ ] Expired tokens cleaned from blacklist
- [ ] Performance impact minimal (<5ms per check)
- [ ] Integration test for token invalidation

## Files to Modify

- `server/_core/simpleAuth.ts`
- `server/_core/authMiddleware.ts` (or equivalent)
