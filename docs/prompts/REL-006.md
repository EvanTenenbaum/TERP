# REL-006: Inventory Concurrency Hardening (Row Locks + Optimistic Locking Enforcement)

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-006 -->
<!-- TASK_TITLE: Inventory Concurrency Hardening -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-006  
**Estimated Time:** 2d  
**Module:** `server/_core/`, `server/inventoryDb.ts`, `server/inventoryMovementsDb.ts`

## Implementation Guide

### Problem
Concurrent receives/fulfills/adjustments can cause negative inventory, lost updates, or mismatch between movements and projections.

### Solution
- Use `server/_core/dbLocking.ts` to lock the correct projection rows before mutation.
- Enforce optimistic locking using `server/_core/optimisticLocking.ts` where `version` exists (or add version to key inventory tables if needed).
- Ensure movement write + projection update happen in the same transaction.

### Tests (Required)
- Concurrency test: run two fulfills against same batch/location concurrently.
- Concurrency test: receive and fulfill concurrently.
- Assert invariants: no negative qty, sum(movements) == projection.

### Acceptance Criteria
- Conflicts produce deterministic errors (not silent drift).
- Invariants hold under parallel operations.
