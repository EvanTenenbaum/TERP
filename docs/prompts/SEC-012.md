# SEC-012: Secure Admin Setup Endpoint

## Implementation Guide

### Problem
The `adminSetup.ts` router's `promoteToAdmin` endpoint has security weaknesses:
- Uses environment variable for secret key (could leak)
- No rate limiting on attempts
- No logging of who called it
- No time-based expiry after setup

### Affected Endpoints
- `promoteToAdmin` (line ~63)
- `promoteAllToAdmin` (line ~119)

### Solution
1. Add rate limiting (max 3 attempts per minute)
2. Add comprehensive audit logging
3. Consider one-time setup token that expires after use
4. Log IP address and attempt details

### Files to Modify
- `server/routers/adminSetup.ts`

### Implementation
```typescript
// Add rate limiting
const rateLimiter = new Map<string, number[]>();

// Add audit logging
await auditLogger.log({
  action: 'ADMIN_SETUP_ATTEMPT',
  ip: req.ip,
  success: false/true,
  email: input.email
});
```

### Acceptance Criteria
- Rate limiting prevents brute force
- All attempts logged for audit
- Clear security documentation
