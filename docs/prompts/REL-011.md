# REL-011: AR/AP Reconciliation Pack (Invoice/Payment/Credit Integrity)

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-011 -->
<!-- TASK_TITLE: AR/AP Reconciliation Pack -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-011  
**Estimated Time:** 2d  
**Module:** `server/_core/reconciliationService.ts`, `server/accountingDb.ts`, `server/routers/`

## Implementation Guide

### Problem
Misapplied payments/credits and mismatched invoice balances cause incorrect amount due and cash forecasting.

### Solution
- Implement AR checks:
  - invoice amountDue matches computed balance
  - payment applications sum correctly
  - credit applications don't exceed credit available
  - detect unallocated payments
- Integrate idempotency validation for payment/credit apply flows.

### Deliverables
- AR/AP reconciliation module added
- Invariants: amountDue matches computed balance
- Idempotency replay checks for payment application paths
- Report lists specific broken references and how to fix
- Integration tests for partial payments + overpayment + credit memo scenarios

### Acceptance Criteria
- Reconciliation report flags all mismatches and identifies broken references.
- Integration tests cover partial payment, overpayment, and credit scenarios.
