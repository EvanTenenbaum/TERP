# WF-002: Unify Dual Batch Status Systems

## Implementation Guide

### Problem

Batches have TWO unrelated status fields that can contradict each other:

| Field         | Type                     | Location                | Used By   | Purpose            |
| ------------- | ------------------------ | ----------------------- | --------- | ------------------ |
| `batchStatus` | enum                     | `drizzle/schema.ts:561` | 40+ files | Business logic     |
| `statusId`    | FK → `workflow_statuses` | `drizzle/schema.ts:573` | 7 files   | Kanban visual only |

**batchStatus enum values:**

```
AWAITING_INTAKE, LIVE, PHOTOGRAPHY_COMPLETE, ON_HOLD, QUARANTINED, SOLD_OUT, CLOSED
```

**workflow_statuses table** (`drizzle/schema.ts:5842`):

```typescript
{
  (id, name, slug, color, order, isActive, createdAt, updatedAt);
}
```

**Example Contradiction:**

- Batch has `batchStatus = "LIVE"` (business logic treats as sellable)
- Same batch has `statusId` pointing to "Needs Review" workflow status
- No sync mechanism - these can diverge indefinitely

### Files Using statusId (7 total)

```bash
grep -rn "statusId" server/db/queries/workflow-queue.ts server/routers/workflow-queue.ts
```

| File                                     | Usage                   |
| ---------------------------------------- | ----------------------- |
| `server/db/queries/workflow-queue.ts`    | Kanban board queries    |
| `server/routers/workflow-queue.ts`       | Status update mutations |
| `client/src/pages/WorkflowQueuePage.tsx` | Board display           |
| `client/src/components/workflow/*`       | UI components           |

### Solution Options

| Option              | Approach                                    | Effort   | Risk                       |
| ------------------- | ------------------------------------------- | -------- | -------------------------- |
| **A (Recommended)** | Deprecate `statusId`, enhance `batchStatus` | 2 days   | Low - clean solution       |
| B                   | Sync `statusId` ↔ `batchStatus`             | 1.5 days | Medium - complexity        |
| C                   | Map workflow statuses to batchStatus values | 1 day    | High - limited flexibility |

### Implementation (Option A)

**Step 1: Create batch_status_config table**

```typescript
// drizzle/schema.ts
export const batchStatusConfig = mysqlTable("batch_status_config", {
  id: int("id").primaryKey().autoincrement(),
  status: batchStatusEnum.notNull().unique(), // Maps to batchStatus enum
  displayName: varchar("displayName", { length: 100 }).notNull(),
  color: varchar("color", { length: 20 }).notNull().default("#6B7280"),
  order: int("order").notNull().default(0),
  isKanbanVisible: int("isKanbanVisible").notNull().default(1),
});
```

**Step 2: Migrate Kanban to use batchStatus**

```typescript
// server/db/queries/workflow-queue.ts
// BEFORE:
const batches = await db
  .select()
  .from(batches)
  .where(eq(batches.statusId, statusId));

// AFTER:
const batches = await db
  .select()
  .from(batches)
  .where(eq(batches.batchStatus, status));
```

**Step 3: Deprecation migration**

```sql
-- Migration: Copy statusId to notes, then drop column
UPDATE batches SET notes = CONCAT(notes, ' [Legacy statusId: ', statusId, ']') WHERE statusId IS NOT NULL;
ALTER TABLE batches DROP FOREIGN KEY batches_statusId_workflow_statuses_id_fk;
ALTER TABLE batches DROP COLUMN statusId;
```

### Files to Modify

| File                                     | Changes                                       |
| ---------------------------------------- | --------------------------------------------- |
| `drizzle/schema.ts`                      | Add `batchStatusConfig`, remove `statusId` FK |
| `drizzle/migrations/XXXX.sql`            | Migration script                              |
| `server/db/queries/workflow-queue.ts`    | Query by `batchStatus`                        |
| `server/routers/workflow-queue.ts`       | Update status mutations                       |
| `client/src/pages/WorkflowQueuePage.tsx` | Use `batchStatus` for board                   |

### Verification

```bash
# 1. Check no more statusId usage after migration
grep -rn "statusId" server/ client/src/ --include="*.ts" --include="*.tsx"

# 2. Verify batchStatus is used for Kanban
grep -rn "batchStatus" server/db/queries/workflow-queue.ts

# 3. Run tests
pnpm test workflow
```

### Acceptance Criteria

- [ ] `batch_status_config` table created with display settings
- [ ] Kanban board uses `batchStatus` for grouping
- [ ] `statusId` column removed from batches table
- [ ] No contradictory states possible
- [ ] Migration preserves existing data in notes

### Estimate

2 days
