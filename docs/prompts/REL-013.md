# REL-013: RBAC Drift Detector (Code vs DB Permissions + Audit Trail)

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-013 -->
<!-- TASK_TITLE: RBAC Drift Detector -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-013  
**Estimated Time:** 16h  
**Module:** `server/services/`, `server/_core/`, `scripts/`

## Implementation Guide

### Problem
Permissions referenced in code can drift from seeded/DB permissions, causing broken access or unintended access.

### Solution
- Extract permission strings from:
  - `server/_core/permissionMiddleware.ts` usage patterns
  - any `requirePermission(...)` patterns across server
- Compare:
  - `server/services/rbacDefinitions.ts`
  - DB permissions table(s)
- Emit reconciliation report under `rbac` scope.

### Deliverables
- Script to extract `requirePermission(...)` usages
- Compare output vs `server/services/rbacDefinitions.ts` and DB
- Reconciliation scope `rbac` added to `scripts/reconcile.ts`
- Audit log for permission changes retained and queryable
- Tests for extraction + mismatch detection

### Acceptance Criteria
- Drift report lists missing/extra/mismatched permission strings.
- Safe remediation guidance provided (seed/migration suggestions).
