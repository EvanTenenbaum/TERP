# BL-003: Enforce Order State Machine Transitions

## Problem

Order status transitions at `server/ordersDb.ts:1504-1509` are validated ad-hoc, not using the `orderStateMachine.ts` canTransition() function. Orders can skip states (e.g., PENDING → SHIPPED bypassing PACKED).

## Implementation Guide

### Step 1: Import State Machine

```typescript
import { canTransition, OrderStatus } from "./services/orderStateMachine";
```

### Step 2: Use canTransition in updateOrderStatus

```typescript
export async function updateOrderStatus(
  orderId: number,
  newStatus: OrderStatus
): Promise<Order> {
  const order = await getOrderById(orderId);
  const oldStatus = order.fulfillmentStatus as OrderStatus;

  // Use state machine for validation
  if (!canTransition(oldStatus, newStatus)) {
    throw new Error(
      `Invalid status transition: ${oldStatus} → ${newStatus}. ` +
        `Allowed transitions from ${oldStatus}: ${getAllowedTransitions(oldStatus).join(", ")}`
    );
  }

  // ... proceed with update
}
```

### Step 3: Update shipOrder

```typescript
export async function shipOrder(orderId: number): Promise<Order> {
  const order = await getOrderById(orderId);

  if (!canTransition(order.fulfillmentStatus, "SHIPPED")) {
    throw new Error(
      `Cannot ship order. Current status: ${order.fulfillmentStatus}. ` +
        `Order must be PACKED before shipping.`
    );
  }

  // ... proceed with shipping
}
```

### Step 4: Remove Ad-hoc Validation

Remove these redundant checks that don't use state machine:

```typescript
// REMOVE THESE:
if (oldStatus === "SHIPPED") {
  throw new Error("Cannot change status of shipped order");
}
if (oldStatus === "PACKED" && newStatus === "PENDING") {
  throw new Error("Cannot move packed order back to pending");
}
```

## Acceptance Criteria

- [ ] All status updates use canTransition()
- [ ] Invalid transitions rejected with clear message
- [ ] State machine is single source of truth
- [ ] Ad-hoc validation code removed
- [ ] Integration tests for state machine enforcement

## Files to Modify

- `server/ordersDb.ts`
- `server/services/orderStateMachine.ts` (if helper needed)
