# DI-004: Implement Soft-Delete Support for Clients

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-004 -->
<!-- TASK_TITLE: Implement Soft-Delete Support for Clients -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-004
**Estimated Time:** 8h
**Module:** `server/routers/clients.ts`, `server/inventoryDb.ts`

## Context

**Background:**
Currently there's no real soft-delete for clients:
- `server/inventoryDb.ts:442-456`: Supplier deletion just flips `isSeller=false`
- `server/routers/clients.ts:173-183`: Archive is an alias for delete

This means:
- Audit trail is lost
- Cannot recover deleted clients
- Historical data references break

**Goal:**
Implement proper soft-delete with `deleted_at` timestamp.

**Success Criteria:**
- Clients have `deleted_at` column
- Deleted clients are excluded from queries by default
- Audit trail preserved
- Data recoverable

## Implementation Guide

### Step 1: Add deleted_at Column

**File:** `server/schema/clients.ts`

```typescript
export const clients = sqliteTable("clients", {
  // ... existing columns
  deletedAt: integer("deleted_at", { mode: "timestamp" }),
});
```

### Step 2: Create Migration

```sql
ALTER TABLE clients ADD COLUMN deleted_at INTEGER;
CREATE INDEX idx_clients_deleted_at ON clients(deleted_at);
```

### Step 3: Update Query Helpers

Create a helper for filtering:

```typescript
// server/utils/softDelete.ts
export function notDeleted<T extends { deletedAt: any }>(table: T) {
  return isNull(table.deletedAt);
}

// Usage in queries
const activeClients = await db.select()
  .from(clients)
  .where(notDeleted(clients));
```

### Step 4: Update Client Router

**File:** `server/routers/clients.ts`

```typescript
// Replace hard delete with soft delete
archive: protectedProcedure
  .input(z.object({ id: z.number() }))
  .mutation(async ({ input }) => {
    await db.update(clients)
      .set({ deletedAt: new Date() })
      .where(eq(clients.id, input.id));
  }),

// Add restore function
restore: protectedProcedure
  .input(z.object({ id: z.number() }))
  .mutation(async ({ input }) => {
    await db.update(clients)
      .set({ deletedAt: null })
      .where(eq(clients.id, input.id));
  }),
```

### Step 5: Update All Client Queries

Find and update all queries that should exclude deleted clients:
```bash
grep -rn "from(clients)" server/ --include="*.ts"
```

### Step 6: Update Supplier Logic

**File:** `server/inventoryDb.ts:442-456`

Replace `isSeller=false` with proper soft delete.

## Deliverables

- [ ] Add `deleted_at` column to clients table
- [ ] Create database migration
- [ ] Add soft-delete helper utilities
- [ ] Update archive mutation to soft-delete
- [ ] Add restore mutation
- [ ] Update all client queries to filter deleted
- [ ] Update supplier deletion logic

## Quick Reference

**Files to modify:**
- `server/schema/clients.ts`
- `server/routers/clients.ts:173-183`
- `server/inventoryDb.ts:442-456`

**Find client queries:**
```bash
grep -rn "clients" server/ --include="*.ts" | grep -E "(select|from|join)"
```
