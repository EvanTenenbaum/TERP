# ST-026: Implement Concurrent Edit Detection

## Implementation Guide

### Problem
The system uses "last write wins" for all record updates. When multiple users edit the same record simultaneously, one user's changes are silently overwritten.

### Current State
- No version field on most entities
- No conflict detection on updates
- User B's changes overwrite User A's without warning

### Solution
1. Add `version` field to critical tables (orders, clients, batches)
2. Include version in update mutations
3. Reject updates with stale version numbers
4. Show conflict resolution UI when conflict detected

### Files to Modify
**Schema:**
- `drizzle/schema.ts` - Add version columns

**Server:**
- `server/routers/orders.ts` - Add version check
- `server/routers/clients.ts` - Add version check
- `server/routers/inventory.ts` - Add version check

**Client:**
- `client/src/components/common/ConflictDialog.tsx` - Create conflict UI

### Implementation
```typescript
// Schema
version: int('version').notNull().default(1),

// Router
updateOrder: protectedProcedure
  .input(z.object({
    id: z.number(),
    version: z.number(),
    ...data
  }))
  .mutation(async ({ input }) => {
    const result = await db.update(orders)
      .set({ ...input, version: sql`version + 1` })
      .where(and(
        eq(orders.id, input.id),
        eq(orders.version, input.version)
      ));

    if (result.rowsAffected === 0) {
      throw new TRPCError({
        code: 'CONFLICT',
        message: 'Record was modified by another user'
      });
    }
  });
```

### Acceptance Criteria
- Version field added to critical tables
- Stale updates rejected with clear error
- User sees conflict resolution options
- No silent data loss
