# BUG-036: priceAlertsService Test Failures - Incomplete Mock

## Problem Statement

2 tests in `server/services/priceAlertsService.test.ts` are failing due to incomplete mocking of dependencies.

## Test Failures

### Failure 1: `createPriceAlert` test

```
FAIL  server/services/priceAlertsService.test.ts > priceAlertsService > createPriceAlert > should create a price alert for a client
AssertionError: expected +0 to be 1 // Object.is equality
```

**Cause:** The mock for `db.insert().values().returning()` isn't being used correctly because the actual service uses MySQL's `insertId` pattern, not `returning()`.

### Failure 2: `checkPriceAlerts` test

```
FAIL  server/services/priceAlertsService.test.ts > priceAlertsService > checkPriceAlerts > should identify triggered alerts when price drops below target
Error: [vitest] No "getClientPricingRules" export is defined on the "../pricingEngine" mock.
```

**Cause:** The test mocks `../pricingEngine` but only includes `calculateRetailPrice`. The service also calls `getClientPricingRules` (line 263 in priceAlertsService.ts).

## Root Cause

The test's mock of `../pricingEngine` is incomplete:

```typescript
// Current mock (incomplete)
vi.mock('../pricingEngine', () => ({
  calculateRetailPrice: vi.fn(),
}));

// Required mock (complete)
vi.mock('../pricingEngine', () => ({
  calculateRetailPrice: vi.fn(),
  getClientPricingRules: vi.fn(),  // Missing!
}));
```

Additionally, the `createPriceAlert` mock needs to handle MySQL's insert result structure which returns `insertId` instead of using `returning()`.

## Solution

1. Add `getClientPricingRules` to the `../pricingEngine` mock
2. Fix the `createPriceAlert` mock to return correct MySQL insertId structure
3. Update mock setup in `beforeEach` to configure `getClientPricingRules` return value

## Files to Modify

- `server/services/priceAlertsService.test.ts`

## Code Changes

### Fix 1: Add missing mock export

```typescript
vi.mock('../pricingEngine', () => ({
  calculateRetailPrice: vi.fn(),
  getClientPricingRules: vi.fn(),
}));
```

### Fix 2: Configure mock in beforeEach

```typescript
beforeEach(() => {
  vi.clearAllMocks();
  
  // Configure getClientPricingRules mock
  vi.mocked(getClientPricingRules).mockResolvedValue({
    // Return appropriate pricing rules structure
  });
  
  // ... rest of setup
});
```

### Fix 3: Fix insert mock for MySQL

The mock needs to return the MySQL result structure with `insertId`:

```typescript
mockDb.insert.mockReturnValue({
  values: vi.fn().mockResolvedValue([{ insertId: 1 }]),
});
```

## Verification

```bash
pnpm test server/services/priceAlertsService.test.ts
```

All 6 tests should pass:
- ✅ should create a price alert for a client
- ✅ should return error if batch not found
- ✅ should identify triggered alerts when price drops below target
- ✅ should not trigger alerts when price is above target
- ✅ should deactivate an active price alert
- ✅ should send notifications for triggered alerts

## Acceptance Criteria

- [ ] `getClientPricingRules` added to pricingEngine mock
- [ ] Mock configured with appropriate return values
- [ ] `createPriceAlert` mock returns correct MySQL insertId structure
- [ ] All 6 priceAlertsService tests pass
- [ ] Zero TypeScript errors
