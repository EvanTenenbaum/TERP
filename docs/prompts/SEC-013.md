# SEC-013: Calendar Router Security

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-013 -->
<!-- TASK_TITLE: Calendar Router Security - Uses publicProcedure -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** SEC-013
**Estimated Time:** 4-6h
**Module:** `server/routers/calendar.ts`, `server/routers/calendarRecurrence.ts`, `server/routers/calendarInvitations.ts`, `server/routers/calendarParticipants.ts`
**Priority:** MEDIUM

---

## Problem Statement

The ST-045 User Flow Analysis identified that multiple calendar router procedures use `publicProcedure` instead of `protectedProcedure`. While calendar data may not be as sensitive as financial data, this allows:

1. Unauthenticated users to view all calendar events
2. Unauthenticated users to create/modify calendar events
3. Potential spam/abuse of calendar system
4. No audit trail of who made changes

## Affected Endpoints

### calendar.ts (Main Router)
| Procedure | Current | Recommended |
|-----------|---------|-------------|
| `getEvents` | publicProcedure | protectedProcedure |
| `getEventById` | publicProcedure | protectedProcedure |
| `createEvent` | publicProcedure | protectedProcedure |
| `updateEvent` | publicProcedure | protectedProcedure |
| `deleteEvent` | publicProcedure | protectedProcedure |
| `getEventsByEntity` | publicProcedure | protectedProcedure |
| `getEventHistory` | publicProcedure | protectedProcedure |
| `getEventsByClient` | publicProcedure | protectedProcedure |

### calendarRecurrence.ts
| Procedure | Current | Recommended |
|-----------|---------|-------------|
| `getRecurrenceRule` | publicProcedure | protectedProcedure |
| `getInstances` | publicProcedure | protectedProcedure |
| `modifyInstance` | publicProcedure | protectedProcedure |
| `cancelInstance` | publicProcedure | protectedProcedure |
| `updateRecurrenceRule` | publicProcedure | protectedProcedure |

### calendarInvitations.ts
| Procedure | Current | Recommended |
|-----------|---------|-------------|
| `createInvitation` | publicProcedure | protectedProcedure |
| `sendInvitation` | publicProcedure | protectedProcedure |
| `respondToInvitation` | publicProcedure | protectedProcedure |
| `getPendingInvitations` | publicProcedure | protectedProcedure |
| `bulkSendInvitations` | publicProcedure | protectedProcedure |

### calendarParticipants.ts
| Procedure | Current | Recommended |
|-----------|---------|-------------|
| `getParticipants` | publicProcedure | protectedProcedure |
| `addParticipant` | publicProcedure | protectedProcedure |
| `removeParticipant` | publicProcedure | protectedProcedure |

## Objectives

1. Replace `publicProcedure` with `protectedProcedure` for all calendar mutations
2. Consider keeping some read operations public if there's a business need
3. Add appropriate permission middleware if granular control needed
4. Ensure no regression for authenticated users

## Reference Documentation

- **Flow Guide:** `docs/reference/FLOW_GUIDE.md` (Domain 6: Calendar)
- **Flow Matrix:** `docs/reference/USER_FLOW_MATRIX.csv` (filter by Domain=Calendar)

## Deliverables

- [ ] Replace `publicProcedure` with `protectedProcedure` in `calendar.ts`
- [ ] Replace `publicProcedure` with `protectedProcedure` in `calendarRecurrence.ts`
- [ ] Replace `publicProcedure` with `protectedProcedure` in `calendarInvitations.ts`
- [ ] Replace `publicProcedure` with `protectedProcedure` in `calendarParticipants.ts`
- [ ] Verify unauthenticated requests return 401
- [ ] Verify authenticated users can still access calendar
- [ ] Update `docs/reference/FLOW_GUIDE.md` with new auth requirements
- [ ] All tests passing

## Implementation Notes

Consider whether `calendarViews` procedures need similar treatment - they already use `protectedProcedure` which is the correct pattern.

The `getMyEvents` procedure in calendar.ts already uses `protectedProcedure` - this is the correct pattern that should be applied to other calendar procedures.
