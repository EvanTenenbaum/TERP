# INV-013: Improve getDashboardStats Test Mocks

## Implementation Guide

### Problem

Current test mocks in `server/inventoryDb.test.ts` use fragile call-order tracking (`queryCount++`) that breaks if query order changes. Tests verify mock behavior rather than business logic.

Example of fragile pattern:

```typescript
let queryCount = 0;
const mockDb = {
  where: vi.fn().mockImplementation(function () {
    queryCount++;
    if (queryCount === 1) return totalsResult;
    // ... breaks if query order changes
  }),
};
```

### Current Issues

1. Call-order dependency makes tests brittle
2. `@ts-expect-error` comments indicate type system workarounds
3. Tests pass but don't provide confidence in business logic
4. Difficult to maintain when function implementation changes

### Solution

1. **Use query-type detection instead of call order**:

   ```typescript
   const createMockDb = () => {
     const mockChain = {
       select: vi.fn().mockImplementation(fields => {
         // Detect query type by selected fields
         if (fields.totalUnits) return totalsQuery;
         if (fields.status) return statusQuery;
         if (fields.name) return categoryQuery;
         return mockChain;
       }),
       // ...
     };
     return mockChain;
   };
   ```

2. **Consider integration tests for complex queries**:
   - Unit tests with complex mocks provide false confidence
   - Integration tests against test database are more reliable
   - Move business logic validation to integration tests

3. **Simplify unit tests to test transformations only**:
   ```typescript
   // Unit test: verify result transformation
   test("transforms SQL results to dashboard format", () => {
     const rawResult = { totalUnits: "100.00", totalValue: "500.00" };
     const transformed = transformDashboardResult(rawResult);
     expect(transformed.totalUnits).toBe(100);
     expect(transformed.totalValue).toBe(500);
   });
   ```

### Files to Modify

- `server/inventoryDb.test.ts` - Refactor mock structure
- `server/inventoryDb.ts` - Consider extracting transformation functions

### Verification

```bash
npm test -- server/inventoryDb.test.ts
# All tests should pass with improved structure
```

### Acceptance Criteria

- [ ] Remove call-order dependency from mocks
- [ ] Remove @ts-expect-error comments where possible
- [ ] Tests remain passing after refactor
- [ ] Mock structure is documented with comments
- [ ] Consider recommendation for integration tests
