# DI-001: Implement Real withTransaction Database Wrapper

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-001 -->
<!-- TASK_TITLE: Implement Real withTransaction Database Wrapper -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-001
**Estimated Time:** 8h
**Module:** `server/dbTransaction.ts`

## Context

**Background:**
The `withTransaction` helper at `server/dbTransaction.ts:12-36` is a PLACEHOLDER - it does NOT actually wrap database operations in a transaction. The code itself has a comment acknowledging this.

This means:
- No atomicity for critical writes
- Data corruption risk on partial failures
- Race conditions possible

**Goal:**
Implement real transaction support using Drizzle ORM's transaction API.

**Success Criteria:**
- `withTransaction` actually wraps operations in a database transaction
- Rollback on error works correctly
- All existing callers continue to work

## Implementation Guide

### Step 1: Review Current Implementation

**File:** `server/dbTransaction.ts`

Current placeholder likely looks like:
```typescript
export async function withTransaction<T>(
  callback: (tx: any) => Promise<T>
): Promise<T> {
  // Currently just calls callback without real transaction
  const db = getDb();
  return callback(db);
}
```

### Step 2: Implement Real Transaction

Using Drizzle's transaction API:

```typescript
import { getDb } from "./db";

export async function withTransaction<T>(
  callback: (tx: typeof db) => Promise<T>
): Promise<T> {
  const db = await getDb();

  return db.transaction(async (tx) => {
    return callback(tx);
  });
}
```

### Step 3: Add Error Handling

```typescript
export async function withTransaction<T>(
  callback: (tx: typeof db) => Promise<T>,
  options?: { isolationLevel?: 'read uncommitted' | 'read committed' | 'repeatable read' | 'serializable' }
): Promise<T> {
  const db = await getDb();

  try {
    return await db.transaction(async (tx) => {
      return callback(tx);
    }, options);
  } catch (error) {
    logger.error("Transaction failed, rolling back", { error });
    throw error;
  }
}
```

### Step 4: Update All Callers

Find all usages of `withTransaction` and ensure they:
- Pass the transaction object to database calls
- Don't mix transactional and non-transactional operations

### Step 5: Add Tests

Create transaction tests:
- Verify commit on success
- Verify rollback on error
- Test concurrent transactions

## Deliverables

- [ ] Implement real transaction wrapper using Drizzle
- [ ] Add proper error handling and logging
- [ ] Support transaction isolation levels
- [ ] Update all callers to use transaction correctly
- [ ] Add unit tests for transaction behavior
- [ ] Add integration tests for rollback scenarios

## Quick Reference

**File to modify:** `server/dbTransaction.ts`

**Find callers:**
```bash
grep -r "withTransaction" server/ --include="*.ts"
```

**Drizzle transaction docs:**
https://orm.drizzle.team/docs/transactions
