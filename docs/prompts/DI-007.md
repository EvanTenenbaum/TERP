# DI-007: Migrate VARCHAR to DECIMAL for Numeric Columns

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-007 -->
<!-- TASK_TITLE: Migrate VARCHAR to DECIMAL for Numeric Columns -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-007
**Estimated Time:** 2d
**Module:** `server/schema/*.ts`

## Context

**Background:**
44+ columns storing numeric data use VARCHAR instead of proper numeric types:
- `batches` - price columns
- `inventoryMovements` - quantity columns
- `salePrices` - price columns
- `cogsHistory` - cost columns
- `payments` - amount columns

This causes:
- Type casting issues
- Precision loss
- Sorting problems (string sort vs numeric)
- Calculation errors

**Goal:**
Migrate VARCHAR columns to appropriate numeric types (DECIMAL for money, REAL for quantities).

**Success Criteria:**
- All numeric data in proper column types
- No data loss during migration
- Existing queries work correctly

## Implementation Guide

### Step 1: Inventory All VARCHAR Numeric Columns

```bash
grep -rn "text\|varchar" server/schema/ --include="*.ts" | grep -i "price\|amount\|quantity\|cost\|balance"
```

### Step 2: Categorize by Type

**Money columns (use DECIMAL/NUMERIC):**
- prices, costs, amounts, balances
- Need exact precision

**Quantity columns (use REAL/FLOAT or DECIMAL):**
- weights, counts, quantities
- May need decimal places

### Step 3: Create Migration Script

```sql
-- For each column, create migration:

-- Step 1: Add new column
ALTER TABLE batches ADD COLUMN price_new DECIMAL(10, 2);

-- Step 2: Copy data
UPDATE batches SET price_new = CAST(price AS DECIMAL(10, 2));

-- Step 3: Drop old column (SQLite requires table rebuild)
-- For SQLite, use table recreation pattern

-- Step 4: Rename new column
```

### Step 4: Update Schema Definitions

```typescript
// server/schema/batches.ts
export const batches = sqliteTable("batches", {
  // Change from
  // price: text("price"),
  // To
  price: real("price"),
});
```

### Step 5: Update Application Code

Find all places that parse/format these values:
```bash
grep -rn "parseFloat\|parseInt\|Number(" server/ --include="*.ts"
```

Update to handle numeric types directly.

### Step 6: Test Migration

1. Backup database
2. Run migration
3. Verify data integrity
4. Test calculations
5. Test sorting

## Deliverables

- [ ] Inventory all VARCHAR numeric columns (44+)
- [ ] Categorize as money vs quantity
- [ ] Create migration scripts
- [ ] Update schema definitions
- [ ] Update application code for type changes
- [ ] Test migration on copy of production data

## Quick Reference

**Tables with VARCHAR numerics:**
- `batches`
- `inventoryMovements`
- `salePrices`
- `cogsHistory`
- `payments`

**Find string-to-number conversions:**
```bash
grep -rn "parseFloat\|parseInt" server/ --include="*.ts"
```
