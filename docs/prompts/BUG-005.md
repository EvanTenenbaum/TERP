# BUG-005: Returns Workflow Logic Gap

<!-- METADATA (for validation) -->
<!-- TASK_ID: BUG-005 -->
<!-- TASK_TITLE: Returns Workflow Logic Gap -->
<!-- PROMPT_VERSION: 2.0 -->
<!-- LAST_VALIDATED: 2025-12-17 -->

## Context

**Problem:**
The returns workflow had unrealistic UX (manual Batch ID entry), hardcoded user handling, and unclear inventory restocking behavior. This blocked end-to-end returns processing.

**Goal:**
Make returns usable and realistic: find an order, select its line items, create a return with the authenticated user context, and ensure inventory is restocked correctly.

## Implementation Guide

### Key areas to review

- `server/routers/returns.ts`: return creation input, user attribution, and restocking logic
- `client/src/pages/ReturnsPage.tsx`: order lookup UX and item selection flow

### Checklist

1. **Backend: remove hardcoded/unsafe inputs**
   - Ensure the return creation procedure uses authenticated user context (no hardcoded user IDs)
   - Avoid requiring the user to manually type Batch IDs

2. **Frontend: implement realistic flow**
   - Add order lookup (by ID / order number as supported)
   - Render line items for selection and build the return payload from selected items

3. **Inventory restocking**
   - Verify the return results in appropriate inventory adjustments (on-hand/restock) for the returned batches/items
   - Ensure the system behaves sensibly when restocking cannot be performed (error messaging, safe failure)

4. **Validation**
   - Manual smoke: create a return for an order with at least one line item, confirm inventory changes reflect the return
   - Ensure permission checks remain intact and errors are user-friendly
     git add .
     git commit -m "Fix BUG-005: Command palette keyboard shortcut"
     git push origin bug-005-fix:main

```

### Step 2.2: Update Roadmap
- Mark `BUG-005` as `âœ… COMPLETE`.
```
