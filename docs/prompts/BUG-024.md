# BUG-024: Fix Production Infinite Spinner (Frontend Bundle Crash)

## Implementation Guide

Production was stuck on the loading spinner because the browser bundle crashed before React could mount.

### Steps

1. Reproduce in production and inspect the browser console for the first fatal runtime error.
2. Trace the error back to the generated bundle and then to the originating source file(s).
3. Remove any stray top-of-file tokens (e.g. `jsx`, `javascript`) that compile into invalid runtime statements.
4. Ensure dev-only runtime plugins are not included in production Vite builds.
5. Validate the homepage renders and key API calls return successfully.

### Verification

- No fatal `ReferenceError` in browser console
- Spinner is removed and dashboard renders
- Network calls to core endpoints succeed (e.g. `/api/trpc/*` batch, `/version.json`)

# BUG-024: DATABASE_URL Environment Variable Not Accessible in Seed API

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** BUG-024
**Priority:** HIGH
**Estimated Time:** 1-2 hours
**Module:** `server/routers/settings.ts`, DigitalOcean App Platform Configuration

---

## Context

The database seeding functionality on the Settings page (Database tab) fails with the error:

```
DATABASE_URL environment variable is not configured on the server.
Please ensure DATABASE_URL is set in the DigitalOcean App Platform environment variables.
```

**Affected URL:** https://terp-app-b9s35.ondigitalocean.app/settings (Database tab → Seed Database button)

**User Impact:** Users cannot seed the database with test data through the UI, blocking development and testing workflows.

---

## Root Cause

The `DATABASE_URL` environment variable **IS configured** in DigitalOcean App Platform but has an incorrect **scope** setting:

- **Current Scope:** `RUN_TIME` only
- **Required Scope:** `RUN_AND_BUILD_TIME`

While the variable exists as an encrypted SECRET with a valid value, the restrictive scope prevents the application from accessing it properly during the seed operation executed via the tRPC API endpoint.

### Technical Details

**File:** `server/routers/settings.ts` (lines 201-271)

The `seedDatabase` procedure checks for `process.env.DATABASE_URL` at runtime:

```typescript
seedDatabase: publicProcedure
  .input(z.object({
    scenario: z.enum(["light", "full", "edgeCases", "chaos"]).optional().default("light"),
  }))
  .mutation(async ({ input }) => {
    // Check DATABASE_URL availability
    const databaseUrl = process.env.DATABASE_URL;
    if (!databaseUrl) {
      throw new Error(
        "DATABASE_URL environment variable is not configured on the server. " +
        "Please ensure DATABASE_URL is set in the DigitalOcean App Platform environment variables."
      );
    }
    // ... seed execution
  }),
```

**Current DigitalOcean Configuration:**

```yaml
- key: DATABASE_URL
  scope: RUN_TIME
  type: SECRET
  value: EV[1:zCVRMSHilmhmOeot8rlMW4ybXB8kp+mb:KzRCiXBzNYuofA4VoiSDbA==]
```

**Expected Configuration:**

```yaml
- key: DATABASE_URL
  scope: RUN_AND_BUILD_TIME
  type: SECRET
  value: EV[1:zCVRMSHilmhmOeot8rlMW4ybXB8kp+mb:KzRCiXBzNYuofA4VoiSDbA==]
```

---

## Implementation Guide

### Step 1: Backup Current App Spec

```bash
# Authenticate with DigitalOcean
doctl auth init -t <YOUR_DO_API_TOKEN>

# Download current spec
doctl apps spec get 1fd40be5-b9af-4e71-ab1d-3af0864a7da4 --format yaml > /tmp/terp-app-spec-backup.yaml
```

### Step 2: Update DATABASE_URL Scope

**Option A: Via DigitalOcean Console (Recommended for Manual Fix)**

1. Go to https://cloud.digitalocean.com/apps
2. Select the TERP app (ID: `1fd40be5-b9af-4e71-ab1d-3af0864a7da4`)
3. Navigate to **Settings → Environment Variables**
4. Find `DATABASE_URL`
5. Click **Edit**
6. Change **Scope** from `RUN_TIME` to `RUN_AND_BUILD_TIME`
7. Click **Save**
8. Trigger a new deployment

**Option B: Via doctl (Programmatic Fix)**

```bash
# Download current spec
doctl apps spec get 1fd40be5-b9af-4e71-ab1d-3af0864a7da4 --format yaml > /tmp/current-spec.yaml

# Edit the spec (change DATABASE_URL scope)
sed -i 's/scope: RUN_TIME/scope: RUN_AND_BUILD_TIME/g' /tmp/current-spec.yaml

# Validate the change
grep -A 3 "DATABASE_URL" /tmp/current-spec.yaml

# Update the app
doctl apps update 1fd40be5-b9af-4e71-ab1d-3af0864a7da4 --spec /tmp/current-spec.yaml

# Trigger deployment
doctl apps create-deployment 1fd40be5-b9af-4e71-ab1d-3af0864a7da4
```

### Step 3: Verify Deployment

```bash
# Check deployment status
doctl apps get 1fd40be5-b9af-4e71-ab1d-3af0864a7da4

# Monitor deployment logs
doctl apps logs 1fd40be5-b9af-4e71-ab1d-3af0864a7da4 --type build --follow

# Wait for deployment to complete (typically 3-5 minutes)
```

### Step 4: Test Seed Functionality

**Manual Testing:**

1. Navigate to https://terp-app-b9s35.ondigitalocean.app/settings
2. Click on the **Database** tab
3. Select **Light (~30s) - Fast seed for integration tests** scenario
4. Click **Seed Database** button
5. Verify success message appears
6. Check that no error message is displayed

**Automated Testing:**

```bash
# Test the seed API directly
curl -X POST https://terp-app-b9s35.ondigitalocean.app/api/trpc/settings.seedDatabase \
  -H "Content-Type: application/json" \
  -d '{"scenario":"light"}'
```

### Step 5: Update Local App Spec Template

Update `.do/app.yaml` to reflect the correct scope:

```yaml
# Database connection (set actual value in DO control panel)
- key: DATABASE_URL
  scope: RUN_AND_BUILD_TIME # Changed from RUN_TIME
  type: SECRET
```

Commit this change to prevent future misconfigurations:

```bash
git add .do/app.yaml
git commit -m "fix: Update DATABASE_URL scope to RUN_AND_BUILD_TIME in app spec template"
git push origin main
```

---

## Verification Checklist

- [ ] DATABASE_URL scope changed to `RUN_AND_BUILD_TIME` in DigitalOcean
- [ ] New deployment triggered and completed successfully
- [ ] Seed functionality tested via UI (no error message)
- [ ] Seed API tested via curl (returns success)
- [ ] Local app spec template updated (`.do/app.yaml`)
- [ ] Changes committed and pushed to GitHub
- [ ] Deployment verified in production

---

## Related Files

- `server/routers/settings.ts` - Contains seedDatabase tRPC endpoint
- `scripts/seed-realistic-main.ts` - Main seeding script
- `scripts/db-sync.ts` - Database connection utility
- `.do/app.yaml` - Local app specification template
- `.do/app.spec.yaml` - Full app specification

---

## Additional Context

### Why This Pattern?

Other environment variables in the TERP app use `RUN_AND_BUILD_TIME` scope:

- `NODE_ENV`
- `RATE_LIMIT_GET`
- `ENABLE_RBAC`
- `ENABLE_QA_CRONS`
- `UPLOAD_DIR`

The `DATABASE_URL` should follow the same pattern for consistency and to ensure availability across all application lifecycle phases.

### Database Connection Details

**Production Database:**

- Host: `terp-mysql-db-do-user-28175253-0.m.db.ondigitalocean.com`
- Port: `25060`
- User: `doadmin`
- Database: `defaultdb`
- SSL: Required

**Connection String Format:**

```
mysql://doadmin:<REDACTED>@terp-mysql-db-do-user-28175253-0.m.db.ondigitalocean.com:25060/defaultdb?ssl=true
```

---

## Prevention

To prevent similar issues in the future:

1. **Document environment variable scope requirements** in `.do/app.yaml` comments
2. **Add environment variable validation** to application startup script
3. **Create a deployment checklist** that includes environment variable verification
4. **Add automated tests** that verify critical environment variables are accessible

---

**Created:** November 29, 2025
**Status:** Identified, Fix in Progress
**Assigned:** Autonomous AI Agent
