# BUG-073: Fix Race Conditions in Debounced Search

## Implementation Guide

### Problem
In `PurchaseModal.tsx` (lines 58-70) and other components, debounced queries can return stale results if user rapidly changes selection while query resolves.

### Current Pattern
```typescript
const debouncedSearch = useDebounce(search, 300);
const { data } = trpc.query.useQuery({ query: debouncedSearch });
// No request tracking - stale data possible
```

### Solution
1. Add request ID tracking to ignore stale responses
2. Use abort controllers for in-flight requests
3. Only display results matching current query

### Files to Modify
- `client/src/components/inventory/PurchaseModal.tsx`
- Other components with debounced search

### Implementation
```typescript
const [requestId, setRequestId] = useState(0);
const currentRequestRef = useRef(0);

const { data } = trpc.query.useQuery(
  { query: debouncedSearch, requestId },
  {
    onSuccess: (data) => {
      // Only use data if this is the latest request
      if (data.requestId !== currentRequestRef.current) return;
      setResults(data.results);
    }
  }
);

useEffect(() => {
  currentRequestRef.current = requestId;
  setRequestId(prev => prev + 1);
}, [debouncedSearch]);
```

### Acceptance Criteria
- No stale search results displayed
- Fast typing doesn't cause flickering
- Most recent query always wins
