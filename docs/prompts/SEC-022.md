# SEC-022: Remove Hardcoded Production URLs

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-022 -->
<!-- TASK_TITLE: Remove Hardcoded Production URLs -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** SEC-022
**Estimated Time:** 2h
**Module:** Multiple files

## Context

**Background:**
Several files contain hardcoded production URLs:
- `server/routers/vipPortal.ts:533` - DigitalOcean URL
- `server/routers/receipts.ts:562` - Production domain

This creates:
- Infrastructure disclosure risk
- Wrong URLs if environment variables are missing
- Harder environment switching

**Goal:**
Replace all hardcoded URLs with environment variables.

**Success Criteria:**
- No production URLs hardcoded in source
- All URLs configurable via environment
- Fallback to safe defaults (not production)

## Implementation Guide

### Step 1: Find All Hardcoded URLs

```bash
grep -rn "digitalocean" server/
grep -rn "terp.com" server/
grep -rn "https://" server/ | grep -v "example.com"
```

### Step 2: Update vipPortal.ts

**File:** `server/routers/vipPortal.ts:533`

```typescript
// BEFORE
const baseUrl = "https://terp-app-xxxxx.ondigitalocean.app";

// AFTER
const baseUrl = process.env.APP_BASE_URL;
if (!baseUrl) {
  throw new Error("APP_BASE_URL environment variable must be set");
}
```

### Step 3: Update receipts.ts

**File:** `server/routers/receipts.ts:562`

```typescript
// BEFORE
const domain = "https://app.terp.com";

// AFTER
const domain = process.env.APP_BASE_URL;
if (!domain) {
  throw new Error("APP_BASE_URL environment variable must be set");
}
```

### Step 4: Update Environment Files

Add to `.env.example`:
```
APP_BASE_URL=http://localhost:5173
```

### Step 5: Update Deployment

Ensure all deployment environments set `APP_BASE_URL`.

## Deliverables

- [ ] Remove hardcoded URL from `vipPortal.ts`
- [ ] Remove hardcoded URL from `receipts.ts`
- [ ] Add APP_BASE_URL to `.env.example`
- [ ] Update deployment documentation
- [ ] Add startup validation for required URLs

## Quick Reference

**Files to modify:**
- `server/routers/vipPortal.ts:533`
- `server/routers/receipts.ts:562`
- `.env.example`

**Validation command:**
```bash
grep -rn "digitalocean\|terp.com" server/routers/
# Should return no results after fix
```
