# WF-005: Add SLA Tracking and Escalation

## Implementation Guide

### Problem

No time-based tracking for workflow items:

| Missing Feature                      | Impact                     |
| ------------------------------------ | -------------------------- |
| No deadline when batch enters status | Items sit indefinitely     |
| No escalation mechanism              | Blocked items not surfaced |
| No aging visibility                  | No urgency indicators      |

**Current batch_status_history table** (`drizzle/schema.ts:5868`):

```typescript
{
  (id, batchId, fromStatusId, toStatusId, changedBy, notes, createdAt);
}
// Note: NO slaDeadline, NO isEscalated
```

### Prerequisites

**WF-004 must be completed first** - it adds `slaMinutes` and `escalationRoleId` to `workflow_statuses`.

### Solution

**Step 1: Extend batch_status_history table**

```typescript
// drizzle/schema.ts - Add to batchStatusHistory
slaDeadline: timestamp("slaDeadline"),  // When this status transition expires
isEscalated: int("isEscalated").notNull().default(0),  // 0 = false, 1 = true
escalatedAt: timestamp("escalatedAt"),
```

**Step 2: Set SLA deadline on status change**

```typescript
// server/services/workflowOrchestrationService.ts - Update onStatusChange
export async function onStatusChange(...) {
  // ... existing code ...

  // Record status change with SLA deadline
  const slaDeadline = newStatus.slaMinutes
    ? new Date(Date.now() + newStatus.slaMinutes * 60 * 1000)
    : null;

  await db.insert(batchStatusHistory).values({
    batchId,
    fromStatusId,
    toStatusId,
    changedBy,
    slaDeadline,  // NEW: Set deadline
    isEscalated: 0,
  });
}
```

**Step 3: Create escalation cron job**

```typescript
// server/cron/slaEscalationCron.ts (NEW FILE)
import { getDb } from "../db";
import {
  batchStatusHistory,
  workflowStatuses,
  batches,
} from "../../drizzle/schema";
import { sendNotification } from "../services/notificationService";
import { getUsersByRoleId } from "../db/queries/users";
import { and, lt, eq, isNull } from "drizzle-orm";

/**
 * Run every 15 minutes via cron
 * Finds batches that have exceeded their SLA deadline and escalates
 */
export async function runSlaEscalation(): Promise<{ escalatedCount: number }> {
  const db = await getDb();
  if (!db) return { escalatedCount: 0 };

  const now = new Date();

  // Find overdue, non-escalated status transitions
  const overdueItems = await db
    .select({
      history: batchStatusHistory,
      status: workflowStatuses,
      batch: batches,
    })
    .from(batchStatusHistory)
    .innerJoin(
      workflowStatuses,
      eq(batchStatusHistory.toStatusId, workflowStatuses.id)
    )
    .innerJoin(batches, eq(batchStatusHistory.batchId, batches.id))
    .where(
      and(
        lt(batchStatusHistory.slaDeadline, now),
        eq(batchStatusHistory.isEscalated, 0)
      )
    );

  let escalatedCount = 0;

  for (const item of overdueItems) {
    // Mark as escalated
    await db
      .update(batchStatusHistory)
      .set({ isEscalated: 1, escalatedAt: now })
      .where(eq(batchStatusHistory.id, item.history.id));

    // Notify escalation role
    if (item.status.escalationRoleId) {
      const escalationUsers = await getUsersByRoleId(
        item.status.escalationRoleId
      );

      for (const user of escalationUsers) {
        await sendNotification({
          recipientType: "user",
          userId: user.id,
          type: "warning",
          title: `SLA Exceeded: ${item.batch.batchCode}`,
          message: `Batch has been in "${item.status.name}" status past deadline`,
          link: `/workflow-queue?batchId=${item.batch.id}`,
          channel: "in_app",
        });
      }
    }

    escalatedCount++;
  }

  return { escalatedCount };
}
```

**Step 4: Register cron job**

```typescript
// server/cron/index.ts
import { runSlaEscalation } from "./slaEscalationCron";

// Every 15 minutes
cron.schedule("*/15 * * * *", async () => {
  console.log("[CRON] Running SLA escalation check...");
  const result = await runSlaEscalation();
  console.log(`[CRON] Escalated ${result.escalatedCount} items`);
});
```

**Step 5: Visual indicators in UI**

```typescript
// client/src/components/workflow/WorkflowCard.tsx
import { formatDistanceToNow, isPast } from "date-fns";

function SlaIndicator({ slaDeadline, isEscalated }: { slaDeadline?: Date; isEscalated?: boolean }) {
  if (!slaDeadline) return null;

  const isOverdue = isPast(slaDeadline);

  return (
    <div className={cn(
      "text-xs flex items-center gap-1",
      isOverdue ? "text-red-500" : "text-yellow-600",
      isEscalated && "font-bold"
    )}>
      {isEscalated && <AlertTriangle className="w-3 h-3" />}
      {isOverdue
        ? `Overdue by ${formatDistanceToNow(slaDeadline)}`
        : `Due in ${formatDistanceToNow(slaDeadline)}`
      }
    </div>
  );
}
```

### Files to Modify

| File                                              | Changes                                   |
| ------------------------------------------------- | ----------------------------------------- |
| `drizzle/schema.ts:5868`                          | Add slaDeadline, isEscalated, escalatedAt |
| `drizzle/migrations/XXXX.sql`                     | ALTER TABLE statements                    |
| `server/services/workflowOrchestrationService.ts` | Set slaDeadline on change                 |
| `server/cron/slaEscalationCron.ts`                | **NEW FILE**                              |
| `server/cron/index.ts`                            | Register cron job                         |
| `client/src/components/workflow/WorkflowCard.tsx` | SLA indicator component                   |
| `client/src/pages/WorkflowQueuePage.tsx`          | Show SLA info in cards                    |

### Verification

```bash
# 1. Verify schema changes
grep -A5 "slaDeadline" drizzle/schema.ts

# 2. Verify cron file exists
ls -la server/cron/slaEscalationCron.ts

# 3. Manual test
# - Set status with slaMinutes = 1 (1 minute)
# - Move batch to that status
# - Wait 1 minute
# - Run: npx tsx server/cron/slaEscalationCron.ts
# - Verify escalation notification sent
```

### Acceptance Criteria

- [ ] `batch_status_history` table has SLA columns
- [ ] SLA deadline set when batch enters status with slaMinutes
- [ ] Cron job runs every 15 minutes
- [ ] Escalation notification sent to configured role
- [ ] UI shows time remaining/overdue indicator
- [ ] Escalated items show warning badge

### Estimate

16 hours
