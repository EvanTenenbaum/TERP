# CON-001: Standardize Soft Delete Across All Entities

## Problem

Inconsistent deletion patterns break audit trails:

- Orders: soft delete (deletedAt)
- Draft orders: hard delete at `server/ordersDb.ts:1450`
- Calendar events: hard delete throughout `server/calendarDb.ts`
- Inbox items: hard delete at `server/inboxDb.ts:285`

## Implementation Guide

### Step 1: Audit All Deletion Patterns

Search for hard deletes:

```bash
grep -rn "\.delete(" server/ --include="*.ts" | grep -v test
```

### Step 2: Add deletedAt Column to Tables Missing It

```sql
ALTER TABLE calendar_events ADD COLUMN deleted_at TIMESTAMP NULL;
ALTER TABLE inbox_items ADD COLUMN deleted_at TIMESTAMP NULL;
```

### Step 3: Convert Hard Deletes to Soft Deletes

```typescript
// BEFORE (hard delete):
await db.delete(calendarEvents).where(eq(calendarEvents.id, eventId));

// AFTER (soft delete):
await db
  .update(calendarEvents)
  .set({ deletedAt: new Date() })
  .where(eq(calendarEvents.id, eventId));
```

### Step 4: Update Queries to Exclude Deleted

```typescript
// Add to all queries:
.where(
  and(
    eq(calendarEvents.id, eventId),
    isNull(calendarEvents.deletedAt)
  )
)
```

### Step 5: Create Soft Delete Helper

```typescript
// server/_core/softDelete.ts
export async function softDelete<T>(table: T, id: number): Promise<number> {
  const db = await getDb();
  const result = await db
    .update(table)
    .set({ deletedAt: new Date() })
    .where(eq(table.id, id));
  return result.rowsAffected;
}
```

## Acceptance Criteria

- [ ] All entities use soft delete pattern
- [ ] deletedAt column added where missing
- [ ] Queries exclude soft-deleted records
- [ ] Audit trail preserved for all deletions
- [ ] Migration script for schema changes

## Files to Modify

- `server/ordersDb.ts`
- `server/calendarDb.ts`
- `server/inboxDb.ts`
- `drizzle/schema.ts`
