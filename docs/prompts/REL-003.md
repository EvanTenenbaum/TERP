# REL-003: Migrate Money Amounts to DECIMAL (Dual-Write + Backfill + Cutover)

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-003 -->
<!-- TASK_TITLE: Migrate Money Amounts to DECIMAL -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-003  
**Estimated Time:** 2d  
**Module:** `drizzle/`, `server/accountingDb.ts`, `server/services/orderAccountingService.ts`

## Implementation Guide

### Problem
String-backed money fields and mixed representations create drift risk for AR/AP and ledger balances.

### Required Approach (No Downtime Pattern)
- Same dual-write/backfill/cutover pattern as REL-002, but for money fields.
- Define canonical "money truth":
  - Ledger: accounting truth (immutability + balance)
  - Operational: invoice/payment/credit views must reconcile to ledger expectations

### Files to Modify
- Schema/migrations: `drizzle/schema*.ts`, migrations
- Money logic: `server/accountingDb.ts`, `server/services/orderAccountingService.ts`
- Relevant `server/routers/*` procedures that create invoices, record payments, apply credits

### Tests
- Extend `server/accounting.integration.test.ts` to cover:
  - partial payments
  - overpayment/unallocated payments
  - credit application edge cases
  - rounding rules

### Acceptance Criteria
- DECIMAL columns exist, dual-write implemented, backfill complete.
- Invariant checks for amountDue and applied totals pass on seeded dataset.
- Cutover flag exists and mismatch logging is in place.
