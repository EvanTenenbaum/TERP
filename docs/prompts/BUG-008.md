# BUG-008: Purchase Orders Page Crashes with Application Error

<!-- METADATA (for validation) -->
<!-- TASK_ID: BUG-008 -->
<!-- TASK_TITLE: Fix Purchase Orders Page Crash -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2025-11-22 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** BUG-008  
**Priority:** P0 (CRITICAL - APPLICATION CRASH)  
**Estimated Time:** 2-4 hours  
**Module:** Purchase Orders

âš ï¸ **CRITICAL:** This is a P0 blocker. The feature is completely unusable.

---

## ðŸ“‹ Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Investigation](#phase-2-investigation)
4. [Phase 3: Fix Implementation](#phase-3-fix-implementation)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)

---

## ðŸŽ¯ Context

**Problem:**
Navigating to `/purchase-orders` causes an unhandled application error (White screen of death). Error ID: `f7826da2e91648ebb82ddbbec10f2bc6`.

**Symptoms:**
- White screen with error message
- "An unexpected error occurred"
- Completely broken functionality

**Goal:**
Identify the root cause of the crash and fix it to restore Purchase Order management functionality.

**Success Criteria:**
- [ ] `/purchase-orders` page loads successfully
- [ ] List of purchase orders is displayed
- [ ] No console errors
- [ ] User can navigate to details/create (smoke test)

---

## Phase 1: Pre-Flight Check

### Step 1.1: Register Session
1. Create session file: `docs/sessions/active/Session-$(date +%Y%m%d)-BUG-008-$(openssl rand -hex 4).md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Register in `docs/ACTIVE_SESSIONS.md`.

### Step 1.2: Create Branch
```bash
git checkout main
git pull origin main
git checkout -b bug-008-purchase-orders-crash
```

---

## Phase 2: Investigation

### Step 2.1: Reproduce the Error
1. Start the development server: `npm run dev`
2. Navigate to `/purchase-orders`
3. Check the browser console for the exact error stack trace.
4. Check the server terminal for any backend errors.

### Step 2.2: Analyze the Code
1. **Frontend:** Check `client/src/pages/PurchaseOrdersPage.tsx` (or similar).
   - Look for null pointer exceptions.
   - Check tRPC query usage.
   - Check for missing components.
2. **Backend:** Check `server/routers/purchaseOrders.ts`.
   - Verify the `list` or `getAll` procedure exists.
   - Check for permission issues.
   - Check for SQL errors.
3. **Database:** Check `drizzle/schema.ts` for `purchaseOrders` table definition.

**Common Suspects:**
- Frontend trying to map over `undefined` (e.g., `data.map(...)` when `data` is undefined).
- tRPC router not responding correctly (500 error).
- Date formatting issues.
- Permission denied errors masquerading as crashes.

---

## Phase 3: Fix Implementation

### Step 3.1: Implement the Fix
Based on investigation:
- If **Frontend Crash:** Add safe checks (`?.`), default values (`|| []`), or proper loading states (`if (isLoading) ...`).
- If **Backend Error:** Fix the tRPC procedure or SQL query.
- If **Permission Error:** Grant required permissions or handle 403 gracefully.

**Example Fix (Frontend):**
```tsx
// Before (Crash prone)
{data.map(po => <PurchaseOrderRow key={po.id} po={po} />)}

// After (Safe)
{isLoading ? (
  <Skeleton />
) : data?.length ? (
  data.map(po => <PurchaseOrderRow key={po.id} po={po} />)
) : (
  <EmptyState />
)}
```

### Step 3.2: Verify the Fix
1. Reload the page.
2. Verify no crash occurs.
3. Verify data loads (or empty state displays correctly).
4. Check console for clean output.

### Step 3.3: Add Test Coverage
1. If possible, add a unit test for the component.
2. Or ensure an existing E2E test covers this route (Test Protocol TS-7.2).

---

## Phase 4: Completion

### Step 4.1: Update Roadmap
- Mark `BUG-008` as `âœ… COMPLETE`.
- Note the root cause and fix.

### Step 4.2: Commit and Push
```bash
git add .
git commit -m "Fix BUG-008: Purchase Orders page crash"
git push origin bug-008-purchase-orders-crash:main
```

### Step 4.3: Archive Session
- Move session to `docs/sessions/completed/`.
- Remove from `docs/ACTIVE_SESSIONS.md`.

---

## âš¡ Quick Reference

- **Route:** `/purchase-orders`
- **Component:** `PurchaseOrdersPage.tsx`
- **Router:** `purchaseOrders.ts`
