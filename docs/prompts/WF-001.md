# WF-001: Wire Notification Triggers to Business Events

## Implementation Guide

### Problem

The `server/services/notificationTriggers.ts` file defines 15 trigger functions that encapsulate business notification logic, but only 3 are actually called:

**Currently Working (3/15):**
| Trigger | Called From | Line |
|---------|-------------|------|
| `onOrderCreated()` | `server/routers/orders.ts` | ~line 245 in `create` mutation |
| `onInvoiceCreated()` | `server/routers/accounting.ts` | ~line 89 |
| `onPaymentReceived()` | `server/routers/accounting.ts` | ~line 156 |

**Dead Code - Never Called (12/15):**
| Trigger | Should Be Called When | Impact |
|---------|----------------------|--------|
| `onOrderConfirmed()` | Order status → CONFIRMED | Clients not notified of confirmations |
| `onOrderShipped()` | Order status → SHIPPED | Clients not notified of shipments |
| `onOrderDelivered()` | Order status → DELIVERED | Clients not notified of deliveries |
| `onInvoiceOverdue()` | Invoice past due date | No overdue reminders sent |
| `onInventoryLow()` | Batch qty < threshold | Inventory team not alerted |
| `onBatchReceived()` | Intake completed | Inventory team not notified |
| `onTaskAssigned()` | Task assigned to user | Users rely on inbox only, no notification |
| `onTaskDueSoon()` | Task due within 24h | No deadline reminders |
| `onAppointmentReminder()` | Appointment within 24h | No appointment reminders |
| `onCreditIssued()` | Credit memo created | Clients not notified of credits |
| `onInterestListSubmitted()` | VIP submits interest | Sales team not notified |
| `onAppointmentRequestStatusChanged()` | Appointment approved/rejected | Clients not notified |

### Root Cause Analysis

The notification service has TWO patterns:

1. **Trigger functions** (`notificationTriggers.ts`) - Encapsulate business logic + multi-recipient handling
2. **Direct calls** (`sendNotification`) - Ad-hoc notifications in specific routers

Some routers use `sendNotification` directly:

- `appointmentRequests.ts` - Uses sendNotification directly (not triggers)
- `intakeReceipts.ts` - Uses sendNotification directly (not triggers)
- `timeOffRequests.ts` - Uses sendNotification directly (not triggers)

**The problem:** The trigger system was built but adoption was incomplete.

### Solution

Wire each trigger to its corresponding mutation:

#### 1. Order Status Triggers (orders.ts)

**File:** `server/routers/orders.ts`
**Mutation:** `updateOrderStatus` or `fulfillOrder`

```typescript
import {
  onOrderConfirmed,
  onOrderShipped,
  onOrderDelivered,
} from "../services/notificationTriggers";

// In status update mutation:
if (newStatus === "CONFIRMED") {
  await onOrderConfirmed({ id: orderId, orderNumber, clientId, clientName });
}
if (newStatus === "SHIPPED") {
  await onOrderShipped({ id: orderId, orderNumber, clientId, clientName });
}
if (newStatus === "DELIVERED") {
  await onOrderDelivered({ id: orderId, orderNumber, clientId, clientName });
}
```

#### 2. Inventory Triggers (inventory.ts)

**File:** `server/routers/inventory.ts`
**Mutation:** `adjustQty` or after any quantity change

```typescript
import { onInventoryLow } from "../services/notificationTriggers";

// After quantity adjustment:
const batch = await getBatchById(batchId);
const lowThreshold = batch.lowStockThreshold || 50;
if (batch.onHandQty <= lowThreshold) {
  await onInventoryLow({
    id: batch.id,
    batchCode: batch.code,
    productName: batch.productName,
    quantity: batch.onHandQty,
    lowStockThreshold: lowThreshold,
  });
}
```

#### 3. Batch Received Trigger (intakeReceipts.ts)

**File:** `server/routers/intakeReceipts.ts`
**Mutation:** `completeIntake` or `finalize`

```typescript
import { onBatchReceived } from "../services/notificationTriggers";

// After intake completion:
await onBatchReceived({
  id: batch.id,
  batchCode: batch.code,
  productName,
  quantity: receivedQty,
});
```

#### 4. Task Triggers (todoTasks.ts)

**File:** `server/routers/todoTasks.ts`
**Current:** Creates inbox item but NOT notification

```typescript
import { onTaskAssigned } from "../services/notificationTriggers";

// In create/assign mutation (after inboxDb.createInboxItem):
if (input.assignedTo && input.assignedTo !== ctx.user.id) {
  await onTaskAssigned({
    id: task.id,
    title: task.title,
    assigneeId: input.assignedTo,
    dueDate: task.dueDate,
  });
}
```

#### 5. Credit Trigger (credits.ts)

**File:** `server/routers/credits.ts`
**Mutation:** `create` or `issue`

```typescript
import { onCreditIssued } from "../services/notificationTriggers";

// After credit creation:
await onCreditIssued({
  id: credit.id,
  creditNumber: credit.creditNumber,
  clientId: credit.clientId,
  clientName,
  creditAmount: credit.amount,
  reason: credit.reason,
});
```

#### 6. VIP Portal Trigger (vipPortal.ts)

**File:** `server/routers/vipPortal.ts`
**Mutation:** `submitInterestList` or similar

```typescript
import { onInterestListSubmitted } from "../services/notificationTriggers";

// After interest list submitted:
await onInterestListSubmitted({
  id: interestList.id,
  clientId,
  clientName,
  itemCount: items.length,
  totalValue,
});
```

#### 7. Cron Jobs (NEW FILES)

**Task Reminders:** `server/cron/taskReminderCron.ts`

```typescript
// Run daily at 8am
// Query tasks due within 24h where reminder not sent
// Call onTaskDueSoon for each
```

**Appointment Reminders:** `server/cron/appointmentReminderCron.ts`

```typescript
// Run hourly
// Query appointments within 24h where reminder not sent
// Call onAppointmentReminder for each
```

**Invoice Overdue:** `server/cron/invoiceOverdueCron.ts`

```typescript
// Run daily at 9am
// Query invoices past due date where overdue notification not sent
// Call onInvoiceOverdue for each
```

### Files to Modify

| File                                     | Changes                                                |
| ---------------------------------------- | ------------------------------------------------------ |
| `server/routers/orders.ts`               | Add import, call triggers on status change             |
| `server/routers/inventory.ts`            | Add import, call onInventoryLow after qty adjust       |
| `server/routers/intakeReceipts.ts`       | Add import, call onBatchReceived on complete           |
| `server/routers/todoTasks.ts`            | Add import, call onTaskAssigned (in addition to inbox) |
| `server/routers/credits.ts`              | Add import, call onCreditIssued on create              |
| `server/routers/vipPortal.ts`            | Add import, call onInterestListSubmitted               |
| `server/cron/taskReminderCron.ts`        | **NEW** - Daily task due reminders                     |
| `server/cron/appointmentReminderCron.ts` | **NEW** - Hourly appointment reminders                 |
| `server/cron/invoiceOverdueCron.ts`      | **NEW** - Daily overdue invoice alerts                 |

### Acceptance Criteria

- [ ] All 15 notification triggers are invoked at appropriate times
- [ ] Order status changes trigger client notifications
- [ ] Low inventory alerts go to inventory team
- [ ] Task assignments create both inbox item AND notification
- [ ] Credit issuance notifies clients
- [ ] Interest list submission notifies sales team
- [ ] Cron jobs run on schedule and create reminders
- [ ] Notifications appear in user notification center
- [ ] Email/SMS sent if user has those channels enabled

### Verification

```bash
# 1. Verify all triggers are imported
grep -rn "import.*notificationTriggers" server/routers server/cron
# Expected: Should show imports in orders, inventory, intakeReceipts, todoTasks, credits, vipPortal

# 2. Verify trigger invocations
for trigger in onOrderConfirmed onOrderShipped onOrderDelivered onInventoryLow onBatchReceived onTaskAssigned onCreditIssued onInterestListSubmitted; do
  echo "=== $trigger ==="
  grep -rn "$trigger(" server/routers server/cron --include="*.ts" | grep -v "export async"
done
# Expected: Each trigger should have at least one invocation

# 3. Verify cron jobs exist
ls server/cron/*Cron.ts
# Expected: taskReminderCron.ts, appointmentReminderCron.ts, invoiceOverdueCron.ts
```

### Testing Checklist

| Scenario        | Test                                                              |
| --------------- | ----------------------------------------------------------------- |
| Order confirmed | Update order status to CONFIRMED, verify client gets notification |
| Order shipped   | Update order status to SHIPPED, verify client gets notification   |
| Low inventory   | Adjust batch qty below threshold, verify inventory team notified  |
| Batch received  | Complete intake, verify inventory team notified                   |
| Task assigned   | Assign task to user, verify they get notification + inbox item    |
| Credit issued   | Create credit memo, verify client notified                        |
| Interest list   | Submit interest list as VIP, verify sales team notified           |
| Task due soon   | Create task due in 12h, run cron, verify reminder sent            |
| Invoice overdue | Create invoice past due, run cron, verify reminder sent           |

### Estimate

8 hours total:

- Order triggers: 1h
- Inventory triggers: 1h
- Task triggers: 1h
- Credit/VIP triggers: 1h
- Cron jobs (3): 3h
- Testing: 1h
