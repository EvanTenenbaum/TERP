# REL-004: Critical Mutation Wrapper (Transactional + Retry + Standardized Errors)

<!-- METADATA (for validation) -->
<!-- TASK_ID: REL-004 -->
<!-- TASK_TITLE: Critical Mutation Wrapper -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-08 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** REL-004  
**Estimated Time:** 16h  
**Module:** `server/_core/`, `server/inventory*.ts`, `server/accounting*.ts`

## Implementation Guide

### Problem
Critical flows (inventory and money) write multiple tables. If not uniformly wrapped, partial writes and inconsistent retry behavior can corrupt state.

### Solution
Create `server/_core/criticalMutation.ts` built on:
- `withRetryableTransaction` from `server/_core/dbTransaction.ts`
- Structured logging: `mutationId`, `correlationId`, actor, permission, entity refs
- Standard error shaping:
  - business-rule failures -> non-retry
  - transient DB errors -> retry

### Apply Wrapper To (Minimum)
- Inventory: adjustments, intake/receive, fulfillment/shipping, reversal
- Money: invoice generation, payment recording, credit apply, reversal/void, ledger posting

### Files to Modify
- `server/_core/criticalMutation.ts` (new)
- `server/inventoryMovementsDb.ts`, `server/inventoryDb.ts`
- `server/accountingDb.ts`, `server/services/orderAccountingService.ts`
- `server/_core/logger.ts` / `server/_core/requestLogger.ts` as needed

### Tests
- Add at least 1 atomicity test per domain:
  - force a failure mid-flow and assert no partial writes occurred

### Acceptance Criteria
- No critical mutation performs multi-table writes outside wrapper/transaction.
- Errors are consistent and actionable.
