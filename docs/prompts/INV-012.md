# INV-012: Add Dashboard/Sales Consistency Integration Tests

## Implementation Guide

### Problem

No integration test verifies that dashboard inventory metrics match sales module inventory counts. This was the original bug that caused the inconsistency (dashboard showed inflated values that didn't match what was available in sales).

### Background

INV-CONSISTENCY-001 and INV-CONSISTENCY-002 fixed the data queries, but there's no test to prevent regression.

### Solution

Create integration tests that verify:

1. Dashboard totals only count LIVE + PHOTOGRAPHY_COMPLETE batches
2. Sales sheet shows all batches with qty > 0
3. Aging widget matches dashboard totals

### Test Scenarios

```typescript
// tests/integration/inventory-consistency.test.ts

describe("Inventory Consistency", () => {
  // Seed data with mixed batch statuses
  const seedData = [
    { id: 1, status: "LIVE", qty: 100, value: 500 },
    { id: 2, status: "PHOTOGRAPHY_COMPLETE", qty: 50, value: 250 },
    { id: 3, status: "QUARANTINED", qty: 200, value: 400 },
    { id: 4, status: "ON_HOLD", qty: 75, value: 150 },
    { id: 5, status: "SOLD_OUT", qty: 0, value: 0 },
  ];

  test("dashboard totals only count sellable inventory", async () => {
    const stats = await getDashboardStats();
    // Should only count LIVE + PHOTOGRAPHY_COMPLETE
    expect(stats.totalUnits).toBe(150); // 100 + 50
    expect(stats.totalValue).toBe(750); // 500 + 250
  });

  test("status counts include all statuses", async () => {
    const stats = await getDashboardStats();
    expect(stats.statusCounts.LIVE).toBe(1);
    expect(stats.statusCounts.PHOTOGRAPHY_COMPLETE).toBe(1);
    expect(stats.statusCounts.QUARANTINED).toBe(1);
    expect(stats.statusCounts.ON_HOLD).toBe(1);
  });

  test("sales sheet shows all items with qty > 0", async () => {
    const items = await getInventoryWithPricing(clientId);
    // Should show 4 items (all except SOLD_OUT which has qty=0)
    expect(items.length).toBe(4);
    expect(items.map(i => i.status)).toContain("QUARANTINED");
    expect(items.map(i => i.status)).toContain("ON_HOLD");
  });

  test("aging widget only shows sellable batches", async () => {
    const aging = await getAgingSummary();
    // Should only have LIVE + PHOTOGRAPHY_COMPLETE batches
    const statuses = aging.items.map(i => i.status);
    expect(statuses).not.toContain("QUARANTINED");
    expect(statuses).not.toContain("ON_HOLD");
  });
});
```

### Files to Create/Modify

- `tests/integration/inventory-consistency.test.ts` (new)
- `tests/fixtures/inventory-fixtures.ts` (add mixed status data)

### Verification

```bash
npm test -- tests/integration/inventory-consistency.test.ts
```

### Acceptance Criteria

- [ ] Integration test file created with all scenarios
- [ ] Test fixtures include mixed batch statuses
- [ ] Tests pass with current implementation
- [ ] Tests added to CI pipeline
- [ ] Documentation updated
