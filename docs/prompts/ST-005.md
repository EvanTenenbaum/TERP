# ST-005: Add Missing Database Indexes

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** ST-005  
**Status:** ready  
**Priority:** HIGH  
**Estimate:** 4-6 hours

---

## üìã Task Overview

Add missing database indexes to all foreign key relationships to improve query performance. Currently, many foreign keys lack indexes, causing slow queries when joining tables or filtering by related records.

**Impact:** Significantly improved query performance for joins and lookups.

---

## üéØ Objectives

1. Audit all foreign key relationships for missing indexes
2. Add indexes to improve query performance
3. Measure and document performance improvements
4. Ensure all tests pass with new indexes

---

## üì¶ Deliverables

- [ ] Index audit report documenting all foreign keys
- [ ] Migration file with new index definitions
- [ ] Performance benchmark results (before/after)
- [ ] Updated schema documentation
- [ ] All tests passing (no regressions)
- [ ] Zero TypeScript errors
- [ ] Session file archived
- [ ] MASTER_ROADMAP updated to ‚úÖ Complete

---

## üöÄ Implementation Guide

### Phase 1: Setup & Audit (1-2 hours)

**1. Clone and setup:**

```bash
git clone https://github.com/EvanTenenbaum/TERP.git
cd TERP
pnpm install
```

**2. Create feature branch:**

```bash
SESSION_ID="Session-$(date +%Y%m%d)-ST-005-$(openssl rand -hex 4)"
git checkout -b "claude/ST-005-db-indexes-${SESSION_ID}"
```

**3. Create session file:**

```bash
cat > "docs/sessions/active/${SESSION_ID}.md" << 'EOF'
# ST-005: Add Missing Database Indexes

**Agent:** [Your name]
**Started:** [Date]
**Status:** In Progress

## Progress
- [ ] Phase 1: Audit complete
- [ ] Phase 2: Indexes added
- [ ] Phase 3: Tests passing
- [ ] Phase 4: Benchmarks complete

## Notes
[Add notes here]
EOF
```

**4. Update ACTIVE_SESSIONS.md:**
Add your session to the active sessions list.

**5. Audit all foreign keys:**

```bash
# List all schema files
ls -1 server/db/schema/*.ts

# For each schema file, identify foreign keys
grep -n "references(" server/db/schema/*.ts
```

**6. Check existing indexes:**

Look for index definitions in schema files:

```typescript
// Example of indexed foreign key
export const orders = pgTable(
  "orders",
  {
    clientId: integer("client_id").references(() => clients.id),
  },
  table => ({
    clientIdIdx: index("orders_client_id_idx").on(table.clientId),
  })
);
```

**7. Create audit report:**

```bash
cat > docs/ST-005-INDEX-AUDIT.md << 'EOF'
# Database Index Audit

## Foreign Keys Without Indexes

### Table: orders
- `client_id` ‚Üí `clients.id` (MISSING INDEX)
- `vendor_id` ‚Üí `vendors.id` (MISSING INDEX)

### Table: inventory
- `product_id` ‚Üí `products.id` (MISSING INDEX)
- `location_id` ‚Üí `locations.id` (MISSING INDEX)

[Continue for all tables...]

## Total Missing Indexes: [COUNT]
EOF
```

### Phase 2: Add Indexes (2-3 hours)

**1. Add indexes to schema files:**

For each missing index, add to the appropriate schema file:

```typescript
// Example: server/db/schema/orders.ts
export const orders = pgTable(
  "orders",
  {
    id: serial("id").primaryKey(),
    clientId: integer("client_id").references(() => clients.id),
    vendorId: integer("vendor_id").references(() => vendors.id),
    // ... other fields
  },
  table => ({
    // Add these indexes
    clientIdIdx: index("orders_client_id_idx").on(table.clientId),
    vendorIdIdx: index("orders_vendor_id_idx").on(table.vendorId),
  })
);
```

**2. Generate migration:**

```bash
pnpm drizzle-kit generate:pg
```

This creates a migration file in `drizzle/` directory.

**3. Review migration:**

Check the generated SQL to ensure indexes are correct:

```bash
cat drizzle/[timestamp]_add_indexes.sql
```

Should contain:

```sql
CREATE INDEX "orders_client_id_idx" ON "orders" ("client_id");
CREATE INDEX "orders_vendor_id_idx" ON "orders" ("vendor_id");
```

**4. Apply migration (if you have database access):**

```bash
pnpm drizzle-kit push:pg
```

**Note:** If you don't have database access, document the migration for manual application.

### Phase 3: Testing (1 hour)

**1. Run all tests:**

```bash
pnpm test
```

**2. Check TypeScript:**

```bash
pnpm check
```

**3. Verify no regressions:**

All existing tests should pass. If any fail, investigate and fix.

### Phase 4: Benchmarking (1 hour)

**1. Create benchmark script:**

```typescript
// scripts/benchmark-indexes.ts
import { db } from "../server/db";
import { orders, clients } from "../server/db/schema";
import { eq } from "drizzle-orm";

async function benchmark() {
  console.time("Query with index");
  const result = await db
    .select()
    .from(orders)
    .leftJoin(clients, eq(orders.clientId, clients.id))
    .limit(1000);
  console.timeEnd("Query with index");

  console.log(`Returned ${result.length} rows`);
}

benchmark();
```

**2. Run benchmark:**

```bash
tsx scripts/benchmark-indexes.ts
```

**3. Document results:**

Add to `docs/ST-005-INDEX-AUDIT.md`:

```markdown
## Performance Results

### Before Indexes

- Query time: [X]ms
- Rows returned: 1000

### After Indexes

- Query time: [Y]ms
- Rows returned: 1000
- **Improvement:** [X-Y]ms ([percentage]% faster)
```

---

## ‚úÖ Completion Checklist

Before marking complete:

- [ ] All foreign keys audited
- [ ] All missing indexes added to schema files
- [ ] Migration generated and reviewed
- [ ] All tests passing (`pnpm test`)
- [ ] Zero TypeScript errors (`pnpm check`)
- [ ] Benchmark results documented
- [ ] Session file updated with final status
- [ ] Session file moved to `docs/sessions/completed/`
- [ ] MASTER_ROADMAP.md updated (ST-005 marked complete)
- [ ] All changes committed with clear messages
- [ ] Branch pushed to GitHub
- [ ] Ready for merge to main

---

## üîÑ 4-Phase Workflow

### Phase 1: Pre-Flight Check ‚úÖ

- [x] Reviewed MASTER_ROADMAP.md
- [x] Checked ACTIVE_SESSIONS.md (no conflicts)
- [x] Understood task requirements

### Phase 2: Session Startup

- [ ] Created session file
- [ ] Created feature branch
- [ ] Updated ACTIVE_SESSIONS.md
- [ ] Updated MASTER_ROADMAP (marked in progress)

### Phase 3: Development

- [ ] Implemented all changes (TDD where applicable)
- [ ] All tests passing
- [ ] Code quality checks passing
- [ ] Frequent commits to GitHub

### Phase 4: Completion & Push

- [ ] All deliverables complete
- [ ] Session file archived
- [ ] MASTER_ROADMAP updated (marked complete)
- [ ] Pushed to main
- [ ] Verified deployment

---

## üìö Resources

- **Drizzle ORM Indexes:** https://orm.drizzle.team/docs/indexes-constraints
- **PostgreSQL Index Types:** https://www.postgresql.org/docs/current/indexes-types.html
- **Schema Files:** `server/db/schema/*.ts`
- **Migration Files:** `drizzle/*.sql`

---

## ‚ö†Ô∏è Important Notes

1. **Don't skip the audit** - Document all missing indexes before adding them
2. **Test thoroughly** - Indexes can affect query plans
3. **Benchmark** - Measure actual performance improvement
4. **Commit frequently** - Push to GitHub every 30 minutes
5. **Follow protocols** - See `.claude/AGENT_ONBOARDING.md`

---

**Ready to start? Follow Phase 2: Session Startup above!**
