# DI-011: Add Fiscal Period Lock Validation

## Problem

`getFiscalPeriodId` at `server/_core/fiscalPeriod.ts:14-38` returns period ID without checking if the period is locked/closed. Ledger entries can be posted to closed fiscal periods, corrupting financial statements.

## Implementation Guide

### Step 1: Add Lock Check Function

```typescript
export async function isPostingAllowed(periodId: number): Promise<boolean> {
  const db = await getDb();
  if (!db) return false;

  const [period] = await db
    .select({ status: fiscalPeriods.status, isLocked: fiscalPeriods.isLocked })
    .from(fiscalPeriods)
    .where(eq(fiscalPeriods.id, periodId));

  if (!period) return false;
  return period.status === "OPEN" && !period.isLocked;
}
```

### Step 2: Update getFiscalPeriodId

```typescript
export async function getFiscalPeriodId(
  date: Date,
  requireOpen: boolean = true
): Promise<number> {
  const db = await getDb();
  const dateStr = date.toISOString().split("T")[0];

  const period = await db.query.fiscalPeriods.findFirst({
    where: and(
      lte(fiscalPeriods.startDate, sql`${dateStr}`),
      gte(fiscalPeriods.endDate, sql`${dateStr}`)
    ),
  });

  if (!period) throw new Error(`No fiscal period found for date ${dateStr}`);

  if (requireOpen && (period.status !== "OPEN" || period.isLocked)) {
    throw new Error(
      `Fiscal period ${period.name} is ${period.status}. Cannot post entries.`
    );
  }

  return period.id;
}
```

### Step 3: Update Ledger Posting

```typescript
// In accountingHooks.ts or wherever ledger entries are created
const periodId = await getFiscalPeriodId(entryDate, true); // true = require open
```

## Acceptance Criteria

- [ ] getFiscalPeriodId checks period status
- [ ] Closed periods reject posting attempts
- [ ] Locked periods reject posting attempts
- [ ] Error messages indicate period status
- [ ] All ledger posting code updated

## Files to Modify

- `server/_core/fiscalPeriod.ts`
- `server/accountingHooks.ts`
- `server/routers/accounting.ts`
