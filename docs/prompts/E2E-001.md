# E2E-001: Fix Authentication Test Credentials for E2E Testing

<!-- METADATA (for validation) -->
<!-- TASK_ID: E2E-001 -->
<!-- TASK_TITLE: Fix Authentication Test Credentials for E2E Testing -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-16 -->

**Repository:** https://github.com/EvanTenenbaum/TERP  
**Task ID:** E2E-001  
**Estimated Time:** 8h  
**Module:** `tests-e2e/fixtures/auth.ts`, `server/routers/auth.ts`

‚ö†Ô∏è **SECURITY WARNING**

- NEVER include real secrets in this prompt
- Use placeholders like: `YOUR_API_KEY_HERE`
- Secrets belong in `.env` file only

---

## üìã Table of Contents

1. [Context](#context)
2. [Phase 1: Pre-Flight Check](#phase-1-pre-flight-check)
3. [Phase 2: Session Startup](#phase-2-session-startup)
4. [Phase 3: Development](#phase-3-development)
5. [Phase 4: Completion](#phase-4-completion)
6. [Quick Reference](#quick-reference)
7. [Troubleshooting](#troubleshooting)

---

## üéØ Context

**Background:**
E2E tests in `tests-e2e/auth.spec.ts` and other test files use hardcoded test credentials (`admin@terp.test` / `admin123`) that do not work against the production environment. The production app uses OAuth/OpenID authentication (stored in `loginMethod` column), not password-based auth. This prevents automated E2E testing against production.

**Goal:**
Enable E2E tests to authenticate successfully against the production environment by either:

1. Creating password-based test accounts that work in production
2. Implementing a test-specific OAuth bypass for E2E testing
3. Using the existing QA Auth system (`/api/qa-auth/login`) for E2E tests

**Success Criteria:**

- E2E tests can successfully authenticate against production
- Login test in `tests-e2e/auth.spec.ts` passes (currently fails with "Login did not redirect")
- All 10 auth tests pass when run against production
- No security vulnerabilities introduced

---

## Implementation Guide

### Step 1: Analyze Current Auth System

1. Review `server/routers/auth.ts` for authentication flow
2. Check `server/_core/authProvider.ts` for OAuth implementation
3. Review QA Auth system at `docs/auth/QA_AUTH.md`
4. Examine `tests-e2e/fixtures/auth.ts` for current test credentials

### Step 2: Implement E2E Auth Solution

**Option A: Use QA Auth System (Recommended)**

1. Update `tests-e2e/fixtures/auth.ts` to use QA Auth endpoints:

   ```typescript
   export async function loginAsAdmin(page: Page): Promise<void> {
     // Use QA Auth API instead of form login
     await page.goto("/login");
     // Call /api/qa-auth/login with role parameter
   }
   ```

2. Ensure `QA_AUTH_ENABLED=true` is set in production for testing

**Option B: Create Password-Based Test Accounts**

1. Add password hash column for test accounts in users table
2. Create migration to add test accounts with known passwords
3. Update auth router to support password login for test accounts

### Step 3: Update E2E Test Fixtures

1. Modify `tests-e2e/fixtures/auth.ts`:
   - Add QA Auth login helper
   - Support environment variable overrides
   - Add retry logic for auth failures

2. Update all test files using `loginAsAdmin`:
   - `tests-e2e/auth.spec.ts`
   - `tests-e2e/critical-paths/*.spec.ts`
   - Other files importing from auth fixtures

### Step 4: Validation

1. Run auth tests against production:

   ```bash
   PLAYWRIGHT_BASE_URL=https://terp-app-b9s35.ondigitalocean.app \
   pnpm exec playwright test tests-e2e/auth.spec.ts
   ```

2. Verify all 10 auth tests pass
3. Run full E2E suite to ensure no regressions

---

## Phase 1: Pre-Flight Check

**Objective:** Verify environment and check for conflicts BEFORE starting work.

### Step 1.1: Register Your Session

1. Create session file: `docs/sessions/active/Session-[DATE]-[NUMBER].md`
2. Use template: `docs/templates/SESSION_TEMPLATE.md`
3. Fill in your session details.

### Step 1.2: Verify Environment

```bash
node --version
pnpm --version
git status
pnpm exec playwright --version
```

---

## Phase 2: Session Startup

**Objective:** Set up your workspace and update the roadmap.

### Step 2.1: Create Feature Branch

```bash
git checkout main
git pull origin main
git checkout -b E2E-001-fix-auth-credentials
```

### Step 2.2: Update Roadmap Status

Change E2E-001 status to `in-progress` in `docs/roadmaps/MASTER_ROADMAP.md`.

---

## Phase 3: Development

Follow the Implementation Guide above.

---

## Phase 4: Completion

### Step 4.1: Verify All Deliverables

- [ ] Auth fixtures updated to work with production
- [ ] All 10 auth tests pass against production
- [ ] No security vulnerabilities introduced
- [ ] Documentation updated
- [ ] Tests added for new auth flow

### Step 4.2: Push and Create PR

```bash
git add .
git commit -m "feat(e2e): Fix authentication test credentials for production testing"
git push origin E2E-001-fix-auth-credentials
```

---

## ‚ö° Quick Reference

| File                         | Purpose               |
| ---------------------------- | --------------------- |
| `tests-e2e/fixtures/auth.ts` | Auth test fixtures    |
| `server/routers/auth.ts`     | Auth router           |
| `docs/auth/QA_AUTH.md`       | QA Auth documentation |
| `tests-e2e/auth.spec.ts`     | Auth E2E tests        |

---

## üÜò Troubleshooting

**Issue:** Login redirects to OAuth provider
**Solution:** Use QA Auth system which bypasses OAuth

**Issue:** QA Auth not enabled in production
**Solution:** Set `QA_AUTH_ENABLED=true` in production environment
