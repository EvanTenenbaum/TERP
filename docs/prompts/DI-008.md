# DI-008: Fix SSE Event Listener Memory Leaks

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-008 -->
<!-- TASK_TITLE: Fix SSE Event Listener Memory Leaks -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-008
**Estimated Time:** 4h
**Module:** Multiple frontend files

## Context

**Background:**
Several files have SSE (Server-Sent Events) event listeners that are not properly cleaned up:
- `WarehousePickList.tsx`
- `LiveShoppingSession.tsx`
- `useLiveSessionSSE.ts`
- `useLiveSessionClient.ts`

This causes:
- Memory exhaustion over time
- Infinite loops when components remount
- Browser tab crashes

**Goal:**
Implement proper cleanup for all SSE event listeners.

**Success Criteria:**
- All EventSource connections are closed on cleanup
- All event listeners are removed on cleanup
- No memory leaks on component unmount

## Implementation Guide

### Step 1: Identify Problematic Patterns

Look for:
```typescript
// BAD: No cleanup
useEffect(() => {
  const eventSource = new EventSource(url);
  eventSource.onmessage = (e) => { ... };
  // Missing cleanup!
}, []);
```

### Step 2: Implement Proper Cleanup

```typescript
// GOOD: With cleanup
useEffect(() => {
  const eventSource = new EventSource(url);

  const handleMessage = (e: MessageEvent) => {
    // Handle message
  };

  const handleError = (e: Event) => {
    // Handle error
  };

  eventSource.addEventListener('message', handleMessage);
  eventSource.addEventListener('error', handleError);

  return () => {
    eventSource.removeEventListener('message', handleMessage);
    eventSource.removeEventListener('error', handleError);
    eventSource.close();
  };
}, [url]);
```

### Step 3: Fix WarehousePickList.tsx

Find SSE setup and add cleanup:
```typescript
useEffect(() => {
  const eventSource = new EventSource(`/api/sse/picklist`);

  // ... event handlers

  return () => {
    eventSource.close();
  };
}, []);
```

### Step 4: Fix LiveShoppingSession.tsx

Similar cleanup pattern for live shopping SSE.

### Step 5: Fix useLiveSessionSSE.ts Hook

```typescript
export function useLiveSessionSSE(sessionId: string) {
  const [data, setData] = useState(null);

  useEffect(() => {
    const eventSource = new EventSource(`/api/sse/session/${sessionId}`);

    eventSource.onmessage = (e) => {
      setData(JSON.parse(e.data));
    };

    eventSource.onerror = () => {
      eventSource.close();
    };

    return () => {
      eventSource.close();
    };
  }, [sessionId]);

  return data;
}
```

### Step 6: Fix useLiveSessionClient.ts

Ensure WebSocket/SSE connections are properly closed.

### Step 7: Add Connection State Management

Track connection state to prevent reconnection storms:
```typescript
const [isConnected, setIsConnected] = useState(false);
const reconnectAttempts = useRef(0);
const maxReconnects = 5;
```

## Deliverables

- [ ] Fix `WarehousePickList.tsx` SSE cleanup
- [ ] Fix `LiveShoppingSession.tsx` SSE cleanup
- [ ] Fix `useLiveSessionSSE.ts` cleanup
- [ ] Fix `useLiveSessionClient.ts` cleanup
- [ ] Add connection state tracking
- [ ] Add tests for cleanup behavior

## Quick Reference

**Files to modify:**
- `client/src/components/warehouse/WarehousePickList.tsx`
- `client/src/pages/LiveShoppingSession.tsx`
- `client/src/hooks/useLiveSessionSSE.ts`
- `client/src/hooks/useLiveSessionClient.ts`

**Find all SSE usages:**
```bash
grep -rn "EventSource\|eventsource" client/src/ --include="*.tsx" --include="*.ts"
```
