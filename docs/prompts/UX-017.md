# UX-017: Fix Broken Delete Subcategory Button Handler

<!-- METADATA (for validation) -->
<!-- TASK_ID: UX-017 -->
<!-- TASK_TITLE: Fix Broken Delete Subcategory Button Handler -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** UX-017
**Estimated Time:** 1h
**Module:** `client/src/pages/Settings.tsx`

## Context

**Background:**
At `Settings.tsx:687-689`, there's a delete button for subcategories that has no onClick handler. Users click the button and nothing happens.

**Goal:**
Implement the delete functionality for subcategories.

**Success Criteria:**
- Delete button works
- Subcategory is removed from database
- UI updates after deletion
- Confirmation dialog shown (see UX-015)

## Implementation Guide

### Step 1: Locate the Broken Button

Find the button at approximately line 687-689:
```tsx
// Current (broken)
<Button variant="destructive" size="sm">
  Delete
</Button>
```

### Step 2: Find Delete Mutation

Look for existing subcategory mutations:
```bash
grep -rn "subcategor" client/src/ --include="*.tsx" | grep -i "delete\|remove"
```

If no delete mutation exists, check the API:
```bash
grep -rn "subcategor" server/routers/ --include="*.ts"
```

### Step 3: Add Delete Mutation (if needed)

```typescript
// server/routers/settings.ts or similar
deleteSubcategory: protectedProcedure
  .input(z.object({ id: z.number() }))
  .mutation(async ({ input }) => {
    const db = await getDb();

    // Check for usage before deleting
    const usage = await db.select()
      .from(products)
      .where(eq(products.subcategoryId, input.id))
      .limit(1);

    if (usage.length > 0) {
      throw new TRPCError({
        code: "PRECONDITION_FAILED",
        message: "Cannot delete subcategory that has products"
      });
    }

    await db.delete(subcategories)
      .where(eq(subcategories.id, input.id));

    return { success: true };
  })
```

### Step 4: Fix the Button

```tsx
// Fixed version with confirmation
const [deleteSubcategoryId, setDeleteSubcategoryId] = useState<number | null>(null);
const deleteSubcategory = trpc.settings.deleteSubcategory.useMutation({
  onSuccess: () => {
    toast({ title: "Deleted", description: "Subcategory deleted successfully" });
    refetchSubcategories();
  },
  onError: (error) => {
    toast({
      variant: "destructive",
      title: "Cannot Delete",
      description: error.message
    });
  }
});

// In the render
<Button
  variant="destructive"
  size="sm"
  onClick={() => setDeleteSubcategoryId(subcategory.id)}
>
  Delete
</Button>

<ConfirmDialog
  open={deleteSubcategoryId !== null}
  onOpenChange={(open) => !open && setDeleteSubcategoryId(null)}
  title="Delete Subcategory"
  description="Are you sure you want to delete this subcategory? Products using this subcategory may be affected."
  onConfirm={() => {
    if (deleteSubcategoryId) {
      deleteSubcategory.mutate({ id: deleteSubcategoryId });
    }
    setDeleteSubcategoryId(null);
  }}
/>
```

### Step 5: Test

1. Navigate to Settings page
2. Find subcategories section
3. Click delete on a subcategory without products - should succeed
4. Click delete on a subcategory with products - should show error
5. Verify UI updates after successful deletion

## Deliverables

- [ ] Add onClick handler to delete button
- [ ] Create delete mutation if missing
- [ ] Add confirmation dialog
- [ ] Handle delete errors gracefully
- [ ] Add check for subcategory usage before delete

## Quick Reference

**File to modify:** `client/src/pages/Settings.tsx:687-689`

**Find the exact location:**
```bash
grep -n "Delete" client/src/pages/Settings.tsx | grep -i subcategor
```

**Related API:**
- Check `server/routers/settings.ts` or `server/routers/inventory.ts`
