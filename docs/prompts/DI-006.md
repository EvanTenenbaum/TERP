# DI-006: Add Missing Foreign Key Constraints

<!-- METADATA (for validation) -->
<!-- TASK_ID: DI-006 -->
<!-- TASK_TITLE: Add Missing Foreign Key Constraints -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** DI-006
**Estimated Time:** 8h
**Module:** `server/schema/*.ts`

## Context

**Background:**
Several tables have columns that reference other tables but lack foreign key constraints:
- `clientInterestLists.reviewedBy` - should reference `users.id`
- `clientWantMatches.convertedToOrderId` - should reference `orders.id`
- `clientWantMatches.convertedBy` - should reference `users.id`
- `salesSheetHistory.reviewedBy` - should reference `users.id`

This allows:
- Orphaned records
- Referential integrity violations
- Data corruption

**Goal:**
Add foreign key constraints to maintain data integrity.

**Success Criteria:**
- All reference columns have FK constraints
- Appropriate ON DELETE behavior
- No orphaned records in existing data

## Implementation Guide

### Step 1: Audit Missing Foreign Keys

Find all columns that look like foreign keys but lack constraints:
```bash
grep -rn "Id:" server/schema/ --include="*.ts" | grep -v "references"
```

### Step 2: Update Schema Definitions

**Example for clientInterestLists:**
```typescript
// server/schema/clientInterestLists.ts
export const clientInterestLists = sqliteTable("client_interest_lists", {
  // ... existing columns
  reviewedBy: integer("reviewed_by").references(() => users.id, {
    onDelete: "set null"
  }),
});
```

### Step 3: Choose ON DELETE Behavior

For each FK, decide:
- `cascade` - Delete child when parent deleted (use sparingly)
- `set null` - Set to null when parent deleted (good for optional refs)
- `restrict` - Prevent parent deletion (good for required refs)
- `no action` - Like restrict but deferred

### Step 4: Create Migration

```sql
-- For existing data, first clean orphans
DELETE FROM client_interest_lists
WHERE reviewed_by NOT IN (SELECT id FROM users);

-- Then add constraint
ALTER TABLE client_interest_lists
ADD CONSTRAINT fk_reviewed_by
FOREIGN KEY (reviewed_by) REFERENCES users(id)
ON DELETE SET NULL;
```

### Step 5: Clean Existing Orphaned Data

Before adding constraints, find and fix orphaned records:
```sql
-- Find orphans
SELECT * FROM client_interest_lists cil
WHERE cil.reviewed_by IS NOT NULL
AND cil.reviewed_by NOT IN (SELECT id FROM users);

-- Fix by nullifying
UPDATE client_interest_lists
SET reviewed_by = NULL
WHERE reviewed_by NOT IN (SELECT id FROM users);
```

## Deliverables

- [ ] Audit all tables for missing FK constraints
- [ ] Update schema definitions with references()
- [ ] Create migration for each FK
- [ ] Clean orphaned data before migration
- [ ] Test FK behavior (insert, update, delete)
- [ ] Document FK relationships

## Quick Reference

**Tables to update:**
- `clientInterestLists` - `reviewedBy`
- `clientWantMatches` - `convertedToOrderId`, `convertedBy`
- `salesSheetHistory` - `reviewedBy`

**Find potential FKs:**
```bash
grep -rn "integer.*Id" server/schema/ --include="*.ts"
```
