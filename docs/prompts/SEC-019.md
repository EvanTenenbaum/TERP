# SEC-019: Protect 12 matchingEnhanced Public Endpoints

<!-- METADATA (for validation) -->
<!-- TASK_ID: SEC-019 -->
<!-- TASK_TITLE: Protect 12 matchingEnhanced Public Endpoints -->
<!-- PROMPT_VERSION: 1.0 -->
<!-- LAST_VALIDATED: 2026-01-14 -->

**Repository:** https://github.com/EvanTenenbaum/TERP
**Task ID:** SEC-019
**Estimated Time:** 4h
**Module:** `server/routers/matchingEnhanced.ts`

## Context

**Background:**
The matching enhanced router exposes 12 endpoints using `publicProcedure` that should be protected. These endpoints expose sensitive client data, purchase history, and matching algorithms without authentication.

**Affected Endpoints:**
1. `findMatchesForNeed`
2. `findMatchesForBatch`
3. `analyzeClientPurchaseHistory`
4. `identifyLapsedBuyers`
5. `getAllActiveNeedsWithMatches`
6. `getPredictiveReorderOpportunities`
7. `findBuyersForInventory`
8. `findHistoricalBuyers`
9. `findProductsByStrain`
10. `groupProductsBySubcategory`
11. `findSimilarStrains`
12. `findMatchesForVendorSupply`

**Goal:**
Change all 12 endpoints from `publicProcedure` to `protectedProcedure`.

**Success Criteria:**
- All endpoints require authentication
- Existing functionality preserved for authenticated users
- Appropriate RBAC permissions applied

## Implementation Guide

### Step 1: Identify All Public Procedures

Search and list all `publicProcedure` usages in the file.

### Step 2: Update Each Endpoint

For each endpoint, change from:
```typescript
findMatchesForNeed: publicProcedure
  .input(...)
  .query(...)
```

To:
```typescript
findMatchesForNeed: protectedProcedure
  .input(...)
  .query(...)
```

### Step 3: Add Permission Checks (if needed)

Consider adding specific permission requirements:
```typescript
findMatchesForNeed: protectedProcedure
  .use(requirePermission('matching:read'))
  .input(...)
  .query(...)
```

### Step 4: Update Tests

Update any tests that call these endpoints to include authentication.

### Step 5: Verify Frontend Calls

Ensure all frontend calls to these endpoints include authentication tokens.

## Deliverables

- [ ] Change all 12 endpoints from `publicProcedure` to `protectedProcedure`
- [ ] Add appropriate permission middleware where needed
- [ ] Update related tests to use authenticated requests
- [ ] Verify frontend integrations still work
- [ ] Document any permission changes

## Quick Reference

**File to modify:** `server/routers/matchingEnhanced.ts`

**Validation command:**
```bash
grep -c "publicProcedure" server/routers/matchingEnhanced.ts
# Should return 0 after fix
```

**Related files:**
- Frontend components using these endpoints
- Test files for matching functionality
