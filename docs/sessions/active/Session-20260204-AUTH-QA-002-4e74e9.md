# Session: AUTH-QA-002 - Demo Mode with Auto-Login and Role Simplification

**Status**: In Progress
**Started**: 2026-02-04
**Agent**: Claude Opus 4.5
**Mode**: RED (auth changes)
**Branch**: claude/refactor-login-roles-qlrDH

## Task Description

Simplify login system with:

1. Simple login schema with one working login per role type
2. Master admin login with full access to everything
3. Auto-login as master admin for all visitors (no manual login required)

## Checklist

- [x] QA current auth flow - trace all entry points
- [x] Identify redundant/conflicting code to remove
- [x] Design minimal demo mode implementation
- [x] Add AUTH-QA-002 task to roadmap
- [ ] Add `DEMO_MODE` to env.ts
- [ ] Modify context.ts for auto-login when DEMO_MODE=true
- [ ] Enable QA auth endpoints when DEMO_MODE=true
- [ ] Update login page to show role switcher in demo mode
- [ ] Remove FORCE_QA_AUTH from qaAuth.ts
- [ ] Update .env.example documentation
- [ ] Run verification (pnpm check, lint, test, build)
- [ ] Verify all 7 role logins work
- [ ] Update roadmap to complete

## Progress Notes

### QA Findings (Pre-Implementation)

**Current Problems:**

1. QA_AUTH is blocked in production (`NODE_ENV=production` returns false in `isQaAuthEnabled()`)
2. FORCE_QA_AUTH exists but is dangerous - bypasses safety checks
3. Public demo user is READ-ONLY - can't mutate, doesn't help for admin access
4. Duplicate code - public user provisioning in 2 places
5. No auto-login mechanism

**Solution Design:**

- Add `DEMO_MODE=true` env var that:
  - Auto-authenticates visitors as Super Admin
  - Enables role switcher (so users can test other roles)
  - Works in production `NODE_ENV` (explicit demo flag)
  - Removes need for `FORCE_QA_AUTH` hack

**Files to Modify:**

1. `server/_core/env.ts` - Add DEMO_MODE
2. `server/_core/qaAuth.ts` - Enable QA auth when DEMO_MODE=true, REMOVE FORCE_QA_AUTH
3. `server/_core/context.ts` - Auto-login as admin when DEMO_MODE=true
4. `server/_core/simpleAuth.ts` - Add ensureDemoAdminExists() helper
5. `client/src/components/qa/QaRoleSwitcher.tsx` - Check demo mode status
6. `.env.example` - Document DEMO_MODE

## Verification Mode

**RED Mode** - Auth changes require:

- Explicit user approval before execution âœ“ (user approved)
- Create rollback plan before starting
- Verify in staging/test before production
- Document every step taken

## Rollback Plan

If implementation fails:

1. Revert all changes: `git checkout -- server/ client/ .env.example`
2. Remove session file
3. Update roadmap status back to ready
