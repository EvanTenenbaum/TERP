# TERP Calendar Codebase Analysis
**Current State Assessment for v3.2 Evolution**

---

## üìã Document Info

- **Date**: 2025-11-10
- **Purpose**: Analyze existing TERP calendar implementation to plan v3.2 evolution
- **Scope**: Schema, APIs, routers, tests, integration points

---

## üéØ Executive Summary

**Current State**: TERP has a **production-ready v2.0 calendar** (Post-Adversarial QA) with:
- ‚úÖ Complete database schema (9 tables)
- ‚úÖ Working routers with RBAC
- ‚úÖ Tests following TERP Bible protocols
- ‚úÖ N+1 query fixes already implemented
- ‚úÖ Timezone handling with Luxon
- ‚úÖ Pagination support

**Gap Analysis**: v2.0 ‚Üí v3.2 requires:
- ‚ùå Add `client_id` and `vendor_id` columns (currently uses polymorphic entityType/entityId)
- ‚ùå Add `metadata` JSON column for v3.1 metadata system
- ‚ùå Add event types: AR_COLLECTION, AP_PAYMENT (currently has PAYMENT_DUE)
- ‚ùå Add financial workflows (AR payment, AP payment)
- ‚ùå Add operations workflows (order creation, batch linking)
- ‚ùå Add client integration APIs (quick book, appointment history)
- ‚ùå Add monitoring and health checks

---

## üìä Current Implementation (v2.0)

### Database Schema

#### calendarEvents Table
**Location**: `drizzle/schema.ts` (lines 3710-3815)

**Existing Columns**:
```typescript
- id: int (PK, auto-increment)
- title: varchar(255)
- description: text
- location: varchar(500)
- startDate: date
- endDate: date
- startTime: varchar(8) // HH:MM:SS
- endTime: varchar(8) // HH:MM:SS
- timezone: varchar(50) // ‚úÖ Already exists!
- isFloatingTime: boolean
- module: enum (INVENTORY, ACCOUNTING, CLIENTS, VENDORS, ORDERS, SAMPLES, COMPLIANCE, GENERAL)
- eventType: enum (MEETING, DEADLINE, TASK, DELIVERY, PAYMENT_DUE, FOLLOW_UP, AUDIT, INTAKE, PHOTOGRAPHY, BATCH_EXPIRATION, RECURRING_ORDER, SAMPLE_REQUEST, OTHER)
- status: enum (SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED)
- priority: enum (LOW, MEDIUM, HIGH, URGENT)
- isRecurring: boolean
- entityType: varchar(50) // Polymorphic (e.g., "order", "invoice", "client")
- entityId: int // Polymorphic
- createdBy: int (FK to users)
- assignedTo: int (FK to users)
- visibility: enum (PRIVATE, TEAM, COMPANY, PUBLIC)
- isAutoGenerated: boolean
- autoGenerationRule: varchar(100)
- createdAt: timestamp
- updatedAt: timestamp
- deletedAt: timestamp // Soft delete
```

**Existing Indexes**:
- idx_calendar_date_range (startDate, endDate)
- idx_calendar_module (module)
- idx_calendar_entity (entityType, entityId)
- idx_calendar_assigned (assignedTo)
- idx_calendar_status (status)
- idx_calendar_created_by (createdBy)

**Missing for v3.2**:
- ‚ùå client_id column (explicit FK to clients)
- ‚ùå vendor_id column (explicit FK to vendors)
- ‚ùå metadata column (JSON for v3.1 metadata system)
- ‚ùå intake_event_id on orders table
- ‚ùå photo_session_event_id on batches table

---

#### Related Tables (Already Exist)

1. **calendarRecurrenceRules** - Recurrence patterns
2. **calendarRecurrenceInstances** - Pre-generated instances
3. **calendarEventParticipants** - Multi-user events with RSVP
4. **calendarReminders** - Event reminders
5. **calendarEventHistory** - Audit trail
6. **calendarEventAttachments** - File attachments
7. **calendarViews** - User view configurations
8. **calendarEventPermissions** - Granular permissions
9. **clientMeetingHistory** - Meeting history (needs CASCADE fix)

---

### API Layer

#### calendarDb.ts
**Location**: `server/calendarDb.ts`

**Existing Functions**:
- `getEventsByDateRange()` - Query events
- `getEventById()` - Get single event
- `createEvent()` - Create event
- `updateEvent()` - Update event
- `softDeleteEvent()` - Soft delete
- `hardDeleteEvent()` - Hard delete
- Plus functions for all related tables (recurrence, participants, reminders, etc.)

**Missing for v3.2**:
- ‚ùå `getEventsByClient()` - Query by client_id
- ‚ùå `getEventsByVendor()` - Query by vendor_id
- ‚ùå `checkConflicts()` - Conflict detection for quick book
- ‚ùå `getAvailableSlots()` - Available time slots
- ‚ùå Transaction wrappers for multi-step operations

---

#### Routers
**Location**: `server/routers/`

**Existing Routers**:
1. **calendar.ts** - Main CRUD operations
   - `getEvents` (with pagination, N+1 fix already done ‚úÖ)
   - `getEvent`
   - `createEvent`
   - `updateEvent`
   - `deleteEvent`
   - Uses `requirePermission` middleware ‚úÖ
   
2. **calendarFinancials.ts** - Financial integrations
   - Basic structure exists but needs v3.2 workflows
   
3. **calendarMeetings.ts** - Meeting-specific operations
4. **calendarParticipants.ts** - Participant management
5. **calendarRecurrence.ts** - Recurrence handling
6. **calendarReminders.ts** - Reminder management
7. **calendarViews.ts** - View configurations

**Missing for v3.2**:
- ‚ùå AR payment processing workflow
- ‚ùå AP payment processing workflow
- ‚ùå Order creation workflow
- ‚ùå Batch linking workflow
- ‚ùå Client quick book API
- ‚ùå Client appointment history API
- ‚ùå Dashboard widget API
- ‚ùå VIP portal booking API

---

### Testing

#### Existing Tests
**Location**: `server/routers/`

1. **calendar.test.ts**
   - Tests N+1 query fix (batch permission checking) ‚úÖ
   - Follows TERP Bible protocols ‚úÖ
   - Uses vi.mock() for dependencies ‚úÖ
   
2. **calendar.pagination.test.ts**
   - Tests pagination ‚úÖ
   
3. **calendarFinancials.test.ts**
   - Basic financial tests ‚úÖ

**Test Coverage**: ~30 tests exist

**Missing for v3.2**: 170 more tests needed to reach 200 total

---

### Services

#### Existing Services
**Location**: `server/_core/`

1. **TimezoneService** - Timezone handling with Luxon ‚úÖ
2. **PermissionService** - RBAC with batch checking ‚úÖ
3. **InstanceGenerationService** - Recurrence instance generation ‚úÖ

**Missing for v3.2**:
- ‚ùå Health check service
- ‚ùå Logging service (Winston)
- ‚ùå Error tracking service (Sentry)

---

## üîÑ v2.0 vs v3.2 Comparison

### Design Philosophy Difference

**v2.0 Approach**: Polymorphic relationships
```typescript
// v2.0: Uses entityType/entityId for flexibility
entityType: "client"
entityId: 123
```

**v3.2 Approach**: Explicit foreign keys
```typescript
// v3.2: Explicit columns for performance
clientId: 123
vendorId: null
```

**Decision**: **Hybrid approach** - Keep both!
- Keep `entityType/entityId` for flexibility (other entities)
- Add `clientId/vendorId` for performance (common queries)
- Add `metadata` JSON for v3.1 metadata system

---

### Event Types Comparison

**v2.0 Event Types**:
- MEETING
- DEADLINE
- TASK
- DELIVERY
- PAYMENT_DUE ‚ö†Ô∏è (generic)
- FOLLOW_UP
- AUDIT
- INTAKE ‚úÖ
- PHOTOGRAPHY ‚úÖ
- BATCH_EXPIRATION
- RECURRING_ORDER
- SAMPLE_REQUEST
- OTHER

**v3.2 Required Event Types**:
- All v2.0 types +
- AR_COLLECTION (specific for customer payments)
- AP_PAYMENT (specific for vendor payments)
- PHOTOS (alias for PHOTOGRAPHY or separate?)

**Decision**: Add AR_COLLECTION and AP_PAYMENT to enum

---

### Query Optimization Status

| Optimization | v2.0 Status | v3.2 Required |
|--------------|-------------|---------------|
| **N+1 Query Fix** | ‚úÖ Done | ‚úÖ Already fixed |
| **Batch Permission Check** | ‚úÖ Done | ‚úÖ Already fixed |
| **JOIN for clients** | ‚ùå N/A (no client_id) | ‚ö†Ô∏è Need after adding client_id |
| **Available Slots O(n)** | ‚ùå Not implemented | ‚ö†Ô∏è Need to implement |
| **Pagination** | ‚úÖ Done | ‚úÖ Already done |

---

## üìã Gap Analysis: v2.0 ‚Üí v3.2

### Critical Gaps (Must Fix)

#### 1. Database Schema Gaps

**Missing Columns**:
```sql
-- Add to calendar_events
ALTER TABLE calendar_events ADD COLUMN client_id INT NULL;
ALTER TABLE calendar_events ADD COLUMN vendor_id INT NULL;
ALTER TABLE calendar_events ADD COLUMN metadata JSON NULL;

-- Add to orders
ALTER TABLE orders ADD COLUMN intake_event_id INT NULL;

-- Add to batches
ALTER TABLE batches ADD COLUMN photo_session_event_id INT NULL;
```

**Missing Event Types**:
```sql
ALTER TABLE calendar_events 
MODIFY COLUMN event_type ENUM(
  'MEETING', 'DEADLINE', 'TASK', 'DELIVERY', 'PAYMENT_DUE',
  'FOLLOW_UP', 'AUDIT', 'INTAKE', 'PHOTOGRAPHY', 'BATCH_EXPIRATION',
  'RECURRING_ORDER', 'SAMPLE_REQUEST', 'OTHER',
  'AR_COLLECTION', 'AP_PAYMENT' -- NEW
) NOT NULL;
```

**Foreign Key Fixes**:
```sql
-- Fix clientMeetingHistory cascade (Fix #3)
ALTER TABLE client_meeting_history
DROP FOREIGN KEY fk_client_meeting_history_event;

ALTER TABLE client_meeting_history
ADD CONSTRAINT fk_client_meeting_history_event
FOREIGN KEY (calendar_event_id) REFERENCES calendar_events(id)
ON DELETE SET NULL; -- Changed from CASCADE
```

---

#### 2. API Gaps

**Missing APIs** (need to add to routers):

**Client Integration**:
- `calendar.quickBookForClient` - Quick book with conflict detection
- `calendar.getClientAppointments` - Appointment history
- `calendar.getDaySchedule` - Day schedule for dashboard

**Financial Integration**:
- `calendar.processPaymentFromAppointment` - AR payment
- `calendar.processVendorPaymentFromAppointment` - AP payment

**Operations Integration**:
- `orders.createFromAppointment` - Create order from INTAKE
- `calendar.linkBatchToPhotoSession` - Link batch to PHOTOS

**VIP Portal**:
- `calendar.getAvailableSlots` - Public API
- `calendar.bookAppointmentExternal` - Public API

---

#### 3. Workflow Gaps

**Missing Workflows**:
1. AR Payment Processing (from AR_COLLECTION events)
2. AP Payment Processing (from AP_PAYMENT events)
3. Order Creation (from INTAKE events)
4. Batch Linking (from PHOTOS events)
5. Client Activity Tracking (log to clientActivity)
6. Meeting History Integration (update clientMeetingHistory)

---

#### 4. Testing Gaps

**Current**: ~30 tests  
**Required**: 200 tests  
**Gap**: 170 tests

**Missing Test Categories**:
- Client integration tests (25 tests)
- Payment integration tests (20 tests)
- Operations integration tests (15 tests)
- VIP portal tests (15 tests)
- Validation tests (15 tests)
- Query tests (15 tests)
- Utility tests (10 tests)
- E2E tests (20 tests)
- Additional router tests (35 tests)

---

#### 5. Monitoring Gaps

**Missing**:
- Health check endpoint (`/api/health/calendar`)
- Winston logger setup
- Sentry error tracking
- Performance monitoring
- Alert configuration
- Automated monitoring script

---

## üó∫Ô∏è Evolution Strategy

### Approach: Hybrid Evolution

**Keep from v2.0**:
- ‚úÖ All existing tables and columns
- ‚úÖ Polymorphic entityType/entityId (for flexibility)
- ‚úÖ Existing routers and tests
- ‚úÖ TimezoneService, PermissionService
- ‚úÖ N+1 query fixes
- ‚úÖ Pagination

**Add for v3.2**:
- ‚ûï client_id and vendor_id columns (explicit FKs)
- ‚ûï metadata JSON column
- ‚ûï AR_COLLECTION and AP_PAYMENT event types
- ‚ûï intake_event_id on orders
- ‚ûï photo_session_event_id on batches
- ‚ûï Financial workflow APIs
- ‚ûï Operations workflow APIs
- ‚ûï Client integration APIs
- ‚ûï VIP portal APIs
- ‚ûï 170 more tests
- ‚ûï Monitoring and logging

**Fix from v2.0**:
- üîß clientMeetingHistory CASCADE ‚Üí SET NULL
- üîß Add conflict detection to quick book
- üîß Add transactions to multi-step operations
- üîß Optimize available slots algorithm

---

## üìä Implementation Phases

### Phase 0: Database Evolution (1 week)

**Tasks
**:
1. Create migration 0031: Add client_id, vendor_id, metadata columns
2. Create migration 0032: Fix clientMeetingHistory CASCADE
3. Create migration 0033: Add event types AR_COLLECTION, AP_PAYMENT
4. Create migration 0034: Add intake_event_id to orders
5. Create migration 0035: Add photo_session_event_id to batches
6. Update schema.ts with all changes
7. Run migrations on dev database
8. Verify with test queries

**Deliverables**:
- 5 migration files
- Updated schema.ts
- Migration verification report

---

### Phase 1: Core API Evolution (2-3 weeks)

**Tasks**:
1. Update calendarDb.ts with new query functions
   - `getEventsByClient(clientId)`
   - `getEventsByVendor(vendorId)`
   - `checkConflicts(startDate, startTime, endDate, endTime, excludeEventId?)`
   - Add transactions to createEvent, updateEvent
2. Update calendar.ts router
   - Add conflict detection to createEvent
   - Add metadata support
3. Write tests for new functions (TDD)
   - 30 integration tests
   - 15 unit tests

**Deliverables**:
- Updated calendarDb.ts
- Updated calendar.ts router
- 45 new tests passing

---

### Phase 2: Client Integration (1-2 weeks)

**Tasks**:
1. Create client integration APIs in calendar.ts
   - `quickBookForClient` - With conflict detection
   - `getClientAppointments` - Appointment history
   - `getDaySchedule` - Day schedule widget
2. Update clientActivity tracking
3. Update clientMeetingHistory integration
4. Write tests (TDD)
   - 25 integration tests
   - 2 E2E tests

**Deliverables**:
- Client integration APIs working
- 27 new tests passing

---

### Phase 3: Financial Workflows (2 weeks)

**Tasks**:
1. Update calendarFinancials.ts router
   - `processPaymentFromAppointment` (AR)
   - `processVendorPaymentFromAppointment` (AP)
2. Add transaction support
3. Add payment validation
4. Link payments to events
5. Update invoice/PO status
6. Write tests (TDD)
   - 20 integration tests
   - 2 E2E tests

**Deliverables**:
- AR/AP payment workflows working
- 22 new tests passing

---

### Phase 4: Operations Workflows (1-2 weeks)

**Tasks**:
1. Create operations APIs
   - `orders.createFromAppointment` (INTAKE)
   - `calendar.linkBatchToPhotoSession` (PHOTOS)
2. Add duplicate order detection
3. Add transaction support
4. Write tests (TDD)
   - 15 integration tests
   - 2 E2E tests

**Deliverables**:
- Operations workflows working
- 17 new tests passing

---

### Phase 5: VIP Portal (1 week)

**Tasks**:
1. Create VIP portal APIs
   - `getAvailableSlots` (optimized O(n) algorithm)
   - `bookAppointmentExternal`
2. Make APIs publicly accessible
3. Add email confirmation
4. Write tests (TDD)
   - 15 integration tests
   - 4 E2E tests

**Deliverables**:
- VIP portal working
- 19 new tests passing

---

### Phase 6: Monitoring & Polish (1 week)

**Tasks**:
1. Add health check endpoint
2. Set up Winston logger
3. Set up Sentry error tracking
4. Add performance monitoring
5. Create monitoring script
6. Write remaining tests
   - 15 validation tests
   - 15 query tests
   - 10 utility tests
   - 6 E2E tests

**Deliverables**:
- Monitoring complete
- 46 new tests passing
- Total: 200 tests ‚úÖ

---

## üìã Migration Plan

### Migration 0031: Add Core v3.2 Columns

```sql
-- Add client_id column
ALTER TABLE calendar_events
ADD COLUMN client_id INT NULL
AFTER entity_id;

-- Add vendor_id column
ALTER TABLE calendar_events
ADD COLUMN vendor_id INT NULL
AFTER client_id;

-- Add metadata column
ALTER TABLE calendar_events
ADD COLUMN metadata JSON NULL
AFTER vendor_id;

-- Add foreign key constraints
ALTER TABLE calendar_events
ADD CONSTRAINT fk_calendar_events_client
FOREIGN KEY (client_id) REFERENCES clients(id)
ON DELETE SET NULL;

ALTER TABLE calendar_events
ADD CONSTRAINT fk_calendar_events_vendor
FOREIGN KEY (vendor_id) REFERENCES vendors(id)
ON DELETE SET NULL;

-- Add indexes
CREATE INDEX idx_calendar_events_client_id
ON calendar_events(client_id);

CREATE INDEX idx_calendar_events_vendor_id
ON calendar_events(vendor_id);

-- Backfill client_id from entityType/entityId
UPDATE calendar_events
SET client_id = entity_id
WHERE entity_type = 'client';

-- Backfill vendor_id from entityType/entityId
UPDATE calendar_events
SET vendor_id = entity_id
WHERE entity_type = 'vendor';
```

---

### Migration 0032: Fix Meeting History Cascade

```sql
-- Drop existing foreign key
ALTER TABLE client_meeting_history
DROP FOREIGN KEY fk_client_meeting_history_event;

-- Add new foreign key with SET NULL
ALTER TABLE client_meeting_history
ADD CONSTRAINT fk_client_meeting_history_event
FOREIGN KEY (calendar_event_id) REFERENCES calendar_events(id)
ON DELETE SET NULL;
```

---

### Migration 0033: Add Event Types

```sql
-- Add new event types to enum
ALTER TABLE calendar_events
MODIFY COLUMN event_type ENUM(
  'MEETING',
  'DEADLINE',
  'TASK',
  'DELIVERY',
  'PAYMENT_DUE',
  'FOLLOW_UP',
  'AUDIT',
  'INTAKE',
  'PHOTOGRAPHY',
  'BATCH_EXPIRATION',
  'RECURRING_ORDER',
  'SAMPLE_REQUEST',
  'OTHER',
  'AR_COLLECTION',
  'AP_PAYMENT'
) NOT NULL;
```

---

### Migration 0034: Add intake_event_id to Orders

```sql
-- Add intake_event_id column
ALTER TABLE orders
ADD COLUMN intake_event_id INT NULL
AFTER client_id;

-- Add foreign key constraint
ALTER TABLE orders
ADD CONSTRAINT fk_orders_intake_event
FOREIGN KEY (intake_event_id) REFERENCES calendar_events(id)
ON DELETE SET NULL;

-- Add index
CREATE INDEX idx_orders_intake_event_id
ON orders(intake_event_id);
```

---

### Migration 0035: Add photo_session_event_id to Batches

```sql
-- Add photo_session_event_id column
ALTER TABLE batches
ADD COLUMN photo_session_event_id INT NULL;

-- Add foreign key constraint
ALTER TABLE batches
ADD CONSTRAINT fk_batches_photo_session_event
FOREIGN KEY (photo_session_event_id) REFERENCES calendar_events(id)
ON DELETE SET NULL;

-- Add index
CREATE INDEX idx_batches_photo_session_event_id
ON batches(photo_session_event_id);
```

---

## üß™ Testing Strategy

### Test Distribution (200 Total)

**Existing**: 30 tests ‚úÖ  
**New**: 170 tests

| Category | Tests | Phase |
|----------|-------|-------|
| **Existing calendar router** | 30 | ‚úÖ Done |
| **Core API updates** | 45 | Phase 1 |
| **Client integration** | 27 | Phase 2 |
| **Financial workflows** | 22 | Phase 3 |
| **Operations workflows** | 17 | Phase 4 |
| **VIP portal** | 19 | Phase 5 |
| **Validation/Query/Utility** | 40 | Phase 6 |
| **E2E tests** | 6 | Phase 6 |
| **TOTAL** | **200** | **All Phases** |

### TDD Workflow (TERP Bible)

For every new feature:
1. **Red**: Write failing test first
2. **Green**: Write minimal code to pass
3. **Refactor**: Clean up code
4. **Repeat**: For all functionality

---

## üìä Success Metrics

### Technical Metrics

| Metric | Current (v2.0) | Target (v3.2) |
|--------|----------------|---------------|
| **Test Count** | 30 | 200 ‚úÖ |
| **Test Coverage** | ~60% | 100% ‚úÖ |
| **API Response Time** | ~300ms | < 500ms ‚úÖ |
| **N+1 Queries** | 0 ‚úÖ | 0 ‚úÖ |
| **Event Types** | 13 | 15 ‚úÖ |
| **Integration Points** | 3 | 8 ‚úÖ |

### Business Metrics

| Metric | Current | Target |
|--------|---------|--------|
| **Module Integrations** | 3 | 8 ‚úÖ |
| **Workflows** | 0 | 4 ‚úÖ |
| **Client Features** | 0 | 3 ‚úÖ |
| **VIP Portal** | No | Yes ‚úÖ |
| **Monitoring** | No | Yes ‚úÖ |

---

## üéØ Recommendations

### Immediate Actions

1. **Review this analysis** with team
2. **Approve hybrid approach** (keep v2.0 + add v3.2)
3. **Schedule Phase 0** (database migrations)
4. **Set up dev environment** for testing

### Implementation Approach

**Recommended**: **Incremental Evolution**
- ‚úÖ Less risky than full rewrite
- ‚úÖ Preserves existing functionality
- ‚úÖ Can deploy in phases
- ‚úÖ Easier to test and validate
- ‚úÖ Faster time to production

### Timeline

| Phase | Duration | Cumulative |
|-------|----------|------------|
| Phase 0: Database | 1 week | 1 week |
| Phase 1: Core API | 2-3 weeks | 3-4 weeks |
| Phase 2: Client | 1-2 weeks | 4-6 weeks |
| Phase 3: Financial | 2 weeks | 6-8 weeks |
| Phase 4: Operations | 1-2 weeks | 7-10 weeks |
| Phase 5: VIP Portal | 1 week | 8-11 weeks |
| Phase 6: Monitoring | 1 week | 9-12 weeks |
| **TOTAL** | **9-12 weeks** | **9-12 weeks** |

**Team**: 2 developers  
**Risk**: Low (incremental approach)

---

## üìö Next Steps

1. **Create reformulated implementation plan** based on this analysis
2. **Update v3.2 spec** to reflect hybrid approach
3. **Create detailed Phase 0 tasks** (migrations)
4. **Begin implementation** following TERP Bible protocols

---

**Document Status**: Complete  
**Analysis Type**: Comprehensive codebase review  
**Recommendation**: Proceed with incremental evolution approach
