#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run QA standards check first
.husky/pre-commit-qa-check.sh || exit 1

# Run AI-powered code review (Senior Engineer, Security, Edge Cases)
echo "ğŸ¤– Running AI-powered code review..."
pnpm pre-commit:review || {
  echo "âš ï¸  AI review had issues. Continuing with other checks..."
  # Don't block commit if AI review fails (graceful degradation)
}

# Then run lint-staged
npx lint-staged

# Validate roadmap ONLY if it changed (conditional validation for performance)
if git diff --cached --name-only | grep -q "docs/roadmaps/MASTER_ROADMAP.md"; then
  echo "ğŸ” Validating MASTER_ROADMAP.md..."
  pnpm roadmap validate --incremental || exit 1
fi

# Validate session cleanup
echo "ğŸ” Validating session cleanup..."
pnpm validate:sessions || exit 1
