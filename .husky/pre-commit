#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check for schema changes without migrations
if git diff --cached --name-only | grep -q "drizzle/schema.ts"; then
  if ! git diff --cached --name-only | grep -q "drizzle/migrations/"; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: drizzle/schema.ts changed but no migration file found!"
    echo ""
    echo "   If you modified the database schema, you need to generate a migration:"
    echo "   $ pnpm db:generate"
    echo ""
    echo "   If this is a non-breaking change (comments, types only), you can skip with:"
    echo "   $ git commit --no-verify"
    echo ""
    # Don't block, just warn (some schema changes don't need migrations)
  fi
fi

# Run QA standards check first
.husky/pre-commit-qa-check.sh || exit 1

# Run AI-powered code review (Senior Engineer, Security, Edge Cases)
echo "ü§ñ Running AI-powered code review..."
npm run pre-commit:review 2>/dev/null || {
  echo "‚ö†Ô∏è  AI review had issues. Continuing with other checks..."
  # Don't block commit if AI review fails (graceful degradation)
}

# Then run lint-staged
npx lint-staged

# Validate roadmap ONLY if it changed (conditional validation for performance)
if git diff --cached --name-only | grep -q "docs/roadmaps/MASTER_ROADMAP.md"; then
  echo "üîç Validating MASTER_ROADMAP.md..."
  npm run roadmap:validate || exit 1
fi

# Validate session cleanup
echo "üîç Validating session cleanup..."
npm run validate:sessions 2>/dev/null || {
  echo "‚ö†Ô∏è  Session validation skipped"
}
