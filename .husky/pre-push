#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-push checks..."

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check 1: Verify branch name format
if [[ ! "$CURRENT_BRANCH" =~ ^claude/[A-Z]+-[0-9]+-?[0-9]*-[0-9]{8}-[a-f0-9]{8}$ ]] && [[ "$CURRENT_BRANCH" != "main" ]]; then
  echo "‚ùå PUSH BLOCKED: Invalid branch name format"
  echo "   Current branch: $CURRENT_BRANCH"
  echo "   Expected format: claude/TASK_ID-SESSION_ID"
  echo ""
  echo "   To fix: Use 'pnpm start-task \"TASK_ID\"' to create a proper branch"
  echo "   Or for ad-hoc tasks: 'pnpm start-task --adhoc \"Description\"'"
  exit 1
fi

# Check 2: Prevent direct push to main
if [ "$CURRENT_BRANCH" == "main" ]; then
  echo "‚ùå PUSH BLOCKED: Direct push to main is not allowed"
  echo "   Please create a feature branch and submit a PR"
  echo ""
  echo "   To fix: Use 'pnpm start-task \"TASK_ID\"' to start a new task"
  exit 1
fi

echo "‚úÖ All pre-push checks passed"
exit 0
