#!/usr/bin/env bash
# Pre-push hook for TERP
# Validates branch names and checks for conflicts before push

# Source shared config
. "$(dirname -- "$0")/qa-config.sh"

echo "üîç Running pre-push checks..."

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check 1: Allow direct push to main (per protocol)
# But warn if local is behind remote
if [ "$CURRENT_BRANCH" == "main" ]; then
  # Check if local is behind remote
  git fetch origin main --quiet 2>/dev/null || true
  LOCAL=$(git rev-parse HEAD)
  REMOTE=$(git rev-parse origin/main 2>/dev/null || echo "$LOCAL")
  
  if [ "$LOCAL" != "$REMOTE" ] && git merge-base --is-ancestor "$LOCAL" "$REMOTE" 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: Local main is behind remote main"
    echo "   Consider pulling first: git pull origin main"
    echo "   (Push will proceed, but conflicts may occur)"
    echo ""
  fi
  
  # Allow push to main (non-blocking)
  echo "‚úÖ Pushing to main (deployment will be monitored automatically)"
  exit 0
fi

# Check 2: Verify branch name format (for non-main branches only)
if [[ ! "$CURRENT_BRANCH" =~ $BRANCH_NAME_REGEX ]]; then
  echo "‚ùå PUSH BLOCKED: Invalid branch name format: $CURRENT_BRANCH"
  echo "   Valid formats: <prefix>/<description> (e.g., feature/my-feature, fix/bug-123)"
  echo "   Or flat names: my-branch-name"
  echo "   Or use 'pnpm start-task' to create a branch automatically."
  exit 1
fi

echo "‚úÖ All pre-push checks passed"
exit 0
