Domain,Entity,Flow Name,Archetype,tRPC Procedure,Type,Procedure Wrapper,Permissions,Permission Mode,Roles,UI Entry Paths,Business Purpose,Implementation Status,Known Issues,Router File,Primary Data Inputs,Preconditions,Core Business Rules,State Transitions,Data Writes,Inventory Impact,Financial Impact,Ledger Impact,Audit & Compliance,Notifications & Alerts,External Integrations,Guardrails & Failure Modes,Expected Outputs,Test Assertions,Source-of-Truth Links
Accounting,Invoices,Generate From Order,Create,invoices.generateFromOrder,mutation,protectedProcedure,accounting:create,all,"Super Admin, Accounting Manager",/orders/:id -> Generate Invoice,Generate invoice from completed order,Client-wired,,server/routers/invoices.ts,"{orderId: number}","Order exists; Order type is SALE; Order fulfillmentStatus in [PENDING, PACKED, SHIPPED]; No existing invoice for order; User has accounting:create permission","Only SALE orders can generate invoices; Order must have valid items array; Due date calculated from payment terms (COD=0, NET_7=7, NET_15=15, NET_30=30, PARTIAL=30, CONSIGNMENT=60 days)","Order: PENDING/PACKED/SHIPPED -> (linked to invoice); Invoice: null -> DRAFT","invoices: INSERT new invoice record; invoiceLineItems: INSERT line items from order; orders: UPDATE invoiceId reference",None,"Creates AR entry for total invoice amount; Updates client outstanding balance","Invoice creates receivable entry; Links to client financial record","Audit log: Invoice generated with orderId reference; User actorId recorded",None (future: email notification support),None,"NOT_FOUND if order missing; BAD_REQUEST if not SALE type; BAD_REQUEST if wrong fulfillmentStatus; BAD_REQUEST if invoice already exists; INTERNAL_SERVER_ERROR if items parsing fails","{invoice: {id, invoiceNumber, status: DRAFT, customerId, totalAmount, amountDue, dueDate, referenceType: ORDER, referenceId: orderId}}","Invoice created with DRAFT status; Invoice linked to order; Line items match order items; Due date calculated correctly; Order.invoiceId updated","FLOW_GUIDE.md#1.1 Invoice Status Lifecycle; server/routers/invoices.ts:generateFromOrder"
Accounting,Invoices,Update Status,State Transition,invoices.updateStatus,mutation,protectedProcedure,accounting:update,all,"Super Admin, Accounting Manager",/accounting/invoices/:id,Update invoice status (DRAFT->SENT->PAID etc),Client-wired,,server/routers/invoices.ts,"{id: number, version?: number, status: DRAFT|SENT|VIEWED|PARTIAL|PAID|OVERDUE|VOID, notes?: string}","Invoice exists; Invoice not VOID; If PAID only VOID transition allowed; User has accounting:update permission; Version matches if provided (optimistic locking)","VOID is terminal - no updates allowed; PAID invoices can only transition to VOID; Version check prevents concurrent edit conflicts (ST-026)","DRAFT -> SENT -> VIEWED -> PARTIAL -> PAID; Any non-terminal -> OVERDUE; Any non-terminal -> VOID (terminal)","invoices: UPDATE status, notes, version",None,"Status change affects AR aging buckets; PAID reduces outstanding; VOID cancels receivable",None (status change only; ledger impact on payment recording),"Status change logged via notes field with timestamp; Version incremented for optimistic locking",None,None,"NOT_FOUND if invoice missing; BAD_REQUEST if invoice is VOID; BAD_REQUEST if PAID and target not VOID; CONFLICT if version mismatch (ST-026)","{success: true, invoiceId: number, status: string}","Status updated correctly; Notes appended with status change; Version incremented if provided; Cannot update VOID invoice; PAID only to VOID","FLOW_GUIDE.md#1.1 Invoice Status Lifecycle; server/routers/invoices.ts:updateStatus"
Accounting,Invoices,Mark Sent,State Transition,invoices.markSent,mutation,protectedProcedure,accounting:update,all,"Super Admin, Accounting Manager",/accounting/invoices/:id,Mark invoice as sent to customer,Client-wired,,server/routers/invoices.ts,"{id: number}","Invoice exists; User has accounting:update permission","Simple status update to SENT; No validation of current status (allows re-marking as SENT)","Any status -> SENT","invoices: UPDATE status to SENT",None,"Invoice now in AR aging; Payment tracking begins",None,"Action logged via logger; No explicit audit trail entry",Future: Trigger email/notification to client,None,Database error if invoice not found,"{success: true, invoiceId: number}","Status changed to SENT; Logger records markSent event","FLOW_GUIDE.md#1.1 Invoice Status Lifecycle; server/routers/invoices.ts:markSent"
Accounting,Invoices,Void Invoice,State Transition,invoices.void,mutation,protectedProcedure,accounting:delete,all,"Super Admin, Accounting Manager",/accounting/invoices/:id,Void an invoice (cannot be reversed),Client-wired,,server/routers/invoices.ts,"{id: number, reason: string (min 1 char)}","Invoice exists; Invoice not already VOID; User has accounting:delete permission; Reason must be provided","VOID is terminal and irreversible; Reason is mandatory for audit compliance; Notes field updated with void timestamp and reason","Any non-VOID status -> VOID (terminal)","invoices: UPDATE status to VOID, append void reason to notes",None,"Removes invoice from AR outstanding; Cancels receivable amount; Does NOT reverse any payments already recorded",None (voiding doesn't create reversal entries),"Void reason and timestamp recorded in notes field; Logger records void event with reason",None,None,"NOT_FOUND if invoice missing; BAD_REQUEST if already VOID; Validation error if reason empty","{success: true, invoiceId: number}","Status changed to VOID; Notes contain [VOIDED]: reason timestamp; Cannot void already voided invoice; Reason required","FLOW_GUIDE.md#1.1 Invoice Status Lifecycle; server/routers/invoices.ts:void"
Accounting,Invoices,Check Overdue,Action,invoices.checkOverdue,mutation,protectedProcedure,accounting:update,all,"Super Admin, Accounting Manager",Background/Scheduled,Check and update overdue invoice statuses,API-only,,server/routers/invoices.ts,None (no input parameters),"User has accounting:update permission","Automatically transitions invoices past due_date to OVERDUE status; Only affects SENT, VIEWED, PARTIAL statuses; Excludes soft-deleted invoices","SENT/VIEWED/PARTIAL -> OVERDUE (where due_date < today)","invoices: BULK UPDATE status to OVERDUE where due_date < today AND status IN (SENT, VIEWED, PARTIAL)",None,"Updates AR aging buckets; Overdue invoices flagged for collection follow-up",None,"Bulk update count logged; Suitable for scheduled job execution",May trigger overdue alerts/notifications in future,None,Database error on bulk update failure,"{success: true, overdueCount: number}","Returns count of invoices marked overdue; Only affects valid statuses; Excludes deleted invoices; Idempotent operation","FLOW_GUIDE.md#1.1 Invoice Status Lifecycle; server/routers/invoices.ts:checkOverdue"
Inventory,COGS,Update Batch COGS,Update,cogs.updateBatchCogs,mutation,protectedProcedure,cogs:update,all,"Super Admin, Inventory Manager, Accounting Manager",/inventory/:id,Update batch COGS with audit trail,Client-wired,,server/routers/cogs.ts,"{batchId: number, newCogs: string (decimal), applyTo: PAST_SALES|FUTURE_SALES|BOTH, reason: string (min 1 char)}","Batch exists; newCogs is valid positive number; User has cogs:update permission; Reason must be provided","COGS value must be non-negative; Reason is mandatory for audit trail; Can optionally propagate to pending orders; Updates affect margin calculations on line items","Batch.unitCogs: oldValue -> newValue; Pending orders: recalculated if applyTo includes FUTURE_SALES","batches: UPDATE unitCogs; auditLogs: INSERT COGS_UPDATE record; orders: UPDATE items JSON with recalculated margins (conditional)","Batch cost basis updated; Affects future inventory valuation","COGS change impacts gross margin on all affected orders; Pending orders recalculated if FUTURE_SALES or BOTH","No direct ledger impact (COGS affects P&L at sale completion)","Comprehensive audit trail via auditLogs table with before/after JSON; Actor and reason recorded",None,None,"NOT_FOUND if batch missing; BAD_REQUEST if invalid COGS value (NaN or negative); Validation error if reason empty","{batchId: number, oldCogs: number, newCogs: number, adjustment: number, applyTo: string, adjustedBy: userId, reason: string}","Batch unitCogs updated; Audit log created with before/after; Pending orders recalculated if applicable; Margin fields updated on order line items","FLOW_GUIDE.md#3.3 COGS Management; server/routers/cogs.ts:updateBatchCogs"
