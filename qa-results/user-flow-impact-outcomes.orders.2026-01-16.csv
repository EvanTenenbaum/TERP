Domain,Entity,Flow Name,Archetype,tRPC Procedure,Type,Procedure Wrapper,Permissions,Permission Mode,Roles,UI Entry Paths,Business Purpose,Implementation Status,Known Issues,Router File,Primary Data Inputs,Preconditions,Core Business Rules,State Transitions,Data Writes,Inventory Impact,Financial Impact,Ledger Impact,Audit & Compliance,Notifications & Alerts,External Integrations,Guardrails & Failure Modes,Expected Outputs,Test Assertions,Source-of-Truth Links
Orders,Orders,Create Order,Create,orders.create,mutation,protectedProcedure,orders:create,all,"Super Admin, Sales Manager, Sales Rep",/orders/new,Create order (basic version),Client-wired,,server/routers/orders.ts,"{ orderType: 'QUOTE' | 'SALE', isDraft?: boolean, clientId: number, items: [{ batchId, displayName?, quantity, unitPrice, isSample, overridePrice?, overrideCogs? }], validUntil?, paymentTerms?, cashPayment?, notes? }","User has orders:create permission; Client exists and is active; Batches exist with sufficient inventory; For non-draft SALE: inventory >= requested quantity","Client must exist and be active; Batch must exist and have status LIVE; Inventory must be sufficient for non-draft orders; COGS calculation follows client/batch rules; Order number generated with D-/Q-/S- prefix; Payment terms required for confirmed SALE","isDraft=true: no status; isDraft=false+QUOTE: quoteStatus=DRAFT; isDraft=false+SALE: saleStatus=PENDING, fulfillmentStatus=PENDING","orders: INSERT new record; orderLineItems: INSERT for each item (enhanced flow); batches: UPDATE onHandQty or sampleQty (if confirmed); sampleInventoryLog: INSERT (if sample consumed); invoices: INSERT (if confirmed SALE); payments: INSERT (if cashPayment > 0)","Confirmed orders: decrement onHandQty or sampleQty; Draft orders: no inventory impact until confirmed; Row-level locking (FOR UPDATE) prevents race conditions","Confirmed SALE: creates invoice; Records cashPayment against invoice; Updates client credit exposure; AP payables tracking updated on sale","No direct ledger postings; Invoice creation triggers AR entries via orderAccountingService","Order creation logged via orderAuditService; createdBy field tracks user; Notification triggered via onOrderCreated","Order creation notification sent; Email to client (if configured)","None for order creation; Invoice service integration for confirmed orders; Payables service for vendor tracking","INSUFFICIENT_INVENTORY: Throw if available < requested; CLIENT_NOT_FOUND: Throw if client doesn't exist; BATCH_NOT_FOUND: Throw if batch doesn't exist; SALE orders cannot be deleted (only cancelled)","{orderId, orderNumber, order object with parsed items, client data (if joined)}","Order record created with correct orderNumber format; Line items match input; Totals calculated correctly (subtotal = sum of lineTotals); Inventory decremented for confirmed orders; Invoice created for confirmed SALE","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/routers/orders.ts:create; server/ordersDb.ts:createOrder"
Orders,Draft Orders,Create Draft Enhanced,Create,orders.createDraftEnhanced,mutation,protectedProcedure,orders:create,all,"Super Admin, Sales Manager, Sales Rep",/orders/new,Create draft with COGS/margin,Client-wired,,server/routers/orders.ts,"{ orderType: 'QUOTE' | 'SALE', clientId: number, lineItems: [{ batchId, productDisplayName?, quantity, isSample, cogsPerUnit, marginPercent?, marginDollar?, isCogsOverridden, cogsOverrideReason?, isMarginOverridden }], orderLevelAdjustment?: { amount, type, mode }, showAdjustmentOnDocument?, notes?, validUntil?, paymentTerms?, cashPayment? }","User has orders:create permission; Client exists; Batches exist; Products exist for margin lookup; Pricing defaults configured (or 30% fallback used)","Margin retrieved via pricingService.getMarginWithFallback; COGS can be overridden per line item; Price calculated from COGS + margin; Order validation via orderValidationService; If no margin found, uses 30% fallback with console warning","Always creates isDraft=true; No inventory impact until finalized","orders: INSERT with isDraft=true, calculated totals; orderLineItems: INSERT for each item with COGS/margin data","No inventory impact; Draft orders do not reserve or consume inventory","No financial impact until confirmed/finalized","No ledger impact until confirmed","Audit log created via orderAuditService.logOrderCreation; Tracks orderType, clientId, lineItemCount, total","None for draft creation","None for draft creation","BATCH_NOT_FOUND: Throw if batch doesn't exist; Validation warnings returned but don't block creation; Missing pricing defaults logged with fallback to 30%","{orderId, orderNumber, totals: { subtotal, adjustmentAmount, finalTotal, avgMarginPercent }, validation: { isValid, warnings, errors }}","Order created with isDraft=true; orderLineItems created with margin source tracking; Totals calculated correctly with margin; Validation object returned","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/routers/orders.ts:createDraftEnhanced"
Orders,Draft Orders,Update Draft Enhanced,Update,orders.updateDraftEnhanced,mutation,protectedProcedure,orders:update,all,"Super Admin, Sales Manager, Sales Rep",/orders/:id,Update draft (enhanced),Client-wired,,server/routers/orders.ts,"{ orderId: number, version: number, lineItems: [{ batchId, productDisplayName?, quantity, isSample, cogsPerUnit, marginPercent?, marginDollar?, isCogsOverridden, cogsOverrideReason?, isMarginOverridden }], orderLevelAdjustment?, showAdjustmentOnDocument?, notes? }","User has orders:update permission; Order exists and isDraft=true; Version matches (optimistic locking); Batches exist for all line items","Optimistic locking via version field; BUG-086 FIX: Uses actual product category for margin lookup; Transaction ensures atomic update of order + line items; Old line items deleted, new ones inserted","No state change; isDraft remains true; version incremented","orders: UPDATE totals and notes, INCREMENT version; orderLineItems: DELETE existing, INSERT new set","No inventory impact for draft updates","No financial impact","No ledger impact","Audit log via orderAuditService.logOrderUpdate; Tracks lineItemCount and total","None for draft update","None for draft update","ORDER_NOT_FOUND: Throw if order doesn't exist; OPTIMISTIC_LOCK_ERROR: Throw if version mismatch; Uses withTransaction for atomicity","{orderId, totals: { subtotal, adjustmentAmount, finalTotal, avgMarginPercent }, validation: { isValid, warnings, errors }}","Order totals recalculated; Line items replaced; Version incremented; No inventory changes","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/routers/orders.ts:updateDraftEnhanced"
Orders,Draft Orders,Confirm Draft Order,State Transition,orders.confirmDraftOrder,mutation,protectedProcedure,orders:create,all,"Super Admin, Sales Manager, Sales Rep",/orders/:id,Confirm draft order,Client-wired,,server/routers/orders.ts,"{ orderId: number, paymentTerms: 'NET_7' | 'NET_15' | 'NET_30' | 'COD' | 'PARTIAL' | 'CONSIGNMENT', cashPayment?: number, notes?: string }","User has orders:create permission; Order exists and isDraft=true; Sufficient inventory for all items; Batches exist and have stock","Payment terms required for confirmation; Due date calculated from payment terms; Payment status determined: PAID if cashPayment >= total, PARTIAL if > 0, else PENDING; Inventory verified before confirmation","isDraft: true -> false; orderType: preserved or set to SALE; saleStatus: PENDING/PARTIAL/PAID; fulfillmentStatus: PENDING","orders: UPDATE isDraft=false, set paymentTerms, cashPayment, dueDate, saleStatus, fulfillmentStatus, confirmedAt; batches: UPDATE decrement onHandQty or sampleQty; sampleInventoryLog: INSERT if samples consumed","Decrement inventory for all line items; Sample inventory logged separately; Row-level locking prevents oversell","Creates invoice via createInvoiceFromOrder; Records cash payment if applicable; Updates client credit exposure","Invoice creation triggers AR entries","confirmedBy user tracked; confirmedAt timestamp set","Confirmation notification (if configured)","orderAccountingService for invoice/payment; payablesService for vendor tracking","INSUFFICIENT_INVENTORY: Throw with details; ORDER_NOT_DRAFT: Throw if already confirmed; Accounting errors non-fatal (logged)","Confirmed order object with saleStatus, fulfillmentStatus, dueDate","isDraft=false; Inventory decremented; Invoice created; Payment recorded if cashPayment > 0","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/ordersDb.ts:confirmDraftOrder"
Orders,Draft Orders,Finalize Draft,State Transition,orders.finalizeDraft,mutation,protectedProcedure,orders:create,all,"Super Admin, Sales Manager, Sales Rep",/orders/:id,Finalize draft order,Client-wired,,server/routers/orders.ts,"{ orderId: number, version: number }","User has orders:create permission; Order exists and isDraft=true; Version matches; Validation passes (isValid=true)","Final validation via orderValidationService; Cannot finalize if validation.isValid=false; Version check for concurrent edit prevention; Sets confirmedAt timestamp","isDraft: true -> false; version incremented","orders: UPDATE isDraft=false, confirmedAt=now(), version=version+1","No inventory change at finalization; Inventory reserved/consumed at subsequent fulfillment","No direct financial impact; Pricing locked at finalization","No ledger impact at finalization","Audit log via orderAuditService.logOrderFinalization; Tracks finalTotal and finalizedAt","None at finalization","None at finalization","VALIDATION_FAILED: Throw if validation.isValid=false with error list; ORDER_NOT_FOUND; OPTIMISTIC_LOCK_ERROR","{orderId, orderNumber, validation: { isValid, warnings, errors }}","isDraft=false; confirmedAt set; Validation passed; Version incremented","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/routers/orders.ts:finalizeDraft"
Orders,Fulfillment,Confirm Order,State Transition,orders.confirmOrder,mutation,protectedProcedure,orders:update,all,"Super Admin, Sales Manager, Fulfillment",/orders/:id,Confirm pending order,Client-wired,,server/routers/orders.ts,"{ id: number, notes?: string }","User has orders:update permission; Order exists; orderType=SALE; saleStatus=PENDING or fulfillmentStatus=PENDING; Inventory available for all items","Only SALE orders can be confirmed; Status must be PENDING; Batch query optimized (N+1 fix); Inventory check uses batch map for efficiency; Sample inventory checked separately","confirmedAt: null -> now(); Notes appended with [Confirmed] prefix if provided","orders: UPDATE confirmedAt=now(), notes appended","No inventory decrement at confirmation; Inventory verified but not consumed","No financial impact at confirmation","No ledger impact","confirmedAt timestamp serves as audit trail","None at confirmation","None","SALE_ONLY: Throw if orderType != SALE; STATUS_NOT_PENDING: Throw if not in confirmable state; INSUFFICIENT_INVENTORY: Throw with batch details; BATCH_NOT_FOUND: Throw if batch missing","{success: true, orderId}","confirmedAt set; Status remains unchanged; Inventory verified but not decremented","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/routers/orders.ts:confirmOrder"
Orders,Fulfillment,Fulfill Order,Action,orders.fulfillOrder,mutation,protectedProcedure,orders:update,all,"Super Admin, Fulfillment",/orders/:id,Fulfill order items with pick quantities,Client-wired,,server/routers/orders.ts,"{ id: number, items: [{ batchId: number, pickedQuantity: number, locationId?: number, notes?: string }] }","User has orders:update permission; Order exists; fulfillmentStatus != SHIPPED; Picked quantities <= ordered quantities","Tracks picked quantities per batch; Updates fulfillment status based on pick completeness; All items fully picked -> PACKED; Any partial pick -> remains PENDING; Records picker info and timestamp per item","fulfillmentStatus: PENDING -> PACKED (if all picked) or stays PENDING; packedAt set if all packed; items JSON updated with pick info","orders: UPDATE items JSON with picked data, fulfillmentStatus, packedAt, packedBy","No inventory decrement at pick; Inventory decremented at ship","No financial impact at pick","No ledger impact","pickedBy and pickedAt tracked per item in items JSON; packedBy tracked on order","None at pick","None","CANNOT_FULFILL_SHIPPED: Throw if already shipped; BATCH_NOT_IN_ORDER: Throw if batchId not in order items; EXCEEDED_QUANTITY: Throw if pickedQuantity > ordered","{success: true, orderId, status: 'PACKED' | 'PENDING', allFullyPicked: boolean, pickedItems: count}","Items updated with pick data; Status reflects pick completeness; Timestamps set appropriately","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/routers/orders.ts:fulfillOrder"
Orders,Order Status,Update Order Status,State Transition,orders.updateOrderStatus,mutation,protectedProcedure,orders:update,all,"Super Admin, Sales Manager, Fulfillment",/orders/:id,Update order fulfillment status,Client-wired,,server/routers/orders.ts,"{ orderId: number, newStatus: 'PENDING' | 'PACKED' | 'SHIPPED', notes?: string }","User has orders:update permission; Order exists; Current status allows transition; For SHIPPED: inventory available","Status transitions: PENDING->PACKED->SHIPPED; Cannot revert SHIPPED; Cannot go PACKED->PENDING; Inventory check before shipping; Optimistic locking support via expectedVersion; Notes sanitized (max 5000 chars)","fulfillmentStatus: oldStatus -> newStatus; packedAt/packedBy set for PACKED; shippedAt/shippedBy set for SHIPPED; version incremented","orders: UPDATE fulfillmentStatus, timestamps, version; orderStatusHistory: INSERT status change record; inventoryMovements: INSERT SALE movement (if SHIPPED); batches: UPDATE decrement onHandQty (if SHIPPED)","SHIPPED: decrement onHandQty for all non-sample items; Creates SALE movement records","No direct financial impact from status change","No ledger impact from status change","orderStatusHistory tracks all status changes with changedBy, changedAt, notes","None direct; Shipping notification could be triggered","None direct","CANNOT_CHANGE_SHIPPED: Throw if current=SHIPPED; CANNOT_REVERT_PACKED: Throw if PACKED->PENDING; INSUFFICIENT_INVENTORY: Throw if SHIPPED and inventory short","{success: true, newStatus, version}","Status updated; History recorded; Inventory decremented if SHIPPED; Version incremented","FLOW_GUIDE.md#Domain-4-Orders-Sales; server/ordersDb.ts:updateOrderStatus"
