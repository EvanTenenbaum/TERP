Domain,Entity,Flow Name,Archetype,tRPC Procedure,Type,Procedure Wrapper,Permissions,Permission Mode,Roles,UI Entry Paths,Business Purpose,Implementation Status,Known Issues,Router File,Primary Data Inputs,Preconditions,Core Business Rules,State Transitions,Data Writes,Inventory Impact,Financial Impact,Ledger Impact,Audit & Compliance,Notifications & Alerts,External Integrations,Guardrails & Failure Modes,Expected Outputs,Test Assertions,Source-of-Truth Links
Inventory,Batches,Create Batch,Create,batches.create,mutation,protectedProcedure,inventory:create,all,"Super Admin, Inventory Manager",/inventory/new,Create new batch,Client-wired,,server/routers/inventory.ts,"vendorName: string, brandName: string, productName: string, quantity: number, unitCogs: number, category: string, subcategory: string, grade: string, strainName: string (optional), lotCode: string (optional)","User authenticated with inventory:create permission; Valid vendor/brand/product must exist or be creatable; Quantity > 0","SKU auto-generated from product/batch sequence; Batch code generated with format prefix; Initial status is AWAITING_INTAKE; COGS must be non-negative; Quantity must be positive integer; Strain matching uses fuzzy logic with 95% threshold",N/A (new record creation),"batches: INSERT new row; products: INSERT if new; vendors: INSERT if new; brands: INSERT if new; lots: INSERT if new; inventory_movements: INSERT INTAKE record; audit_logs: INSERT creation log","Creates initial inventory with onHandQty = quantity; reservedQty = 0; quarantineQty = 0; holdQty = 0; availableQty = quantity",COGS recorded at batch level; Total inventory value = quantity * unitCogs,No direct ledger impact on creation,Audit log created with actor ID and entity snapshot; Batch creation tracked with timestamp and user,"No notifications on creation; Alert if low stock threshold may be triggered on dashboard",None,"Returns error if: permission denied (403); quantity <= 0; duplicate SKU; invalid vendor/brand/product; database connection failure","{success: true, batch: {id, code, sku, batchStatus, onHandQty, unitCogs}}","Assert batch.id exists; Assert batch.batchStatus = 'AWAITING_INTAKE'; Assert batch.onHandQty = input.quantity; Assert audit_log created; Assert inventory_movement with type INTAKE exists","FLOW_GUIDE.md Section 3.1; server/routers/inventory.ts:intake; server/inventoryIntakeService.ts"
Inventory,Batches,Update Batch,Update,batches.update,mutation,protectedProcedure,inventory:update,all,"Super Admin, Inventory Manager",/inventory/:id,Update batch with optimistic locking,Client-wired,,server/routers/inventory.ts,"id: number, version: number (optional), ticket: number (unitCogs), notes: string, reason: string","User authenticated with inventory:update permission; Batch must exist; If version provided must match current version","Version conflict detection with optimistic locking (ST-026); COGS changes tracked in history; Notes stored in metadata JSON; Reason required for audit trail",N/A (field update only),"batches: UPDATE row (unitCogs, metadata, version++); audit_logs: INSERT update log","No direct inventory quantity change; COGS update affects inventory valuation",COGS change recalculates batch value; Total value = onHandQty * new unitCogs,No direct ledger impact,Audit log captures before/after snapshot with reason; Version incremented for optimistic locking,"No notifications on update",None,"Returns error if: permission denied (403); batch not found (404); version mismatch (409 CONFLICT); invalid COGS value","{success: true}","Assert batch.unitCogs = input.ticket; Assert batch.version incremented; Assert audit_log with action BATCH_UPDATE; Assert metadata contains notes","FLOW_GUIDE.md Section 3.1; server/routers/inventory.ts:updateBatch; server/inventoryDb.ts:updateBatchFields"
Inventory,Batches,Delete Batch,Delete,batches.delete,mutation,protectedProcedure,inventory:delete,all,"Super Admin",/inventory/:id,Delete batch (soft delete),Client-wired,,server/routers/inventory.ts,"batchIds: number[]","User authenticated with inventory:delete permission (Super Admin only); Batch must exist; Batch should not have pending orders or reserved quantities","Soft delete implemented via status change to CLOSED; Bulk delete supported; Cannot delete batches with reservedQty > 0; Cannot delete batches linked to open orders",Any status -> CLOSED (terminal),"batches: UPDATE status = CLOSED for each id; audit_logs: INSERT deletion log per batch","Inventory effectively removed from available pool; onHandQty retained for historical reference; availableQty becomes 0",Historical COGS preserved; No new sales possible,No ledger entries on soft delete,Audit log records deletion with actor and reason; Status change tracked,"No notifications on delete",None,"Returns error if: permission denied (403); batch not found (404); batch has reserved inventory; batch linked to open orders","{success: true, deleted: number}","Assert batch.batchStatus = 'CLOSED'; Assert batch cannot be sold; Assert audit_log with action DELETE; Assert reservedQty = 0 before delete allowed","FLOW_GUIDE.md Section 3.1; server/routers/inventory.ts:bulk.delete; server/inventoryDb.ts:bulkDeleteBatches"
Inventory,Batches,Update Status,State Transition,batches.updateStatus,mutation,protectedProcedure,inventory:update,all,"Super Admin, Inventory Manager",/inventory/:id,Update batch status (AWAITING_INTAKE->LIVE etc),Client-wired,,server/routers/inventory.ts,"id: number, status: BatchStatus enum, reason: string, version: number (optional)","User authenticated with inventory:update permission; Batch must exist; Status transition must be valid per lifecycle rules; Version must match if provided","Valid transitions: AWAITING_INTAKE->LIVE; LIVE->PHOTOGRAPHY_COMPLETE|ON_HOLD|QUARANTINED|SOLD_OUT; QUARANTINED->LIVE; Any->CLOSED (terminal); Quarantine moves qty from onHand to quarantineQty; Release from quarantine reverses","AWAITING_INTAKE->LIVE; LIVE->PHOTOGRAPHY_COMPLETE|ON_HOLD|QUARANTINED|SOLD_OUT; QUARANTINED->LIVE; CLOSED is terminal","batches: UPDATE batchStatus and version; inventory_movements: INSERT QUARANTINE or RELEASE_FROM_QUARANTINE if applicable; audit_logs: INSERT status change log","Quarantine: moves onHandQty to quarantineQty (inventory locked); Release: moves quarantineQty back to onHandQty; SOLD_OUT when availableQty = 0",Status affects sale eligibility; Only LIVE batches can be sold,No direct ledger impact,Audit log with before/after status; Reason recorded for compliance; Quarantine events tracked for quality control,"Alert generated for QUARANTINE status on dashboard",None,"Returns error if: permission denied (403); batch not found (404); invalid transition (400); version mismatch (409); trying to transition from terminal CLOSED status","{success: true}","Assert batch.batchStatus = input.status; Assert valid transition occurred; Assert audit_log with action STATUS_CHANGE; Assert inventory_movement if QUARANTINE/RELEASE","FLOW_GUIDE.md Section 3.1 Batch Status Lifecycle; server/routers/inventory.ts:updateStatus; server/inventoryUtils.ts:isValidStatusTransition"
Inventory,Movements,Record Movement,Create,inventoryMovements.record,mutation,protectedProcedure,inventory:update,all,"Super Admin, Inventory Manager",/inventory/:id,Record inventory movement,Client-wired,,server/routers/inventoryMovements.ts,"batchId: number, movementType: enum (INTAKE|SALE|REFUND_RETURN|ADJUSTMENT|QUARANTINE|RELEASE_FROM_QUARANTINE|DISPOSAL|TRANSFER|SAMPLE), quantityChange: string, quantityBefore: string, quantityAfter: string, referenceType: string (optional), referenceId: number (optional), reason: string (optional)","User authenticated with inventory:update permission; Batch must exist; quantityBefore must match current batch quantity; quantityAfter must be non-negative","Movement type determines direction: positive for INTAKE/REFUND_RETURN/RELEASE; negative for SALE/DISPOSAL/SAMPLE/QUARANTINE; ADJUSTMENT can be either; referenceType/Id links to source entity (ORDER/RETURN/etc); All movements are immutable once created",N/A (creates movement record),"inventory_movements: INSERT new movement record; Links to batch via batchId; Records performer via performedBy","Tracks all inventory changes with full audit trail; Enables inventory reconciliation; Movement history for each batch",Movement may have financial implications via linked reference (e.g. SALE -> order),Movement may trigger ledger posting if linked to accounting entity,Full audit trail with timestamp/performer/reason; Movement records are immutable; Supports reverse operations,"DISPOSAL movements may trigger alert; Low stock after movement may trigger dashboard alert",None,"Returns error if: permission denied (403); batch not found (404); quantityAfter would be negative; quantityBefore mismatch with current state","{id: number, batchId: number, movementType: string, quantityChange: string, createdAt: Date}","Assert movement record created; Assert movement.performedBy = current user; Assert movement.batchId = input.batchId; Assert movement.quantityChange = input.quantityChange","FLOW_GUIDE.md Section 3.2 Movement Types; server/routers/inventoryMovements.ts:record; server/inventoryMovementsDb.ts:recordInventoryMovement"
Inventory,Movements,Adjust Inventory,Action,inventoryMovements.adjust,mutation,protectedProcedure,inventory:update,all,"Super Admin, Inventory Manager",/inventory/:id,Adjust inventory quantity with reason,Client-wired,,server/routers/inventoryMovements.ts,"batchId: number, newQuantity: string, reason: string, notes: string (optional), adjustmentReason: enum (DAMAGED|EXPIRED|LOST|THEFT|COUNT_DISCREPANCY|QUALITY_ISSUE|REWEIGH|OTHER)","User authenticated with inventory:update permission; Batch must exist; newQuantity must be non-negative; reason is required for audit","Adjustment creates ADJUSTMENT movement type; adjustmentReason categorizes the adjustment for reporting; Negative adjustments flagged for shrinkage analysis; Large adjustments may be flagged as suspicious",N/A (quantity adjustment),"batches: UPDATE onHandQty to newQuantity; inventory_movements: INSERT ADJUSTMENT record with before/after; adjustmentReason stored for shrinkage reporting","Directly modifies onHandQty; availableQty recalculated; May trigger status change to SOLD_OUT if qty becomes 0",Adjustment affects inventory valuation; Shrinkage (negative adj) may require write-off,No direct ledger impact; May require journal entry for significant shrinkage,Full audit trail with adjustment reason; Suspicious adjustments flagged (THEFT/LOST or large unexplained); Shrinkage report tracks all adjustments,"Suspicious adjustment may generate alert; Dashboard shrinkage widget updated",None,"Returns error if: permission denied (403); batch not found (404); newQuantity < 0; reason empty; quantity would create negative available","Movement record with adjustmentReason populated","Assert batch.onHandQty = input.newQuantity; Assert movement.adjustmentReason = input.adjustmentReason; Assert movement.quantityChange = (newQty - oldQty); Assert audit trail complete","FLOW_GUIDE.md Section 3.2 Adjustment Reasons; server/routers/inventoryMovements.ts:adjust; server/inventoryMovementsDb.ts:adjustInventory"
Inventory,Movements,Reverse Movement,Action,inventoryMovements.reverse,mutation,protectedProcedure,inventory:update,all,"Super Admin, Inventory Manager",/inventory/:id/movements,Reverse inventory movement,Client-wired,,server/routers/inventoryMovements.ts,"movementId: number, reason: string","User authenticated with inventory:update permission; Movement must exist; Movement must not already be reversed; Reason is required","Creates a new movement that negates the original; Links reversal to original via reversalOfId; Original movement marked as reversed; Quantity change is inverse of original; Both movements remain in audit trail",N/A (creates reversal movement),"inventory_movements: INSERT reversal record with opposite quantityChange; inventory_movements: UPDATE original record isReversed=true; batches: UPDATE quantity to reflect reversal","Restores inventory to pre-movement state; Original movement preserved for audit; Reversal appears in movement history",May reverse financial impact if linked to refund/return,May require ledger adjustment if original had ledger impact,Complete audit trail; Original and reversal movements linked; Reason for reversal recorded; Supports compliance investigations,"No specific alerts on reversal",None,"Returns error if: permission denied (403); movement not found (404); movement already reversed (400); reason empty; reversal would create negative quantity","{success: true, reversalMovementId: number}","Assert reversal movement created with negated quantityChange; Assert original movement marked isReversed; Assert batch quantity restored; Assert reason recorded","FLOW_GUIDE.md Section 3.2; server/routers/inventoryMovements.ts:reverse; server/inventoryMovementsDb.ts:reverseInventoryMovement"
Inventory,Strains,Create Strain,Create,strains.create,mutation,protectedProcedure,inventory:create,all,"Super Admin, Inventory Manager",/strains/new,Create custom strain,Client-wired,,server/routers/strains.ts,"name: string, category: enum (indica|sativa|hybrid), description: string (optional), aliases: string (optional)","User authenticated with inventory:create permission; Strain name should be unique or fuzzy-match threshold applies","Strain ULID auto-generated; Category required (indica/sativa/hybrid); Aliases stored for fuzzy matching; Strain can be linked to products/batches; Duplicate detection via fuzzy matching",N/A (new record creation),"strains: INSERT new strain record with ULID; May trigger strain family linking if similar strains exist","No direct inventory impact; Strains are reference data used by batches",No financial impact,No ledger impact,Strain creation logged; Strain lineage/family tracked for analytics,"No notifications on creation",None,"Returns error if: permission denied (403); name empty; category invalid; exact duplicate name exists","{id: number, ulid: string, name: string, category: string}","Assert strain.id exists; Assert strain.ulid generated; Assert strain.name = input.name; Assert strain.category = input.category","FLOW_GUIDE.md Section 3.5; server/routers/strains.ts:create; server/inventoryDb.ts:createStrain"
