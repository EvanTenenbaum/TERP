Domain,Entity,Flow Name,Archetype,tRPC Procedure,Type,Procedure Wrapper,Permissions,Permission Mode,Roles,UI Entry Paths,Business Purpose,Implementation Status,Known Issues,Router File,Primary Data Inputs,Preconditions,Core Business Rules,State Transitions,Data Writes,Inventory Impact,Financial Impact,Ledger Impact,Audit & Compliance,Notifications & Alerts,External Integrations,Guardrails & Failure Modes,Expected Outputs,Test Assertions,Source-of-Truth Links
CRM,Clients,Create Client,Create,clients.create,mutation,protectedProcedure,clients:create,all,"Super Admin, Sales Manager",/clients/new,Create new client,Client-wired,,server/routers/clients.ts,"teriCode (required, string 1-50), name (required, string 1-255), email (optional, valid email), phone (optional, string max 50), address (optional, string), businessType (optional, enum: RETAIL|WHOLESALE|DISPENSARY|DELIVERY|MANUFACTURER|DISTRIBUTOR|OTHER), preferredContact (optional, enum: EMAIL|PHONE|TEXT|ANY), paymentTerms (optional, int default 30), isBuyer/isSeller/isBrand/isReferee/isContractor (optional, boolean), tags (optional, string[]), wishlist (optional, string)","User authenticated with clients:create permission; User role is Super Admin or Sales Manager; TERI code must be unique (not already in use)","TERI code must be unique across all active clients; Name cannot be empty; Email must be valid format if provided; Business type must be one of allowed enum values; paymentTerms defaults to 30 if not specified; At least one role flag should typically be set (isBuyer, isSeller, etc.)",N/A - New record creation,"clients table: INSERT new row with all provided fields; client_activity table: INSERT activity log with type CREATED",None - client creation does not affect inventory,"None directly - client financial tracking initialized with totalSpent=0, totalProfit=0, totalOwed=0, creditLimit=null",None - no ledger entries on client creation,"Activity logged to client_activity table with userId, activityType=CREATED, timestamp; Audit trail maintained for compliance",None on creation,None,"TERI code duplicate returns CONFLICT error with message; Missing required fields return BAD_REQUEST; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN; Database errors wrapped with context","Returns client ID (number) on success; TRPC mutation response with created client ID","Verify client exists in DB with correct fields; Verify activity log entry created; Verify TERI code is unique; Verify duplicate TERI returns CONFLICT; Verify unauthorized access denied","FLOW_GUIDE.md Domain 2.1 Clients; server/routers/clients.ts lines 93-140; server/clientsDb.ts createClient function"
CRM,Clients,Update Client,Update,clients.update,mutation,protectedProcedure,clients:update,all,"Super Admin, Sales Manager",/clients/:id,Update client with optimistic locking,Client-wired,,server/routers/clients.ts,"clientId (required, number), version (optional, number for optimistic locking), name (optional), email (optional), phone (optional), address (optional), businessType (optional), preferredContact (optional), paymentTerms (optional), isBuyer/isSeller/isBrand/isReferee/isContractor (optional), tags (optional), wishlist (optional)","User authenticated with clients:update permission; Client exists and is not soft-deleted; If version provided, must match current version for optimistic locking","Only provided fields are updated; Optimistic locking: if version provided and doesn't match, update fails with VERSION_CONFLICT; Email must be valid format if provided; At least one field must be provided to update",N/A - Update operation does not change status,"clients table: UPDATE row with provided fields, increment version if using optimistic locking; client_activity table: INSERT activity log with type UPDATED and list of changed fields",None,None - update does not affect financial tracking directly,None,"Activity logged to client_activity table with activityType=UPDATED, metadata includes list of updated fields",None,None,"Client not found returns NOT_FOUND; Version mismatch returns PRECONDITION_FAILED (optimistic locking); Invalid email format returns BAD_REQUEST; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN",Returns boolean true on success,"Verify updated fields match input; Verify unchanged fields preserved; Verify activity log entry with correct field list; Verify version incremented; Verify optimistic locking rejects stale version","FLOW_GUIDE.md Domain 2.1 Clients; server/routers/clients.ts lines 142-170; server/clientsDb.ts updateClient function"
CRM,Clients,Delete Client,Delete,clients.delete,mutation,protectedProcedure,clients:delete,all,"Super Admin",/clients/:id,Hard delete client,Client-wired,,server/routers/clients.ts,"clientId (required, number)","User authenticated with clients:delete permission; User role is Super Admin; Client exists","Performs soft delete (sets deletedAt timestamp) not hard delete despite flow name; Soft-deleted clients excluded from list queries; Preserves data integrity and allows recovery",Active -> Deleted (soft delete via deletedAt timestamp),"clients table: UPDATE deletedAt = NOW(); client_activity table: INSERT activity log with type UPDATED, action=archived",None,"None directly - client financial data preserved for historical reporting; Outstanding debt remains in system",None,"Activity logged with action=archived; Soft delete preserves audit trail; Deleted clients still queryable by admins if needed",None,None,"Client not found or already deleted returns NOT_FOUND; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN; Non-Super Admin returns FORBIDDEN",Returns boolean true on success,"Verify deletedAt is set; Verify client excluded from list queries; Verify client still exists in DB (soft delete); Verify activity log entry with archived action; Verify only Super Admin can delete","FLOW_GUIDE.md Domain 2.1 Clients; server/routers/clients.ts lines 172-180; server/clientsDb.ts deleteClient function; DI-004 soft delete pattern"
CRM,Clients,Archive Client,Delete/Archive,clients.archive,mutation,protectedProcedure,clients:delete,all,"Super Admin, Sales Manager",/clients/:id,Soft delete/archive client,Client-wired,,server/routers/clients.ts,"clientId (required, number)","User authenticated with clients:delete permission; User role is Super Admin or Sales Manager; Client exists and is not already archived","Identical to delete - sets deletedAt timestamp; Archived clients can be restored; Preserves all client data and relationships",Active -> Archived (deletedAt set),"clients table: UPDATE deletedAt = NOW(); client_activity table: INSERT activity log with action=archived",None,"None - financial data preserved; Can restore client to reactivate",None,"Activity logged with action=archived; Full audit trail maintained; Reversible operation via restore",None,None,"Client not found returns NOT_FOUND; Already archived client may still succeed (idempotent); Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN",Returns boolean true on success,"Verify deletedAt is set; Verify client excluded from normal queries; Verify activity log with archived action; Verify Sales Manager can archive (unlike delete which requires Super Admin)","FLOW_GUIDE.md Domain 2.1 Clients; server/routers/clients.ts lines 182-190; server/clientsDb.ts deleteClient function; DI-004 soft delete pattern"
CRM,Client Transactions,Create Transaction,Create,clients.transactions.create,mutation,protectedProcedure,clients:create,all,"Super Admin, Sales Manager",/clients/:id/transactions,Create transaction,Client-wired,,server/routers/clients.ts,"clientId (required, number), transactionType (required, enum: INVOICE|PAYMENT|QUOTE|ORDER|REFUND|CREDIT), transactionNumber (optional, string), transactionDate (required, date), amount (required, number), paymentStatus (optional, enum: PAID|PENDING|OVERDUE|PARTIAL), paymentDate (optional, date), paymentAmount (optional, number), notes (optional, string), metadata (optional, object)","User authenticated with clients:create permission; Client exists and is not soft-deleted; TransactionType is valid enum value","Amount is stored with 2 decimal precision; PaymentStatus defaults to PENDING if not specified; Transaction triggers client stats recalculation; For INVOICE/ORDER types, updates totalSpent, totalOwed, oldestDebtDays; Credit recalculation triggered asynchronously if client has transactions",N/A - creates new transaction record,"client_transactions table: INSERT new transaction row; clients table: UPDATE totalSpent, totalProfit, avgProfitMargin, totalOwed, oldestDebtDays via updateClientStats; client_activity table: INSERT TRANSACTION_ADDED activity",None,"Yes - updates client financial metrics: totalSpent, totalProfit, totalOwed; Credit limit may be recalculated asynchronously",None - no GL entries from CRM transaction,"Activity logged with TRANSACTION_ADDED type including transactionId; Client stats updated atomically",None,None,"Client not found returns NOT_FOUND; Invalid transactionType returns BAD_REQUEST; Invalid date format returns BAD_REQUEST; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN","Returns transaction ID (number) on success; Client stats updated","Verify transaction created with correct fields; Verify client totalSpent updated for INVOICE/ORDER types; Verify totalOwed updated for unpaid transactions; Verify activity log entry; Verify credit recalculation triggered","FLOW_GUIDE.md Domain 2.3 Client Transactions; server/routers/clients.ts lines 230-258; server/clientsDb.ts createTransaction function"
CRM,Client Transactions,Record Payment,Action,clients.transactions.recordPayment,mutation,protectedProcedure,clients:update,all,"Super Admin, Sales Manager, Sales Rep",/clients/:id/transactions,Record payment against transaction,Client-wired,FIX-SEC: Changed permission from clients:read to clients:update,server/routers/clients.ts,"transactionId (required, number), paymentDate (required, date), paymentAmount (required, number)","User authenticated with clients:update permission; Transaction exists; Payment amount is positive","Payment status calculated: PAID if paymentAmount >= transaction amount, PARTIAL otherwise; Payment recorded atomically with stats update; Uses database transaction for consistency; Triggers client stats recalculation including totalOwed update",PENDING/PARTIAL -> PAID (if full payment) or PENDING -> PARTIAL (if partial),"client_transactions table: UPDATE paymentStatus, paymentDate, paymentAmount; clients table: UPDATE totalOwed, oldestDebtDays via updateClientStats; client_activity table: INSERT PAYMENT_RECORDED activity with paymentAmount",None,"Yes - reduces totalOwed when payment recorded; Updates payment tracking metrics; May trigger credit limit recalculation",None - payment recorded in CRM only,"Activity logged with PAYMENT_RECORDED type including transactionId and paymentAmount; Database transaction ensures atomicity; Credit recalculation triggered",None,None,"Transaction not found returns NOT_FOUND; Invalid payment amount returns BAD_REQUEST; Invalid date returns BAD_REQUEST; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN; Concurrent updates handled by DB transaction",Returns boolean true on success,"Verify paymentStatus correctly calculated (PAID vs PARTIAL); Verify paymentDate and paymentAmount set; Verify client totalOwed decreased; Verify activity log entry with payment details; Verify atomic operation (all or nothing)","FLOW_GUIDE.md Domain 2.3 Client Transactions; server/routers/clients.ts lines 285-304; server/clientsDb.ts recordPayment function; FIX-SEC security improvement"
CRM,Client Tags,Add Tag,Create,clients.tags.add,mutation,protectedProcedure,clients:create,all,"Super Admin, Sales Manager",/clients/:id,Add tag to client,Client-wired,,server/routers/clients.ts,"clientId (required, number), tag (required, string 1-50 chars)","User authenticated with clients:create permission; Client exists and is not soft-deleted; Tag is non-empty string within length limits","Tag is added to JSON array in tags column; Duplicate tags are idempotent (returns success without adding duplicate); Tags stored as JSON array; Tag string trimmed and validated",N/A - adds to collection,"clients table: UPDATE tags JSON array to include new tag; client_activity table: INSERT TAG_ADDED activity with tag value",None,None,None,"Activity logged with TAG_ADDED type including the tag name; Tag changes tracked for audit",None,None,"Client not found returns NOT_FOUND; Empty or too long tag returns BAD_REQUEST; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN","Returns boolean true on success; Idempotent if tag already exists","Verify tag added to client tags array; Verify duplicate tag is idempotent (no error, no duplicate); Verify activity log entry with tag; Verify tag appears in getAllTags query","FLOW_GUIDE.md Domain 2.4 Client Activity & Communication; server/routers/clients.ts lines 394-405; server/clientsDb.ts addTag function"
CRM,Client Communications,Add Communication,Create,clients.communications.add,mutation,protectedProcedure,clients:create,all,"Super Admin, Sales Manager, Sales Rep",/clients/:id/communications,Add communication log entry,Client-wired,,server/routers/clients.ts,"clientId (required, number), type (required, enum: CALL|EMAIL|MEETING|NOTE), subject (required, string 1-255), notes (optional, string), communicatedAt (required, ISO date string)","User authenticated with clients:create permission; Client exists; Communication type is valid enum; Subject is non-empty","Subject sanitized and truncated to 255 chars; Notes sanitized and truncated to 5000 chars; CommunicatedAt parsed as ISO date; LoggedBy set from authenticated user context",N/A - creates new record,"client_communications table: INSERT new row with clientId, communicationType, subject, notes, communicatedAt, loggedBy",None,None,None,"Communication log provides audit trail of client interactions; Logged by user ID recorded for accountability",None,None,"Client not found returns NOT_FOUND; Invalid communication type returns BAD_REQUEST; Missing subject returns BAD_REQUEST; Invalid date format returns BAD_REQUEST; Unauthenticated returns UNAUTHORIZED; Missing permission returns FORBIDDEN","Returns {success: true, id: number} with new communication ID","Verify communication record created with correct fields; Verify loggedBy matches authenticated user; Verify subject/notes properly sanitized; Verify communication appears in list query","FLOW_GUIDE.md Domain 2.4 Client Activity & Communication; server/routers/clients.ts lines 464-481; server/clientsDb.ts addCommunication function"
