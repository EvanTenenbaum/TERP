{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://calmread.com/schemas/app-screen/v1.0.0",
  "title": "CalmRead App Screen Schema",
  "description": "Schema defining allowed screens, interactions, and navigation. Version 1.0.0",
  "type": "object",
  "required": ["version", "screens", "navigation", "globalConstraints"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "screens": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/screen"
      },
      "minItems": 1
    },
    "navigation": {
      "$ref": "#/definitions/navigationRules"
    },
    "globalConstraints": {
      "$ref": "#/definitions/globalConstraints"
    },
    "components": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/component"
      },
      "description": "Reusable UI components"
    }
  },
  "definitions": {
    "screen": {
      "type": "object",
      "required": [
        "screenId",
        "name",
        "purpose",
        "allowedActions",
        "forbiddenElements",
        "layout"
      ],
      "properties": {
        "screenId": {
          "type": "string",
          "pattern": "^screen_[a-z_]+$",
          "description": "Unique screen identifier"
        },
        "name": {
          "type": "string",
          "description": "Human-readable screen name"
        },
        "purpose": {
          "type": "string",
          "description": "What this screen is for"
        },
        "allowedActions": {
          "type": "object",
          "required": ["primary"],
          "properties": {
            "primary": {
              "oneOf": [
                { "$ref": "#/definitions/action" },
                { "type": "null" }
              ],
              "description": "Main action on this screen (max 1)"
            },
            "secondary": {
              "oneOf": [
                { "$ref": "#/definitions/action" },
                { "type": "null" }
              ],
              "description": "Optional secondary action (max 1)"
            }
          }
        },
        "forbiddenElements": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "UI elements that must NOT appear"
        },
        "layout": {
          "$ref": "#/definitions/layout"
        },
        "transitions": {
          "type": "object",
          "properties": {
            "enter": {
              "type": "string",
              "enum": ["instant", "fade"],
              "description": "How screen appears"
            },
            "exit": {
              "type": "string",
              "enum": ["instant", "fade"],
              "description": "How screen disappears"
            }
          }
        },
        "audio": {
          "type": "object",
          "properties": {
            "onEnter": {
              "type": "string",
              "description": "Audio to play when screen appears"
            },
            "background": {
              "type": "null",
              "description": "No background audio allowed"
            }
          }
        }
      }
    },
    "action": {
      "type": "object",
      "required": ["actionId", "type", "label"],
      "properties": {
        "actionId": {
          "type": "string",
          "description": "Unique action identifier"
        },
        "type": {
          "type": "string",
          "enum": [
            "navigate",
            "play_audio",
            "start_recording",
            "stop_recording",
            "submit_response",
            "next_page",
            "previous_page",
            "exit"
          ]
        },
        "label": {
          "type": "string",
          "description": "Button/action label"
        },
        "target": {
          "type": "string",
          "description": "Target screen or resource"
        },
        "confirmation": {
          "type": "boolean",
          "description": "Whether action needs confirmation"
        }
      }
    },
    "layout": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["single_content", "split_content", "list_selection", "full_page"],
          "description": "Layout type"
        },
        "scrollable": {
          "type": "boolean",
          "enum": [false],
          "description": "Must always be false - no scrolling allowed"
        },
        "margins": {
          "type": "object",
          "properties": {
            "top": { "type": "integer", "minimum": 16 },
            "bottom": { "type": "integer", "minimum": 16 },
            "left": { "type": "integer", "minimum": 16 },
            "right": { "type": "integer", "minimum": 16 }
          }
        },
        "contentAreas": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "areaId": { "type": "string" },
              "purpose": { "type": "string" },
              "maxItems": { "type": "integer" }
            }
          }
        }
      }
    },
    "navigationRules": {
      "type": "object",
      "required": ["allowedTransitions", "backBehavior", "exitBehavior"],
      "properties": {
        "allowedTransitions": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["from", "to", "trigger"],
            "properties": {
              "from": {
                "type": "string",
                "description": "Source screen ID"
              },
              "to": {
                "type": "string",
                "description": "Target screen ID"
              },
              "trigger": {
                "type": "string",
                "description": "What triggers this transition"
              },
              "conditions": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Conditions that must be met"
              }
            }
          }
        },
        "backBehavior": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether back navigation is allowed"
            },
            "restrictions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Screens where back is restricted"
            }
          }
        },
        "exitBehavior": {
          "type": "object",
          "properties": {
            "requiresConfirmation": {
              "type": "boolean"
            },
            "parentGated": {
              "type": "boolean",
              "description": "Whether exit requires parent action"
            },
            "allowedFrom": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Screens where exit is allowed"
            }
          }
        }
      }
    },
    "globalConstraints": {
      "type": "object",
      "required": [
        "noScrolling",
        "maxActionsPerScreen",
        "forbiddenPatterns",
        "requiredElements"
      ],
      "properties": {
        "noScrolling": {
          "type": "boolean",
          "enum": [true],
          "description": "Scrolling is forbidden everywhere"
        },
        "maxActionsPerScreen": {
          "type": "object",
          "properties": {
            "primary": {
              "type": "integer",
              "enum": [1]
            },
            "secondary": {
              "type": "integer",
              "enum": [1]
            }
          }
        },
        "forbiddenPatterns": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "pattern": { "type": "string" },
              "reason": { "type": "string" },
              "severity": {
                "type": "string",
                "enum": ["blocker", "critical", "major"]
              }
            }
          }
        },
        "requiredElements": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "element": { "type": "string" },
              "screens": {
                "type": "array",
                "items": { "type": "string" }
              },
              "purpose": { "type": "string" }
            }
          }
        },
        "typography": {
          "type": "object",
          "properties": {
            "minBodySize": {
              "type": "integer",
              "minimum": 20,
              "description": "Minimum body text size in sp"
            },
            "minHeadingSize": {
              "type": "integer",
              "minimum": 28,
              "description": "Minimum heading size in sp"
            },
            "lineHeight": {
              "type": "number",
              "minimum": 1.4,
              "description": "Minimum line height multiplier"
            }
          }
        },
        "touchTargets": {
          "type": "object",
          "properties": {
            "minSize": {
              "type": "integer",
              "minimum": 48,
              "description": "Minimum touch target size in dp"
            },
            "minSpacing": {
              "type": "integer",
              "minimum": 16,
              "description": "Minimum spacing between targets in dp"
            }
          }
        },
        "animations": {
          "type": "object",
          "properties": {
            "allowed": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["fade", "none"]
              }
            },
            "forbidden": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "maxDuration": {
              "type": "integer",
              "maximum": 300,
              "description": "Maximum animation duration in ms"
            }
          }
        }
      }
    },
    "component": {
      "type": "object",
      "required": ["componentId", "name", "type", "constraints"],
      "properties": {
        "componentId": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": [
            "button",
            "text_display",
            "image_display",
            "audio_player",
            "recording_indicator",
            "progress_indicator",
            "page_indicator"
          ]
        },
        "constraints": {
          "type": "object",
          "properties": {
            "minSize": { "type": "integer" },
            "maxSize": { "type": "integer" },
            "allowedStates": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "accessibility": {
          "type": "object",
          "properties": {
            "contentDescription": { "type": "string" },
            "focusable": { "type": "boolean" }
          }
        }
      }
    }
  }
}
