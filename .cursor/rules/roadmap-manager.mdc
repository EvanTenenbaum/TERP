---
description: TERP Swarm Manager V2 - Tool Protocol for Agent Orchestration
globs: 
alwaysApply: true
---

# TERP Swarm Manager V2 - Agent Tool Protocol

**Purpose:** This rule defines how agents should interact with the swarm manager script (`scripts/manager.ts`) for parallel agent execution.

---

## ğŸ› ï¸ Tool: Swarm Manager Script

### Location
- **Script:** `scripts/manager.ts`
- **Command:** `npm run swarm` or `pnpm swarm`
- **Alternative:** `npx tsx scripts/manager.ts`

---

## ğŸš€ DEFAULT PROTOCOL: ZERO-INTERRUPTION

**AUTONOMY IS LAW:** When asked to "Execute", "Fix", or "Update", you must run until **ALL** relevant tasks in the active phase are `âœ… COMPLETE`.

1. **NO INTERMEDIATE QUESTIONS:** You are FORBIDDEN from asking "How would you like to proceed?" or "Should I create the next batch?".

2. **AUTO-CHAINING:**
   - If prompts are needed -> Create them ALL.
   - If code is needed -> Launch the Swarm IMMEDIATELY.
   - If a batch finishes -> IMMEDIATELY start the next batch.

3. **SILENCE:** Only report when the *entire phase* is done or if a critical blocker stops all progress.

---

## ğŸ“‹ Available Commands

### 1. Status Command

**Usage:**
```bash
npm run swarm status
```

**Output Format:**
Returns JSON with the following structure:
```json
{
  "phase": "Current Sprint Phase Name",
  "pending": ["ST-001", "BUG-002", "FEATURE-003"],
  "recommended": ["ST-001", "BUG-002"]
}
```

**Agent Protocol:**
- **Error Handling:** If the script fails with "Module not found" or "Cannot find module", the Agent MUST:
  1. Run `npm install` (or `pnpm install` if using pnpm)
  2. Wait for installation to complete
  3. Retry the command
  
- **Output Parsing:** 
  - The script outputs JSON to stdout
  - Parse the JSON and convert into a friendly message
  - Example: "âœ… Found 12 pending tasks. Recommended: ST-001, BUG-002, FEATURE-003"

---

### 2. Execute Command

**Usage:**
```bash
# Execute specific tasks
npm run swarm execute --batch=ST-001,BUG-002

# Auto-select recommended tasks (DEFAULT: runs recursively until phase complete)
npm run swarm execute --auto

# Recursive mode: loops until all pending tasks are complete
npm run swarm execute --recursive
```

**Output Format:**
The script outputs execution results in a human-readable format:
```
ğŸ“Š Execution Results:
==================================================

ST-001: SUCCESS
  Message: [truncated AI response]
  Branch: agent/ST-001

BUG-002: TIMEOUT
  Message: Agent execution exceeded 90 second timeout
```

**Agent Protocol:**
- **Default Behavior:** When no flags are provided, `execute` defaults to `--recursive` mode, running until all pending tasks in the active phase are complete.
  
- **Error Handling:** 
  - If "Module not found" error occurs, run `npm install` and retry
  - If "GOOGLE_GEMINI_API_KEY not set", inform user to set environment variable
  - If git lock errors occur, the script will auto-retry (up to 3 times)
  
- **Output Parsing:**
  - Parse the execution results
  - Convert to a friendly Slack-style message
  - Example: "âœ… Started 3 agents. Results: 2 successful, 1 timeout"
  
- **Branch Information:**
  - Each successful execution creates a branch: `agent/[task-id]`
  - The branch is automatically pushed to origin
  - Agent should report branch names for user reference
  
- **Recursive Execution:**
  - Fetches pending tasks
  - Executes batch -> Git Push -> Loops and fetches again
  - Exits only when tasks == 0 or phase is complete

---

## ğŸ”§ Self-Bootstrapping Behavior

The script automatically:
1. Checks if `node_modules` exists
2. If missing, installs required dependencies:
   - `commander`
   - `simple-git`
   - `dotenv`
   - `@google/generative-ai`
   - `ora`
   - `chalk`
3. Proceeds with execution after dependencies are available

**Agent Action:** No manual intervention needed. The script handles this automatically.

---

## ğŸ”’ Git Safety Features

The script includes a "Safe Git" wrapper that:
- Retries git operations up to 3 times on lock errors
- Automatically removes stale `index.lock` files
- Handles force push scenarios gracefully

**Agent Action:** No manual intervention needed. The script handles git errors automatically.

---

## âš¡ Timeout Safety

Each AI agent call is wrapped in a 90-second timeout:
- If timeout occurs, the task is marked as "TIMEOUT"
- Other tasks continue execution (Promise.allSettled pattern)
- One failure doesn't crash the entire batch

**Agent Action:** Report timeout results to user, suggest retrying the specific task.

---

## ğŸ“ Example Agent Workflow

```typescript
// 1. Check status
const statusOutput = execSync('npm run swarm status', { encoding: 'utf-8' });
const status = JSON.parse(statusOutput);
console.log(`Found ${status.pending.length} pending tasks`);

// 2. Execute recommended tasks
execSync('npm run swarm execute --auto', { stdio: 'inherit' });

// 3. Parse and report results
// (Results are printed to console in human-readable format)
```

---

## ğŸš¨ Error Recovery Protocol

If the script fails:

1. **Module Not Found:**
   ```bash
   npm install
   # Retry command
   ```

2. **API Key Missing:**
   - Check for `GOOGLE_GEMINI_API_KEY` or `GEMINI_API_KEY` in environment
   - Inform user to set the variable

3. **Git Lock Errors:**
   - Script auto-retries (no action needed)
   - If persistent, manually remove `.git/index.lock` and retry

4. **Roadmap File Not Found:**
   - Verify `docs/roadmaps/MASTER_ROADMAP.md` exists
   - Check current working directory

---

## ğŸ“Š Integration with Roadmap System

The swarm manager integrates with:
- `docs/roadmaps/MASTER_ROADMAP.md` - Reads task definitions
- `docs/ROADMAP_AGENT_GUIDE.md` - Uses for agent instructions
- Git workflow - Creates branches, commits, pushes

**Agent Responsibility:** Ensure roadmap is up-to-date before executing agents.

---

## âœ… Validation

Before using the swarm manager, agents should:
1. Run `pnpm roadmap:validate` to ensure roadmap is valid
2. Check `pnpm roadmap:capacity` to verify safe agent count
3. Use `pnpm roadmap:next-batch` to get recommended tasks

---

## ğŸ”— Related Commands

- `pnpm roadmap:validate` - Validate roadmap structure
- `pnpm roadmap:capacity` - Check safe agent capacity
- `pnpm roadmap:next-batch` - Get next batch of tasks
- `pnpm swarm status` - Get current status
- `pnpm swarm execute --auto` - Execute recommended tasks
