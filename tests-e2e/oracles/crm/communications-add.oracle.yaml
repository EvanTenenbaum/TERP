# CRM.Clients.Communications.Add Oracle
# Generated: 2026-01-16
# Based on: USER_FLOW_MATRIX.csv, FLOW_GUIDE.md, server/routers/clients.ts

flow_id: "CRM.Clients.Communications.Add"
description: "Add a communication log entry to a client (call, email, meeting, or note)"
role: "SalesRep"
seed_profile: "basic_sales"
tags:
  - tier1
  - crm
  - communications
  - mutation
timeout: 30000

preconditions:
  ensure:
    - entity: "user"
      ref: "seed:user.sales_rep"
      where:
        email: "qa.salesrep@terp.test"
        status: "active"
    - entity: "client"
      ref: "seed:client.test_buyer"
      where:
        deleted_at_null: true
        is_buyer: true

steps:
  - action: navigate
    path: "/clients/{{seed:client.test_buyer.id}}"
    wait_for: "main, [role='tab']:has-text('Comms')"

  - action: click
    target: "[role='tab']:has-text('Comms'), [data-testid='communications-tab']"
    wait_for: "[role='tabpanel']:has-text('Communication History'), [data-testid='communications-list']"

  - action: click
    target: "button:has-text('Log Communication'), button:has-text('Log First Communication'), [data-testid='add-communication-btn']"
    wait_for: "[role='dialog']:has-text('Log Communication'), [data-testid='communication-form']"

  - action: click
    target: "[role='dialog']:has-text('Log Communication') [role='combobox']"
    wait_for: "[role='option']"

  - action: click
    target: "[role='option']"

  - action: type
    target: "[role='dialog']:has-text('Log Communication') #subject, [role='dialog']:has-text('Log Communication') input#subject"
    value: "Oracle communication smoke"
    clear_first: true

  - action: type
    target: "[role='dialog']:has-text('Log Communication') #notes, [role='dialog']:has-text('Log Communication') textarea#notes"
    value: "Discussed delivery schedule and payment terms. Client confirmed order details."
    clear_first: true

  - action: click
    target: "[role='dialog']:has-text('Log Communication') button:has-text('Save Communication'), [data-testid='save-communication-btn']"
    wait_for: "[role='tabpanel']:has-text('Communication History'), [data-testid='communications-list']"

  - action: wait
    duration: 1200

  - action: screenshot
    name: "communication_added"

expected_ui:
  visible:
    - "[role='tabpanel']:has-text('Communication History'), [data-testid='communications-list']"

expected_db:
  client_communications:
    - where:
        client_id: "$seed:client.test_buyer.id"
      expect:
        id_not_null: true
      count_gte: 1
