# CRM.Clients.Transactions.RecordPayment Oracle
# Generated: 2026-01-16
# Based on: USER_FLOW_MATRIX.csv, FLOW_GUIDE.md, server/routers/clients.ts

flow_id: "CRM.Clients.Transactions.RecordPayment"
description: "Record a payment against an existing transaction, updating payment status and client financials"
role: "SalesRep"
seed_profile: "basic_sales"
tags:
  - tier1
  - crm
  - transactions
  - payments
  - mutation
  - financial
timeout: 45000

preconditions:
  ensure:
    - entity: "user"
      ref: "seed:user.sales_rep"
      where:
        email: "qa.salesrep@terp.test"
        status: "active"
    - entity: "client"
      ref: "seed:client.test_buyer"
      where:
        deleted_at_null: true
        is_buyer: true
  create:
    - entity: "client_transaction"
      ref: "temp:unpaid_invoice"
      data:
        client_id_ref: "seed:client.test_buyer.id"
        transaction_type: "INVOICE"
        amount: "2000.00"
        payment_status: "PENDING"
        transaction_date: "{{date:YYYY-MM-DD}}"

steps:
  - action: navigate
    path: "/clients"
    wait_for: "[data-testid='clients-table'], table"

  - action: type
    target: "[data-testid='clients-search-input']"
    value_ref: "$seed:client.test_buyer.teri_code"
    clear_first: true

  - action: wait
    for: "table tbody tr, [data-testid^='client-row-']"
    timeout: 5000

  - action: click
    target: "table tbody tr:first-of-type"
    wait_for: "[data-testid='view-full-profile-btn']"

  - action: click
    target: "[data-testid='view-full-profile-btn']"
    wait_for_navigation: true

  - action: store
    from: "[data-testid='client-id']"
    as: "client_id"

  - action: store
    from: "[data-testid='total-owed']"
    as: "original_total_owed"

  - action: click
    target: "[data-testid='transactions-tab']"
    wait_for: "[data-testid='transactions-list']"

  - action: wait
    for: "tr[data-status='PENDING'] [data-testid='record-payment-btn'], [data-testid='record-payment-btn']:has-text('Record Payment')"
    timeout: 10000

  # Find the pending transaction
  - action: click
    target: "tr[data-status='PENDING'] [data-testid='record-payment-btn'], tr[data-status='PARTIAL'] [data-testid='record-payment-btn'], [data-testid='record-payment-btn']:has-text('Record Payment')"
    wait_for: "[data-testid='payment-form']"

  - action: type
    target: "input[name='paymentAmount']"
    value: "2000.00"
    clear_first: true

  - action: type
    target: "input[name='paymentDate']"
    value: "{{date:YYYY-MM-DD}}"
    clear_first: true

  - action: click
    target: "[data-testid='submit-payment-btn']"
    wait_after: 1200

  - action: wait
    for: "[data-testid='transactions-list']"
    timeout: 10000

  - action: screenshot
    name: "payment_recorded"

expected_ui:
  visible:
    - "[data-testid='transactions-list']"
  not_visible:
    - "[role='dialog'] [data-testid='payment-form']"
    - "[role='dialog']:has-text('Record Payment')"
  text_present:
    - "PAID"

expected_db:
  client_transactions:
    - where:
        id: "$stored.transaction_id"
      expect:
        payment_status: "PAID"
        payment_amount: "2000.00"
        payment_date_not_null: true
      store_as: "paid_transaction"

  clients:
    - where:
        id: "$stored.client_id"
      expect:
        total_owed_not_null: true
      store_as: "updated_client"

  client_activity:
    - where:
        client_id: "$stored.client_id"
        activity_type: "PAYMENT_RECORDED"
      expect:
        user_id_not_null: true
        metadata_contains: "paymentAmount"
      count_gte: 1

  invariants:
    - name: "Full payment sets PAID status"
      query: |
        SELECT payment_status FROM client_transactions
        WHERE id = $stored.transaction_id
      assert: "payment_status = 'PAID'"

    - name: "Payment amount matches transaction amount"
      query: |
        SELECT CAST(payment_amount AS DECIMAL(10,2)) as paid,
               CAST(amount AS DECIMAL(10,2)) as total
        FROM client_transactions WHERE id = $stored.transaction_id
      assert: "paid = total"
