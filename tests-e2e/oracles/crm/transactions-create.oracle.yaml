# CRM.Clients.Transactions.Create Oracle
# Generated: 2026-01-16
# Based on: USER_FLOW_MATRIX.csv, FLOW_GUIDE.md, server/routers/clients.ts

flow_id: "CRM.Clients.Transactions.Create"
description: "Create a client transaction (invoice, payment, order, etc.) and verify client stats are updated"
role: "SalesManager"
seed_profile: "basic_sales"
tags:
  - tier1
  - crm
  - transactions
  - mutation
  - financial
timeout: 45000

preconditions:
  ensure:
    - entity: "user"
      ref: "seed:user.sales_manager"
      where:
        email: "qa.salesmanager@terp.test"
        status: "active"
    - entity: "client"
      ref: "seed:client.test_buyer"
      where:
        deleted_at_null: true
        is_buyer: true

steps:
  - action: navigate
    path: "/clients"
    wait_for: "[data-testid='clients-table'], table, main"

  - action: type
    target: "[data-testid='clients-search-input'], input[placeholder*='Search clients' i], input[placeholder*='Search' i]"
    value_ref: "$seed:client.test_buyer.teri_code"
    clear_first: true

  - action: wait
    for: "table tbody tr, [data-testid^='client-row-']"
    timeout: 5000

  - action: click
    target: "table tbody tr:first-of-type"
    wait_for: "[data-testid='view-full-profile-btn'], [role='complementary']:has-text('Quick Actions')"

  - action: click
    target: "[data-testid='view-full-profile-btn'], button:has-text('View Full Profile')"
    wait_for_navigation: true

  - action: click
    target: "[role='tab']:has-text('Transactions'), [data-testid='transactions-tab']"
    wait_for: "[role='tabpanel']:has-text('Transaction History'), [data-testid='transactions-list']"

  - action: click
    target: "button:has-text('Add Transaction'), [data-testid='add-transaction-btn']"
    wait_for: "[role='dialog']:has-text('Add Transaction'), [data-testid='transaction-form']"

  - action: click
    target: "[role='dialog'] [role='combobox']:has-text('Select type'), [role='dialog'] button[role='combobox']:has-text('Select type')"
    wait_after: 200

  - action: click
    target: "[role='option']:has-text('Invoice'), [data-radix-collection-item]:has-text('Invoice')"
    wait_after: 200

  - action: type
    target: "[role='dialog'] input[name='amount'], input[name='amount']"
    value: "1500.00"
    clear_first: true

  - action: type
    target: "[role='dialog'] textarea[name='notes'], textarea[name='notes']"
    value: "Oracle transaction smoke"
    clear_first: true

  - action: click
    target: "[data-testid='save-transaction-btn'], [role='dialog']:has-text('Add Transaction') button:has-text('Add Transaction')"
    wait_after: 1200

  - action: wait
    for: "[role='tabpanel']:has-text('Transaction History'), [data-testid='transactions-list']"
    timeout: 10000

  - action: wait
    duration: 500

  - action: screenshot
    name: "transaction_created"

expected_ui:
  visible:
    - "[role='tabpanel']:has-text('Transaction History'), [data-testid='transactions-list']"
  not_visible:
    - "[role='dialog']:has-text('Add Transaction')"

expected_db:
  client_transactions:
    - where:
        client_id: "$seed:client.test_buyer.id"
        amount: "1500.00"
      expect:
        id_not_null: true
      count_gte: 1
