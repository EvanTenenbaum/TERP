# CRM.Clients.Update Oracle
# Generated: 2026-01-16
# Based on: USER_FLOW_MATRIX.csv, FLOW_GUIDE.md, server/routers/clients.ts

flow_id: "CRM.Clients.Update"
description: "Update an existing client with optimistic locking support, verifying field changes and activity logging"
role: "SalesManager"
seed_profile: "basic_sales"
tags:
  - tier1
  - crm
  - clients
  - mutation
timeout: 30000

preconditions:
  ensure:
    - entity: "user"
      ref: "seed:user.sales_manager"
      where:
        email: "qa.salesmanager@terp.test"
        status: "active"
    - entity: "client"
      ref: "seed:client.test_buyer"
      where:
        deleted_at_null: true
        is_buyer: true

steps:
  - action: navigate
    path: "/clients"
    wait_for: "table, [data-testid='clients-list'], main"

  - action: type
    target: "[data-testid='search-input'], input[placeholder*='Search clients' i], input[placeholder*='Search' i]"
    value_ref: "seed:client.test_buyer.teri_code"
    clear_first: true

  - action: wait
    for: "table tbody tr, [data-testid='client-row']"
    timeout: 5000

  - action: click
    target: "table tbody tr:first-child button, [data-testid='client-row']:first-child button"
    wait_for: "button:has-text('View Full Profile'), [role='complementary']:has-text('Quick Actions')"

  - action: click
    target: "button:has-text('View Full Profile')"
    wait_for_navigation: true

  - action: wait
    for: "button:has-text('Edit Client'), [role='tablist']"
    timeout: 5000

  - action: click
    target: "button:has-text('Edit Client'), [data-testid='edit-client-btn']"
    wait_for: "[role='dialog']:has-text('Edit Client')"

  - action: type
    target: "[role='dialog']:has-text('Edit Client') input[name='phone'], [role='dialog']:has-text('Edit Client') input[placeholder*='phone' i]"
    value: "555-000-1234"
    clear_first: true

  - action: click
    target: "[role='dialog']:has-text('Edit Client') button:has-text('Save Changes'), [data-testid='save-client-btn']"
    wait_after: 700

  - action: wait
    for: "button:has-text('Edit Client'), [role='tab']:has-text('Overview')"
    timeout: 5000

  - action: screenshot
    name: "client_updated"

expected_ui:
  url_contains: "/clients/"
  visible:
    - "button:has-text('Edit Client'), [role='tab']:has-text('Overview')"
  not_visible:
    - "[role='dialog']:has-text('Edit Client')"
  text_present:
    - "555-000-1234"

expected_db:
  clients:
    - where:
        id: "$seed:client.test_buyer.id"
      expect:
        phone: "555-000-1234"
        deleted_at_null: true
        updated_at_not_null: true
      store_as: "updated_client"

  client_activity:
    - where:
        client_id: "$updated_client.id"
        activity_type: "UPDATED"
      expect:
        user_id_not_null: true
      count_gte: 1

  invariants:
    - name: "Update did not delete client"
      query: |
        SELECT COUNT(*) as count FROM clients
        WHERE id = $updated_client.id
          AND deleted_at IS NULL
      assert: "count = 1"
