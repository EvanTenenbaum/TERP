# Oracle: CRM.Clients.CreateClient
# Create a new client and verify success

flow_id: "CRM.Clients.CreateClient"
description: "Create a new client via the UI form"
role: "SalesManager"
tags:
  - tier1
  - clients
  - crud
  - mutation
timeout: 45000

preconditions:
  ensure: []

steps:
  - action: navigate
    path: "/clients"
    wait_for: "table, [data-testid='clients-list'], main"

  - action: click
    target: "[data-testid='create-client-btn'], button:has-text('Add Client'), button:has-text('Create Client')"
    wait_for: "[data-testid='client-form'], [role='dialog']:has-text('Add New Client')"

  - action: type
    target: "#teriCode, input[placeholder*='TERI code' i]"
    value: "TEST{{random:6}}"
    clear_first: true

  - action: type
    target: "#companyName, input[placeholder*='company name' i]"
    value: "QA Company {{random:4}}"
    clear_first: true

  - action: type
    target: "#name, input[placeholder*='contact' i]"
    value: "QA Contact {{random:4}}"
    clear_first: true

  - action: type
    target: "#email, input[type='email']"
    value: "qa.client.{{random:5}}@example.com"
    clear_first: true

  - action: type
    target: "#phone, input[type='tel']"
    value: "555123{{random:4}}"
    clear_first: true

  - action: click
    target: "button:has-text('Next')"
    wait_after: 400

  - action: click
    target: "label:has-text('Buyer'), div:has-text('Buyer Client purchases products or services'), button:has-text('Buyer'), text=\"Buyer\""
    wait_after: 200

  - action: click
    target: "button:has-text('Next')"
    wait_after: 400

  - action: click
    target: "button:has-text('Create Client'), button:has-text('Save Client')"
    wait_for_navigation: true

  - action: wait
    network_idle: true
    timeout: 10000

  - action: screenshot
    name: "client_created"

expected_ui:
  visible:
    - "button:has-text('Edit Client'), [role='tab']:has-text('Overview'), [role='main']"
  text_present:
    - "Client Information"

expected_db:
  clients:
    - where:
        is_buyer: true
        deleted_at_null: true
      expect:
        deleted_at_null: true
        is_buyer: true
      store_as: "created_client"
      count_gte: 1

  invariants:
    - name: "Created client has unique TERI code"
      query: |
        SELECT COUNT(*) as cnt FROM clients
        WHERE teri_code = $created_client.teri_code
          AND deleted_at IS NULL
      assert: "cnt = 1"
