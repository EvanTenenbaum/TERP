# Oracle: Accounting.Invoices.GenerateFromOrder
# Generate an invoice from a completed SALE order

flow_id: "Accounting.Invoices.GenerateFromOrder"
description: "Generate an invoice from a SALE order and verify invoice creation"
role: "SalesManager"
seed_profile: "basic_sales"
tags:
  - tier1
  - accounting
  - invoices
  - mutation
timeout: 45000

preconditions:
  ensure:
    - entity: "client"
      ref: "seed:client.redwood"
      where:
        status: "active"
    - entity: "batch"
      ref: "seed:batch.og_kush"
      where:
        status: "LIVE"
        available_quantity_gte: 20
  create:
    - entity: "order"
      ref: "temp:invoice_source_order"
      data:
        order_type: "SALE"
        is_draft: false
        client_id: "$seed:client.redwood.id"
        order_number: "S-INVOICE-{{timestamp}}"
        sale_status: "PENDING"
        fulfillment_status: "PENDING"
        total: "1000.00"
        items: '[{"batchId": "$seed:batch.og_kush.id", "quantity": 1, "unitPrice": 1000, "isSample": false}]'

steps:
  - action: navigate
    path: "/orders"
    wait_for: "[data-testid='orders-table'], table, main"

  - action: wait
    network_idle: true
    timeout: 10000

  - action: type
    target: "[data-testid='orders-search-input']"
    value: "{{temp:invoice_source_order.orderNumber}}"
    clear_first: true

  - action: wait
    for: "table tbody tr:has-text('{{temp:invoice_source_order.orderNumber}}'), table tbody tr"
    timeout: 10000

  - action: click
    target: "table tbody tr:has-text('{{temp:invoice_source_order.orderNumber}}'), table tbody tr:first-of-type"

  - action: wait
    for: "[data-testid='generate-invoice-btn'], button:has-text('Generate Invoice')"
    timeout: 10000

  - action: click
    target: "[data-testid='generate-invoice-btn'], button:has-text('Generate Invoice')"
    wait_after: 2000

  - action: wait
    for: "[data-sonner-toast], [role='status'], text=Invoice"
    timeout: 10000

  - action: screenshot
    name: "invoice_generated_from_order"

expected_ui:
  visible:
    - "[data-sonner-toast], [role='status'], .toast"
  text_present:
    - "Invoice"

expected_db:
  invoices:
    - where:
        referenceType: "ORDER"
        referenceId: "{{temp:invoice_source_order.id}}"
      expect:
        status: "DRAFT"
        customerId: "{{temp:invoice_source_order.clientId}}"
        referenceType: "ORDER"
        deletedAt_null: true
      store_as: "created_invoice"

  orders:
    - where:
        id: "{{temp:invoice_source_order.id}}"
      expect:
        invoiceId_not_null: true

  invariants:
    - name: "Invoice total matches order total"
      query: |
        SELECT
          i.totalAmount as invoice_total,
          o.total as order_total
        FROM invoices i
        JOIN orders o ON i.referenceId = o.id
        WHERE i.id = $created_invoice.id
      assert: "invoice_total = order_total"
