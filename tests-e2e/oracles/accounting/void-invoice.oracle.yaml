# Oracle: Accounting.Invoices.Void
# Void an invoice with required reason (terminal state)

flow_id: "Accounting.Invoices.Void"
description: "Void an invoice with a mandatory reason and verify terminal state"
role: "AccountingManager"
seed_profile: "basic_sales"
tags:
  - tier1
  - accounting
  - invoices
  - state-transition
  - terminal
  - mutation
timeout: 45000

preconditions:
  ensure:
    - entity: "invoice"
      ref: "seed:invoice.to_void"
      where:
        status_in: ["DRAFT", "VIEWED", "SENT", "PARTIAL", "OVERDUE"]
        deletedAt_null: true

steps:
  - action: navigate
    path: "/accounting/invoices"
    wait_for: "[data-testid='invoices-table'], table, main"

  - action: wait
    network_idle: true
    timeout: 10000

  - action: click
    target: "table tbody tr:has-text('{{seed:invoice.to_void.invoiceNumber}}'), table tbody tr:has-text('{{seed:invoice.to_void.invoice_number}}'), table tbody tr:has-text('DRAFT'), table tbody tr:has-text('VIEWED'), table tbody tr:has-text('SENT'), table tbody tr:has-text('PARTIAL'), table tbody tr:has-text('OVERDUE')"
    wait_after: 500

  - action: wait
    for: "[data-testid='invoice-detail'], .invoice-detail, [role='complementary'], aside[role='complementary']"
    timeout: 10000

  - action: click
    target: "[data-testid='void-invoice-btn'], button:contains('Void Invoice'), button:contains('Void')"
    wait_after: 500

  - action: wait
    for: "[data-testid='void-modal'], .modal, [role='dialog']"
    timeout: 5000

  - action: click
    target: "[data-testid='confirm-void-btn'], [role='dialog'] button:contains('Void Invoice'), [role='dialog'] button:contains('Confirm'), button[type='submit']"
    wait_after: 2000

  - action: wait
    for: "[data-testid='void-success'], .success-toast"
    timeout: 10000

  - action: screenshot
    name: "invoice_voided"

expected_ui:
  visible:
    - "[data-testid='invoice-detail'], main"
  text_present:
    - "VOID"

expected_db:
  invoices:
    - where:
        id: "$seed:invoice.to_void.id"
      expect:
        status: "VOID"
        notes_contains: "VOIDED"
        deleted_at_null: true
      store_as: "voided_invoice"

  invariants:
    - name: "Voided invoice is in terminal state"
      query: |
        SELECT status FROM invoices
        WHERE id = $voided_invoice.id
      assert: "status = 'VOID'"

    - name: "Voided invoice not hard deleted"
      query: |
        SELECT COUNT(*) as count FROM invoices
        WHERE id = $voided_invoice.id
      assert: "count = 1"

    - name: "Void is irreversible: no non-void transitions possible"
      query: |
        SELECT COUNT(*) as count FROM invoices
        WHERE id = $voided_invoice.id
          AND status != 'VOID'
      assert: "count = 0"
