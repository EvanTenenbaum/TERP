# Oracle: Accounting.COGS.UpdateBatchCogs
# Update COGS for a batch with audit trail and optional order propagation

flow_id: "Accounting.COGS.UpdateBatchCogs"
description: "Update batch COGS value with audit trail and verify propagation to pending orders"
role: "AccountingManager"
seed_profile: "inventory_costing"
tags:
  - tier1
  - accounting
  - cogs
  - inventory
  - audit
  - mutation
timeout: 45000

preconditions:
  ensure:
    - entity: "batch"
      ref: "seed:batch.for_cogs_update"
      where:
        status: "LIVE"
        deletedAt_null: true
    - entity: "order"
      ref: "seed:order.pending_with_batch"
      where:
        saleStatus: "PENDING"
        # Order contains line item referencing the batch

steps:
  - action: navigate
    path: "/inventory"
    wait_for: "[data-testid='inventory-table'], table, main"

  - action: wait
    network_idle: true
    timeout: 10000

  - action: click
    target: "[data-testid='batch-row-{{seed:batch.for_cogs_update.id}}'], tr[data-batch-id='{{seed:batch.for_cogs_update.id}}']"
    wait_for_navigation: true

  - action: wait
    for: "[data-testid='batch-detail'], .batch-detail"
    timeout: 10000

  - action: store
    from: "[data-testid='current-cogs'], .cogs-value"
    as: "original_cogs"

  - action: click
    target: "[data-testid='edit-cogs-btn'], button:contains('Edit COGS'), [data-testid='cogs-settings']"
    wait_after: 500

  - action: wait
    for: "[data-testid='cogs-modal'], .modal, [role='dialog']"
    timeout: 5000

  - action: type
    target: "[data-testid='new-cogs-input'], input[name='newCogs'], input[name='unitCogs']"
    value: "125.50"
    clear_first: true

  - action: select
    target: "[data-testid='apply-to-select'], select[name='applyTo']"
    value: "FUTURE_SALES"

  - action: type
    target: "[data-testid='cogs-reason'], textarea[name='reason'], input[name='reason']"
    value: "Supplier cost increase effective January 2026 - PO #2026-001 reference"
    clear_first: true

  - action: click
    target: "[data-testid='confirm-cogs-btn'], button:contains('Update'), button[type='submit']"
    wait_after: 2000

  - action: wait
    for: "[data-testid='cogs-success'], .success-toast"
    timeout: 10000

  - action: screenshot
    name: "batch_cogs_updated"

expected_ui:
  visible:
    - "[data-testid='batch-detail'], main"
  text_present:
    - "125.50"
  fields:
    "[data-testid='current-cogs'], .cogs-value": "125.50"

expected_db:
  batches:
    - where:
        id: "$seed:batch.for_cogs_update.id"
      expect:
        unitCogs: "125.50"

  audit_logs:
    - where:
        entity: "batch"
        entityId: "$seed:batch.for_cogs_update.id"
        action: "COGS_UPDATE"
      expect:
        reason_like: "%Supplier cost increase%"
        after_like: "%125.50%"
      count_gte: 1

  # If FUTURE_SALES or BOTH, pending orders should be updated
  orders:
    - where:
        id: "$seed:order.pending_with_batch.id"
      expect:
        # Items JSON should contain updated unitCogs for the batch
        items_like: "%125.50%"

  invariants:
    - name: "Audit trail captures before and after"
      query: |
        SELECT
          JSON_EXTRACT(before_data, '$.unitCogs') as old_cogs,
          JSON_EXTRACT(after_data, '$.unitCogs') as new_cogs
        FROM audit_logs
        WHERE entity = 'batch'
        AND entity_id = $seed:batch.for_cogs_update.id
        AND action = 'COGS_UPDATE'
        ORDER BY created_at DESC
        LIMIT 1
      assert: "new_cogs = '125.50'"

    - name: "Order margins recalculated"
      query: |
        SELECT
          o.total_margin,
          o.avg_margin_percent
        FROM orders o
        WHERE o.id = $seed:order.pending_with_batch.id
      assert: "total_margin IS NOT NULL"
