# Oracle: Orders.DraftOrders.FinalizeDraft
# Finalize a draft order (lock it as non-draft)

flow_id: "Orders.DraftOrders.FinalizeDraft"
description: "Finalize a draft order, locking it for editing and setting confirmedAt"
role: "SalesRep"
seed_profile: "basic_sales"
tags:
  - tier1
  - orders
  - draft
  - state-transition
  - mutation
timeout: 60000

preconditions:
  ensure:
    - entity: "client"
      ref: "seed:client.redwood"
      where:
        status: "active"
    - entity: "batch"
      ref: "seed:batch.og_kush"
      where:
        status: "LIVE"
        available_quantity_gte: 10
  create:
    - entity: "order"
      ref: "temp:draft_to_finalize"
      data:
        order_type: "SALE"
        is_draft: true
        client_id: "$seed:client.redwood.id"
        order_number: "D-FINALIZE-{{timestamp}}"
        total: "3000.00"
        version: 1

steps:
  - action: navigate
    path: "/orders"
    wait_for: "[data-testid='orders-table'], table"

  - action: wait
    network_idle: true
    timeout: 10000

  # Switch to Drafts tab and search for created draft
  - action: click
    target: "button[role='tab']:has-text('Drafts'), [role='tab']:has-text('Drafts')"
    wait_after: 1000

  - action: type
    target: "[data-testid='orders-search-input']"
    value: "{{temp:draft_to_finalize.orderNumber}}"
    clear_first: true

  - action: wait
    for: "table tbody tr"
    timeout: 10000

  # Click on the draft order
  - action: click
    target: "table tbody tr:first-of-type"
    wait_after: 500

  - action: wait
    for: "[data-testid='confirm-order-btn'], button:has-text('Confirm Order')"
    timeout: 10000

  # Confirm draft (finalization path for this UI)
  - action: click
    target: "[data-testid='confirm-order-btn'], button:has-text('Confirm Order')"
    wait_after: 500

  # Confirm in dialog
  - action: wait
    for: "[role='dialog']"
    timeout: 5000

  - action: click
    target: "[role='dialog'] button:has-text('Confirm Order'), [role='dialog'] button:has-text('Confirm')"
    wait_after: 2000

  - action: wait
    network_idle: true
    timeout: 15000

  - action: screenshot
    name: "draft_order_finalized"

expected_ui:
  visible:
    - "[data-testid='orders-table'], table"

expected_db:
  orders:
    - where:
        order_number: "$stored.finalizing_order_number"
      expect:
        is_draft: false
        confirmed_at_not_null: true
      store_as: "finalized_order"

  batches:
    - where:
        id: "$seed:batch.og_kush.id"
      expect:
        # Finalize does NOT decrement inventory (only confirm does)
        on_hand_qty_gte: 90

  invariants:
    - name: "Version incremented after finalize"
      query: |
        SELECT version
        FROM orders
        WHERE id = $finalized_order.id
      assert: "version >= $stored.initial_version"

    - name: "Order marked as non-draft"
      query: |
        SELECT is_draft, confirmed_at
        FROM orders
        WHERE id = $finalized_order.id
      assert: "is_draft = 0 AND confirmed_at IS NOT NULL"
