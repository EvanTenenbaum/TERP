# Oracle: Orders.Orders.Create
# Create a new order (basic version)

flow_id: "Orders.Orders.Create"
description: "Create a new order with line items using the basic create mutation"
role: "SalesRep"
seed_profile: "basic_sales"
tags:
  - tier1
  - orders
  - crud
  - mutation
timeout: 45000

preconditions:
  ensure:
    - entity: "client"
      ref: "seed:client.redwood"
      where:
        status: "active"
        is_buyer: true
    - entity: "batch"
      ref: "seed:batch.og_kush"
      where:
        status: "LIVE"
        available_quantity_gte: 10

steps:
  - action: navigate
    path: "/orders/create"
    wait_for: "text=Create Sales Order, main"

  - action: wait
    network_idle: true
    timeout: 10000

  - action: select
    target: "[aria-label='Select a client'], [role='combobox'][aria-label*='client' i]"
    value_ref: "$seed:client.redwood.name"

  - action: wait
    for: "text=Inventory"
    timeout: 10000

  - action: select
    target: "button[role='combobox']:has-text('Sale Order')"
    value: "Quote"

  - action: click
    target: "table tbody tr:not(:has-text('Not yet available for sale')) button:has-text('Add'), button[title^='Add'], table tbody tr:first-of-type button"
    wait_after: 800

  - action: click
    target: "button:has-text('Confirm Order'), button:has-text('Confirm Quote')"
    wait_after: 500

  - action: wait
    for: "[role='dialog'], [role='alertdialog'], text=Finalize"
    timeout: 5000

  - action: click
    target: "[role='dialog'] button:has-text('Finalize'), [role='alertdialog'] button:has-text('Finalize'), [role='alertdialog'] button:has-text('Confirm')"
    wait_after: 1200

  - action: wait
    network_idle: true
    timeout: 15000

  - action: screenshot
    name: "order_created"

expected_ui:
  url_equals: "/sales?tab=create-order"
  visible:
    - "text=Create Sales Order"

expected_db:
  orders:
    - where:
        order_number: "$stored.created_order_number"
      expect:
        order_type: "SALE"
        client_id: "$seed:client.redwood.id"
        is_draft: false
        sale_status: "PENDING"
        fulfillment_status: "PENDING"
        payment_terms: "NET_30"
      store_as: "created_order"

  batches:
    - where:
        id: "$seed:batch.og_kush.id"
      expect:
        on_hand_qty_lte: 95

  invariants:
    - name: "Order total matches line items"
      query: |
        SELECT
          o.total,
          (SELECT SUM(line_total) FROM order_line_items WHERE order_id = o.id) as line_sum
        FROM orders o
        WHERE o.id = $created_order.id
      assert: "total = line_sum OR line_sum IS NULL"
